<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Empresas - BSL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #F3F3F3;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F3F3F3;
            --bg-input: #FFFFFF;
            --text-primary: #181818;
            --text-secondary: #444444;
            --text-tertiary: #706E6B;
            --border-color: #DDDBDA;
            --border-light: #E5E5E5;
            --accent-color: #0176D3;
            --accent-hover: #014486;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 2px 4px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --bg-tertiary: #374151;
            --bg-input: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --text-tertiary: #9CA3AF;
            --border-color: #374151;
            --border-light: #4B5563;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Figtree', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ========== LOGIN SCREEN ========== */
        .login-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 24px;
            background: var(--bg-secondary);
        }

        /* Banner de bienvenida */
        .welcome-banner {
            background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
            border-radius: 16px;
            padding: 24px 32px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(129, 199, 132, 0.2);
            border-radius: 50%;
        }

        .welcome-banner-content {
            position: relative;
            z-index: 1;
        }

        .welcome-banner-content h3 {
            font-size: 17px;
            font-weight: 400;
            color: #555;
            margin-bottom: 8px;
        }

        .welcome-banner-content h3 strong {
            font-weight: 700;
            color: #2E7D32;
        }

        .welcome-banner-content p {
            font-size: 13px;
            color: #555;
            line-height: 1.6;
            font-weight: 400;
        }

        @media (max-width: 460px) {
            .welcome-banner {
                padding: 20px;
            }
        }

        .login-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 48px 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo img {
            max-height: 60px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 16px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 184, 230, 0.1);
        }

        .login-input::placeholder {
            text-transform: none;
            color: var(--text-tertiary);
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            background: var(--accent-hover);
        }

        .login-btn:disabled {
            background: #94A3B8;
            cursor: not-allowed;
        }

        .login-error {
            background: #FEF2F2;
            color: #DC2626;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Form styles for login */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(1, 118, 211, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        .password-wrapper {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            padding: 4px;
        }

        .password-toggle:hover {
            color: var(--text-primary);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.error {
            background: #FEF2F2;
            color: #DC2626;
        }

        .alert.success {
            background: #ECFDF5;
            color: #059669;
        }

        .alert.warning {
            background: #FEF3C7;
            color: #D97706;
        }

        .login-footer {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .login-footer a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        .whatsapp-support-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #25D366;
            color: white !important;
            border-radius: 8px;
            font-weight: 500;
            font-size: 15px;
            text-decoration: none !important;
            transition: background 0.2s;
        }

        .whatsapp-support-link:hover {
            background: #1DA851;
            text-decoration: none !important;
        }

        .whatsapp-support-link svg {
            fill: white;
        }

        /* ========== PANEL SCREEN ========== */
        .panel-screen {
            display: none;
            min-height: 100vh;
        }

        .panel-screen.active {
            display: block;
        }

        /* ========== LAYOUT ========== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .sidebar-logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
            text-align: center;
        }

        .sidebar-logo img {
            max-width: 140px;
            height: auto;
        }

        .sidebar-nav {
            padding: 0 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 184, 230, 0.1);
            color: var(--accent-color);
        }

        [data-theme="dark"] .nav-item.active {
            background: rgba(0, 184, 230, 0.2);
            color: #60D9F7;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .empresa-name-topbar {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            padding: 6px 12px;
            background: rgba(0, 184, 230, 0.1);
            border-radius: 6px;
        }

        [data-theme="dark"] .empresa-name-topbar {
            background: rgba(0, 184, 230, 0.15);
        }

        /* Top Bar Fijo */
        .top-bar {
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            height: 64px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            z-index: 100;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .top-bar-search {
            position: relative;
            flex: 1;
            max-width: 600px;
        }

        .top-bar-search input {
            width: 100%;
            padding: 10px 16px 10px 42px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .top-bar-search input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 184, 230, 0.1);
            background: var(--bg-secondary);
        }

        .top-bar-search input::placeholder {
            color: var(--text-tertiary);
        }

        .top-bar-search svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            width: 18px;
            height: 18px;
            pointer-events: none;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }

        .theme-toggle span {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .btn-icon-top {
            background: var(--bg-tertiary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-icon-top:hover {
            background: var(--border-color);
        }

        .btn-icon-top svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
        }

        .btn-logout {
            background: #FEF2F2;
        }

        .btn-logout:hover {
            background: #FEE2E2;
        }

        .btn-logout svg {
            stroke: #DC2626;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 32px 40px;
            padding-top: 96px;
        }

        /* ========== HEADER ========== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .page-header-left h1 svg {
            width: 24px;
            height: 24px;
            stroke: var(--accent-color);
            color: var(--accent-color);
        }

        .page-header-left p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 34px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.1s ease;
            border: 1px solid transparent;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            line-height: 1.5;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #F3F3F3;
        }

        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ========== TABS & FILTERS ========== */
        .filters-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .stats-badge {
            padding: 10px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .stats-badge strong {
            color: var(--text-primary);
        }

        /* ========== TABLE ========== */
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s ease;
            cursor: pointer;
        }

        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tbody tr:active {
            background: var(--border-color);
        }

        .data-table td {
            padding: 16px;
            font-size: 14px;
            color: var(--text-primary);
            vertical-align: middle;
        }

        .cell-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar.has-photo {
            background: var(--bg-tertiary);
        }

        .name-info {
            display: flex;
            flex-direction: column;
        }

        .name-primary {
            font-weight: 600;
            color: var(--text-primary);
        }

        .name-secondary {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.atendido {
            background: #DCFCE7;
            color: #166534;
        }

        .status-badge.pendiente {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-badge.proceso {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Loading */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .pagination-btn {
            padding: 10px 16px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--border-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            padding: 0 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ========== SCL-90 RESULTADOS ========== */
        .scl90-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .scl90-table th {
            background: #1E40AF;
            color: white;
            padding: 10px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }
        .scl90-table th:first-child {
            text-align: left;
        }
        .scl90-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #E5E7EB;
            text-align: center;
        }
        .scl90-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        .scl90-table tr:nth-child(even) {
            background: #F9FAFB;
        }
        .scl90-cat-bajo {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            background: #D1FAE5;
            color: #065F46;
            font-weight: 600;
            font-size: 12px;
        }
        .scl90-cat-medio {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            background: #FEF3C7;
            color: #92400E;
            font-weight: 600;
            font-size: 12px;
        }
        .scl90-cat-alto {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            background: #FEE2E2;
            color: #991B1B;
            font-weight: 600;
            font-size: 12px;
        }
        [data-theme="dark"] .scl90-table th {
            background: #1E3A8A;
        }
        [data-theme="dark"] .scl90-table td {
            border-bottom-color: #374151;
        }
        [data-theme="dark"] .scl90-table tr:nth-child(even) {
            background: #1F2937;
        }

        /* ========== MODAL DRAWER ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            justify-content: flex-end;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #F5F5F5;
            width: 100%;
            max-width: 480px;
            height: 100vh;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal.large,
        .modal.modal-large {
            max-width: 640px;
        }

        [data-theme="dark"] .modal {
            background: #1F2937;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: #F5F5F5;
            border-bottom: none;
            flex-shrink: 0;
        }

        [data-theme="dark"] .modal-header {
            background: #1F2937;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .btn-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-primary);
            transition: all 0.15s ease;
        }

        .btn-close:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .btn-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 0 24px 24px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin: 0 24px 24px;
            flex-shrink: 0;
        }

        .modal-footer .btn {
            padding: 10px 14px;
            font-size: 13px;
        }

        /* ========== DETAIL MODAL - Profile Style ========== */
        .profile-header-horizontal {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .profile-photo {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 600;
            flex-shrink: 0;
            overflow: hidden;
        }

        .profile-photo.has-photo {
            background: var(--bg-tertiary);
        }

        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .profile-meta {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .profile-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .profile-status.atendido {
            background: #ECFDF5;
            color: #059669;
        }

        .profile-status.pendiente {
            background: #FEF3C7;
            color: #D97706;
        }

        .detail-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .detail-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-field {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-field:last-child {
            border-bottom: none;
        }

        .detail-field-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            font-weight: 400;
        }

        .detail-field-value {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
            line-height: 1.5;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
        }

        .detail-grid .detail-field {
            padding: 12px 16px 12px 0;
        }

        .detail-grid .detail-field:nth-child(even) {
            padding-left: 16px;
            border-left: 1px solid var(--border-light);
        }

        /* ========== MODAL CENTRADO (Nueva Orden) ========== */
        .modal-overlay-center {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay-center.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-content .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-content .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--border-color);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
        }

        .modal-content .modal-body {
            padding: 24px;
        }

        .modal-content .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: var(--bg-secondary);
            margin: 0;
            border-radius: 0;
        }

        /* Form styles */
        .form-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-label .required {
            color: #EF4444;
            margin-left: 2px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--bg-secondary);
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 184, 230, 0.1);
        }

        .form-input:disabled,
        .form-select:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Modalidad tabs */
        .modalidad-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
        }

        .modalidad-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modalidad-tab:hover {
            color: var(--text-primary);
        }

        .modalidad-tab.active {
            background: var(--bg-secondary);
            color: var(--accent-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .modalidad-tab svg {
            width: 18px;
            height: 18px;
        }

        /* Exámenes multi-select */
        .examenes-container {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            max-height: 180px;
            overflow-y: auto;
            background: var(--bg-secondary);
        }

        .examen-option {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .examen-option:last-child {
            border-bottom: none;
        }

        .examen-option:hover {
            background: var(--bg-tertiary);
        }

        .examen-option input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .examen-option label {
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            flex: 1;
        }

        .examenes-selected {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .examen-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 184, 230, 0.1);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
        }

        .examen-tag button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 0;
            font-size: 16px;
            line-height: 1;
        }

        .btn-modal {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-modal-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-modal-secondary:hover {
            background: var(--border-color);
        }

        .btn-modal-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-modal-primary:hover {
            background: var(--accent-hover);
        }

        .btn-modal-primary:disabled {
            background: #94A3B8;
            cursor: not-allowed;
        }

        .info-tiempo {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Alert en modal */
        .modal-alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
            font-size: 14px;
        }

        .modal-alert.show {
            display: block;
        }

        .modal-alert.error {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FECACA;
        }

        .modal-alert.success {
            background: #ECFDF5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        /* ========== MOBILE STYLES ========== */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .top-bar {
                left: 0;
                padding: 0 16px;
                gap: 12px;
            }

            .top-bar-search {
                flex: 1;
                width: auto;
            }

            .theme-toggle span {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 20px 16px;
                padding-top: 84px;
            }
        }

        /* ========== MOBILE APP STYLE ========== */
        .mobile-cards {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                background: #F2F2F7;
            }

            .sidebar {
                display: none;
            }

            .top-bar {
                left: 0;
                padding: 0 16px;
                height: 56px;
            }

            .top-bar-search {
                max-width: 100%;
            }

            .top-bar-actions {
                gap: 8px;
            }

            .empresa-name-topbar {
                display: none;
            }

            .theme-toggle span {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
                padding-top: 72px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 16px;
            }

            .page-header-left h1 {
                font-size: 28px;
                font-weight: 700;
                letter-spacing: -0.5px;
            }

            .page-header-left p {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 12px;
                border-radius: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            .filters-bar {
                flex-direction: column;
                gap: 12px;
                background: white;
                padding: 16px;
                border-radius: 12px;
                margin-bottom: 16px;
            }

            .tabs {
                background: #E5E5EA;
                border-radius: 8px;
                padding: 2px;
                width: 100%;
            }

            .tab {
                flex: 1;
                border-radius: 6px;
                font-size: 13px;
                padding: 8px 12px;
            }

            .tab.active {
                background: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            .stats-badge {
                text-align: center;
                margin-left: 0;
                font-size: 13px;
            }

            /* Hide table on mobile */
            .table-container {
                display: none !important;
            }

            /* Mobile Cards estilo iOS */
            .mobile-cards {
                display: block;
                background: white;
                border-radius: 12px;
                overflow: hidden;
            }

            .mobile-card {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                border-bottom: 0.5px solid #C6C6C8;
                background: white;
                cursor: pointer;
                transition: background 0.15s ease;
                gap: 12px;
            }

            .mobile-card:last-child {
                border-bottom: none;
            }

            .mobile-card:active {
                background: #E5E5EA;
            }

            .mobile-card-avatar {
                width: 50px;
                height: 50px;
                border-radius: 8px;
                background: linear-gradient(135deg, #0099B2, #007A8C);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                font-weight: 600;
                flex-shrink: 0;
            }

            .mobile-card-content {
                flex: 1;
                min-width: 0;
            }

            .mobile-card-title {
                font-size: 17px;
                font-weight: 600;
                color: #000;
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .mobile-card-subtitle {
                font-size: 15px;
                color: #8E8E93;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .mobile-card-subtitle .dot {
                width: 3px;
                height: 3px;
                background: #8E8E93;
                border-radius: 50%;
            }

            .mobile-card-right {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 6px;
                flex-shrink: 0;
            }

            .mobile-card-time {
                font-size: 13px;
                color: #8E8E93;
            }

            .mobile-status-indicator {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                font-size: 13px;
                font-weight: 500;
            }

            .mobile-status-indicator.atendido {
                color: #34C759;
            }

            .mobile-status-indicator.pendiente {
                color: #FF9500;
            }

            .mobile-status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: currentColor;
            }

            /* Estados vacío y cargando */
            .loading-state, .empty-state {
                background: white;
                border-radius: 12px;
                padding: 40px 20px;
            }

            /* Modal estilo iOS */
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }

            .modal {
                max-width: 100%;
                border-radius: 12px 12px 0 0;
                max-height: 90vh;
                animation: modalSlideUp 0.3s ease-out;
            }

            @keyframes modalSlideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            .modal-header {
                padding: 16px;
                border-bottom: 0.5px solid #C6C6C8;
            }

            .modal-body {
                padding: 16px;
                max-height: calc(90vh - 120px);
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-footer {
                padding: 16px;
                gap: 8px;
                flex-wrap: wrap;
            }

            .modal-footer .btn {
                flex: 1;
                min-width: 0;
                font-size: 14px;
                padding: 12px 8px;
            }
        }

        /* Desktop: hide mobile cards */
        @media (min-width: 769px) {
            .mobile-cards {
                display: none !important;
            }
        }

        /* ==================== ESTILOS SECCIÓN ESTADÍSTICAS ==================== */

        /* Welcome Section para Estadísticas */
        .estadisticas-welcome {
            text-align: center;
            margin-bottom: 32px;
        }

        .estadisticas-welcome-title {
            font-size: 44px;
            font-weight: 400;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .estadisticas-welcome-subtitle {
            font-size: 32px;
            font-weight: 400;
            color: var(--text-secondary);
        }

        /* Suggestion Cards para Estadísticas */
        .estadisticas-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .estadistica-suggestion-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .estadistica-suggestion-card:hover {
            box-shadow: var(--shadow-md);
            border-color: #10B981;
            transform: translateY(-2px);
        }

        .estadistica-suggestion-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 20px;
        }

        .estadistica-suggestion-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
        }

        /* Chat Area para Estadísticas */
        .estadisticas-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 24px;
            min-height: 200px;
        }

        .estadisticas-message {
            display: flex;
            gap: 16px;
            animation: estadisticasFadeIn 0.3s ease;
        }

        @keyframes estadisticasFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .estadisticas-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .estadisticas-message-user .estadisticas-message-avatar {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }

        .estadisticas-message-ai .estadisticas-message-avatar {
            background: var(--bg-tertiary);
        }

        .estadisticas-message-content {
            flex: 1;
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
        }

        .estadisticas-message-user .estadisticas-message-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .estadisticas-message-ai .estadisticas-message-content {
            background: var(--bg-tertiary);
        }

        .estadisticas-message-ai .estadisticas-message-content p {
            margin-bottom: 12px;
        }

        .estadisticas-message-ai .estadisticas-message-content p:last-child {
            margin-bottom: 0;
        }

        /* Loading Animation para Estadísticas */
        .estadisticas-loading-dots {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .estadisticas-loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-tertiary);
            animation: estadisticasBounce 1.4s infinite ease-in-out both;
        }

        .estadisticas-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .estadisticas-loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes estadisticasBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Input Area para Estadísticas */
        .estadisticas-input-area {
            position: sticky;
            bottom: 0;
            background: var(--bg-primary);
            padding: 16px 0;
        }

        .estadisticas-input-container {
            background: var(--bg-tertiary);
            border-radius: 28px;
            padding: 8px 8px 8px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .estadisticas-input-container:focus-within {
            box-shadow: var(--shadow-md);
            border-color: #10B981;
        }

        .estadisticas-input-field {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
            font-family: inherit;
        }

        .estadisticas-input-field::placeholder {
            color: var(--text-tertiary);
        }

        .estadisticas-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .estadisticas-send-btn:hover {
            transform: scale(1.05);
        }

        .estadisticas-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .estadisticas-send-btn svg {
            width: 20px;
            height: 20px;
        }

        .estadisticas-helper-text {
            text-align: center;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 12px;
        }

        /* Responsive para Estadísticas */
        @media (max-width: 768px) {
            .estadisticas-welcome-title {
                font-size: 32px;
            }

            .estadisticas-welcome-subtitle {
                font-size: 24px;
            }

            .estadisticas-suggestions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .estadisticas-suggestions {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== FIN ESTILOS SECCIÓN ESTADÍSTICAS ==================== */
    </style>
</head>
<body>
    <!-- Login Screen (solo se muestra si no está autenticado) -->
    <div class="login-screen" id="loginScreen">
        <!-- Banner de bienvenida -->
        <div class="welcome-banner">
            <div class="welcome-banner-content">
                <h3>Tenemos una <strong>sorpresa para ti</strong>!</h3>
                <p>Este es tu nuevo panel de empresa, regístrate creando tu usuario y contraseña y espera la confirmación de entrada.</p>
            </div>
        </div>

        <div class="login-card">
            <div class="login-logo">
                <img src="/bsl-logo.png" alt="BSL">
            </div>
            <h1 class="login-title">Panel de Empresa</h1>
            <p class="login-subtitle">Ingresa tus credenciales para continuar</p>

            <div class="alert" id="alertMsg"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Correo electronico</label>
                    <input type="email" class="form-input" id="loginEmail"
                           placeholder="correo@ejemplo.com" required autocomplete="email">
                </div>

                <div class="form-group">
                    <label class="form-label">Contrasena</label>
                    <div class="password-wrapper">
                        <input type="password" class="form-input" id="loginPassword"
                               placeholder="Tu contrasena" required autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="toggleLoginPassword()">
                            <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" class="login-btn" id="btnLogin">
                    Iniciar Sesion
                </button>
            </form>

            <div class="login-footer">
                <p style="font-size: 16px; margin-bottom: 16px;">No tienes cuenta? <a href="/registro.html">Registrate aqui</a></p>
                <a href="https://wa.me/573008021701?text=Soporte%20Registro" target="_blank" class="whatsapp-support-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    Soporte
                </a>
            </div>
        </div>
    </div>

    <!-- Panel Screen -->
    <div class="panel-screen" id="panelScreen">
        <div class="app-container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/bsl-logo.png" alt="BSL - Bienestar & Salud Laboral">
                </div>
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item active" id="navOrdenes" onclick="mostrarSeccion('ordenes'); event.preventDefault();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        Órdenes
                    </a>
                    <a href="#" class="nav-item" onclick="abrirModalNuevaOrden(); event.preventDefault();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        Nueva Orden
                    </a>
                    <a href="#" class="nav-item" id="navPreguntaLoQueQuieras" onclick="mostrarSeccion('estadisticas'); event.preventDefault();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        Pregunta lo que quieras
                    </a>
                </nav>
            </aside>

            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-search">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Buscar por cédula o nombre...">
                </div>
                <div class="top-bar-actions">
                    <span class="empresa-name-topbar" id="empresaNameTopbar">EMPRESA</span>
                    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <span id="themeText">Dark</span>
                    </button>
                    <button class="btn-icon-top" onclick="actualizarDatos()" title="Actualizar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                    <a href="https://api.whatsapp.com/send?phone=573008021701&text=Hola.%20Requiero%20soporte%20con%20el%20panel%20de%20empresa" target="_blank" class="btn-icon-top" title="Soporte WhatsApp">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </a>
                    <button class="btn-icon-top btn-logout" onclick="cerrarSesion()" title="Cerrar sesión">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Sección de Órdenes -->
                <div id="seccionOrdenes">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Órdenes
                        </h1>
                        <p>Gestión de órdenes médicas</p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid" style="display: grid !important;">
                    <div class="stat-card" style="display: block !important;">
                        <div class="stat-value" id="statProgramadosHoy">0</div>
                        <div class="stat-label">Programados Hoy</div>
                    </div>
                    <div class="stat-card" style="display: block !important;">
                        <div class="stat-value" id="statAtendidosHoy">0</div>
                        <div class="stat-label">Atendidos Hoy</div>
                    </div>
                    <div class="stat-card" style="display: block !important;">
                        <div class="stat-value" id="statTotalOrdenes">0</div>
                        <div class="stat-label">Total Órdenes</div>
                    </div>
                    <div class="stat-card" id="statCargaCard" style="display: none;">
                        <div class="stat-value" id="statCargados">0</div>
                        <div class="stat-label" id="statCargaLabel">Cargados</div>
                    </div>
                </div>

                <!-- Filters Bar -->
                <div class="filters-bar">
                    <div class="tabs">
                        <button class="tab active" data-filter="todos">Todos</button>
                        <button class="tab" data-filter="atendido">Atendidos</button>
                        <button class="tab" data-filter="pendiente">Pendientes</button>
                        <button class="tab" data-filter="sin-aprobar" id="tabSinAprobar" style="display: none;">Sin Aprobar</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="date" id="fechaDesde" class="form-input" style="padding: 8px 12px; font-size: 13px; border-radius: 8px; width: auto;" title="Fecha desde">
                        <span style="color: var(--text-tertiary); font-size: 13px;">a</span>
                        <input type="date" id="fechaHasta" class="form-input" style="padding: 8px 12px; font-size: 13px; border-radius: 8px; width: auto;" title="Fecha hasta">
                        <button id="btnLimpiarFechas" onclick="limpiarFiltroFechas()" style="padding: 8px 12px; border: none; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--text-secondary);" title="Limpiar filtro de fechas">✕</button>
                    </div>
                    <div class="stats-badge" id="tableCount">
                        <strong>0</strong> registros
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Cargando órdenes...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    <p class="empty-state-title">No hay órdenes</p>
                    <p class="empty-state-text">No se encontraron órdenes para esta empresa</p>
                </div>

                <!-- Mobile Cards Container -->
                <div class="mobile-cards" id="mobileCards"></div>

                <!-- Barra de acciones para selección múltiple -->
                <div class="selection-actions" id="selectionActions" style="display: none; padding: 12px 16px; background: #EEF2FF; border-radius: 8px; margin-bottom: 16px; align-items: center; gap: 16px;">
                    <span style="font-size: 14px; color: #4338CA; font-weight: 500;">
                        <span id="selectedCount">0</span> seleccionados
                    </span>
                    <button class="btn btn-primary" onclick="descargarCertificadosSeleccionados()" style="padding: 8px 16px; font-size: 13px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Descargar Certificados
                    </button>
                    <button class="btn btn-secondary" onclick="limpiarSeleccion()" style="padding: 8px 16px; font-size: 13px;">
                        Limpiar selección
                    </button>
                </div>

                <!-- Table Container -->
                <div class="table-container" id="tableContainer" style="display: none;">
                    <table class="data-table">
                        <thead id="tableHead">
                            <tr id="tableHeaderRow">
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Seleccionar todos" style="cursor: pointer;">
                                </th>
                                <th>Paciente</th>
                                <th>Cédula</th>
                                <th>Fecha Programada</th>
                                <th>Fecha Consulta</th>
                                <th>Estado</th>
                                <th style="width: 50px; text-align: center;">Descargar</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                    <div class="pagination" id="pagination" style="display: none;">
                        <button class="pagination-btn" id="btnPrev">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Anterior
                        </button>
                        <span class="pagination-info" id="paginationInfo">Página 1 de 1</span>
                        <button class="pagination-btn" id="btnNext">
                            Siguiente
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
                </div>
                <!-- Fin Sección de Órdenes -->

                <!-- Sección de Estadísticas -->
                <div id="seccionEstadisticas" style="display: none;">
                    <!-- Welcome Section -->
                    <div class="estadisticas-welcome" id="estadisticasWelcomeSection">
                        <h1 class="estadisticas-welcome-title">Hola, <span id="estadisticasEmpresaNombre"></span></h1>
                        <p class="estadisticas-welcome-subtitle">¿En qué puedo ayudarte hoy?</p>
                    </div>

                    <!-- Suggestion Cards -->
                    <div class="estadisticas-suggestions" id="estadisticasSuggestionsContainer">
                        <div class="estadistica-suggestion-card" onclick="estadisticasEnviarSugerencia('¿Cuántas personas fuman o han fumado?')">
                            <div class="estadistica-suggestion-icon">🚬</div>
                            <p class="estadistica-suggestion-title">¿Cuántas personas fuman o han fumado?</p>
                        </div>
                        <div class="estadistica-suggestion-card" onclick="estadisticasEnviarSugerencia('¿Cuántos colaboradores tienen riesgo cardiovascular?')">
                            <div class="estadistica-suggestion-icon">❤️</div>
                            <p class="estadistica-suggestion-title">¿Cuántos tienen riesgo cardiovascular?</p>
                        </div>
                        <div class="estadistica-suggestion-card" onclick="estadisticasEnviarSugerencia('¿Cuál es la edad promedio y distribución por género?')">
                            <div class="estadistica-suggestion-icon">📊</div>
                            <p class="estadistica-suggestion-title">¿Cuál es la edad promedio y distribución por género?</p>
                        </div>
                        <div class="estadistica-suggestion-card" onclick="estadisticasEnviarSugerencia('¿Cuántos tienen antecedentes familiares de diabetes o hipertensión?')">
                            <div class="estadistica-suggestion-icon">👨‍👩‍👧</div>
                            <p class="estadistica-suggestion-title">¿Cuántos tienen antecedentes familiares de diabetes?</p>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="estadisticas-chat-area" id="estadisticasChatArea"></div>

                    <!-- Input Area -->
                    <div class="estadisticas-input-area">
                        <div class="estadisticas-input-container">
                            <input
                                type="text"
                                class="estadisticas-input-field"
                                id="estadisticasInputPregunta"
                                placeholder="Escribe tu pregunta..."
                                onkeypress="estadisticasHandleKeyPress(event)"
                            >
                            <button class="estadisticas-send-btn" id="estadisticasSendBtn" onclick="estadisticasEnviarPregunta()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                        <p class="estadisticas-helper-text">En este espacio puedes conocer todo sobre la salud de tus colaboradores.</p>
                    </div>
                </div>
                <!-- Fin Sección de Estadísticas -->
            </main>
        </div>
    </div>

    <!-- Modal: Ver Detalles -->
    <div id="modalDetalles" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Detalles del Paciente</h2>
                </div>
                <button class="btn-close" onclick="cerrarModalDetalles()">✕</button>
            </div>
            <div class="modal-body" id="modalDetallesBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="abrirModalEdicion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Editar
                </button>
                <a href="#" target="_blank" class="btn btn-primary" id="btnDescargarPDF">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Descargar PDF
                </a>
                <a href="#" target="_blank" class="btn btn-primary" id="btnResultadoPsicologico" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Resultado Psicológico
                </a>
                <button class="btn btn-primary" id="btnVerScl90" onclick="abrirModalScl90()" style="display: none; background: #7C3AED; color: #fff;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    Ver SCL-90
                </button>
                <button class="btn" id="btnAprobar" onclick="aprobarOrden()" style="display: none; background: #000; color: #fff;">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Resultados SCL-90 -->
    <div id="modalScl90" class="modal-overlay" style="z-index: 1100;">
        <div class="modal modal-large">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Resultados SCL-90</h2>
                    <p style="font-size: 13px; color: var(--text-tertiary); margin-top: 2px;">Inventario de Sintomas SCL-90</p>
                </div>
                <button class="btn-close" onclick="cerrarModalScl90()">&#x2715;</button>
            </div>
            <div class="modal-body" id="modalScl90Body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Modal Edición -->
    <div id="modalEdicion" class="modal-overlay">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 class="modal-title">Editar Orden</h2>
                <button class="btn-close" onclick="cerrarModalEdicion()">✕</button>
            </div>
            <div class="modal-body">
                <form id="formEdicion" onsubmit="guardarCambiosEdicion(event)">
                    <input type="hidden" id="edit-id">

                    <!-- Datos Personales -->
                    <div class="form-section-title">Datos Personales</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Nombre</label>
                            <input type="text" class="form-input" id="edit-primerNombre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Nombre</label>
                            <input type="text" class="form-input" id="edit-segundoNombre">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Apellido</label>
                            <input type="text" class="form-input" id="edit-primerApellido">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Apellido</label>
                            <input type="text" class="form-input" id="edit-segundoApellido">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cédula</label>
                            <input type="text" class="form-input" id="edit-numeroId" disabled style="background: var(--bg-tertiary);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Celular</label>
                            <input type="tel" class="form-input" id="edit-celular">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ciudad</label>
                            <select class="form-select" id="edit-ciudad">
                                <option value="">Seleccionar ciudad...</option>
                                <option value="Bogotá">Bogotá D.C.</option>
                                <option value="Medellín">Medellín</option>
                                <option value="Cali">Cali</option>
                                <option value="Barranquilla">Barranquilla</option>
                                <option value="Cartagena">Cartagena</option>
                                <option value="Cúcuta">Cúcuta</option>
                                <option value="Bucaramanga">Bucaramanga</option>
                                <option value="Pereira">Pereira</option>
                                <option value="Santa Marta">Santa Marta</option>
                                <option value="Ibagué">Ibagué</option>
                                <option value="Pasto">Pasto</option>
                                <option value="Manizales">Manizales</option>
                                <option value="Neiva">Neiva</option>
                                <option value="Villavicencio">Villavicencio</option>
                                <option value="Armenia">Armenia</option>
                                <option value="Valledupar">Valledupar</option>
                                <option value="Montería">Montería</option>
                                <option value="Sincelejo">Sincelejo</option>
                                <option value="Popayán">Popayán</option>
                                <option value="Floridablanca">Floridablanca</option>
                                <option value="Buenaventura">Buenaventura</option>
                                <option value="Soledad">Soledad</option>
                                <option value="Itagüí">Itagüí</option>
                                <option value="Soacha">Soacha</option>
                                <option value="Bello">Bello</option>
                                <option value="Palmira">Palmira</option>
                                <option value="Tunja">Tunja</option>
                                <option value="Girardot">Girardot</option>
                                <option value="Riohacha">Riohacha</option>
                                <option value="Barrancabermeja">Barrancabermeja</option>
                                <option value="Dosquebradas">Dosquebradas</option>
                                <option value="Envigado">Envigado</option>
                                <option value="Tuluá">Tuluá</option>
                                <option value="Sogamoso">Sogamoso</option>
                                <option value="Duitama">Duitama</option>
                                <option value="Zipaquirá">Zipaquirá</option>
                                <option value="Facatativá">Facatativá</option>
                                <option value="Chía">Chía</option>
                                <option value="Fusagasugá">Fusagasugá</option>
                                <option value="Otro">Otra ciudad</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cargo</label>
                            <input type="text" class="form-input" id="edit-cargo">
                        </div>
                    </div>

                    <!-- Información del Examen -->
                    <div class="form-section-title" style="margin-top: 20px;">Información del Examen</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Examen</label>
                            <select class="form-select" id="edit-tipoExamen">
                                <option value="">Seleccionar...</option>
                                <option value="INGRESO">Ingreso</option>
                                <option value="PERIODICO">Periódico</option>
                                <option value="RETIRO">Retiro</option>
                                <option value="REUBICACION">Reubicación</option>
                                <option value="POST-INCAPACIDAD">Post-incapacidad</option>
                                <option value="SEGUIMIENTO OCUPACIONAL">Seguimiento Ocupacional</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Atención</label>
                            <input type="date" class="form-input" id="edit-fechaAtencion">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Hora de Atención</label>
                            <input type="time" class="form-input" id="edit-horaAtencion">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exámenes</label>
                        <div class="examenes-container" id="editExamenesContainer">
                            <div style="padding: 14px; color: var(--text-tertiary); font-size: 14px;">Cargando exámenes...</div>
                        </div>
                        <div class="examenes-selected" id="editExamenesSelected"></div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="btnGuardarEdicion" style="width: 100%; margin-top: 20px;">
                        Guardar Cambios
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Orden -->
    <div class="modal-overlay-center" id="modalNuevaOrden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nueva Orden</h2>
                <button class="modal-close" onclick="cerrarModalNuevaOrden()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-alert" id="modalAlert"></div>

                <!-- PASO 1: Verificar Documento -->
                <div id="modalPaso1">
                    <div class="form-section-title">Paso 1: Verificar Documento</div>

                    <div class="form-group">
                        <label class="form-label">Número de Identificación <span class="required">*</span></label>
                        <input type="text" class="form-input" id="modalNumeroId" placeholder="Ingrese la cédula del paciente">
                    </div>

                    <button type="button" class="btn-modal btn-modal-primary" id="btnVerificarDocModal" onclick="verificarDocumentoModal()" style="width: 100%; margin-top: 16px;">Verificar y Continuar</button>
                </div>

                <!-- PASO 2: Resto del Formulario -->
                <div id="modalPaso2" style="display: none;">
                    <!-- Empresa (no editable) -->
                    <div class="form-group">
                        <label class="form-label">Empresa</label>
                        <input type="text" class="form-input" id="modalEmpresa" disabled>
                    </div>

                    <!-- Datos del Paciente -->
                    <div class="form-section-title">Datos del Paciente</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Número de Identificación</label>
                            <input type="text" class="form-input" id="modalNumeroIdDisplay" disabled style="background: var(--bg-tertiary);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Celular <span class="required">*</span></label>
                            <input type="tel" class="form-input" id="modalCelular" placeholder="Número de celular">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Nombre <span class="required">*</span></label>
                            <input type="text" class="form-input" id="modalPrimerNombre" placeholder="Primer nombre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Nombre</label>
                            <input type="text" class="form-input" id="modalSegundoNombre" placeholder="Segundo nombre">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Apellido <span class="required">*</span></label>
                            <input type="text" class="form-input" id="modalPrimerApellido" placeholder="Primer apellido">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Apellido</label>
                            <input type="text" class="form-input" id="modalSegundoApellido" placeholder="Segundo apellido">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" id="cargoContainer">
                            <label class="form-label">Cargo <span class="required">*</span></label>
                            <!-- Se reemplaza dinámicamente por input o select según configuración -->
                            <input type="text" class="form-input" id="modalCargo" placeholder="Cargo del trabajador">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ciudad <span class="required">*</span></label>
                            <select class="form-select" id="modalCiudad">
                                <option value="">Seleccionar ciudad...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Subempresa (solo visible si la empresa tiene subempresas configuradas) -->
                    <div class="form-row" id="subempresaContainer" style="display: none;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Subempresa / Sede</label>
                            <select class="form-select" id="modalSubempresa">
                                <option value="">Seleccionar subempresa...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Centro de Costo (solo visible si la empresa tiene centros de costo configurados) -->
                    <div class="form-row" id="centroCostoContainer" style="display: none;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Centro de Costo</label>
                            <select class="form-select" id="modalCentroCosto">
                                <option value="">Seleccionar centro de costo...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Datos del Examen -->
                    <div class="form-section-title">Datos del Examen</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Examen <span class="required">*</span></label>
                            <select class="form-select" id="modalTipoExamen">
                                <option value="">Seleccionar...</option>
                                <option value="INGRESO">Ingreso</option>
                                <option value="PERIODICO">Periódico</option>
                                <option value="RETIRO">Retiro</option>
                                <option value="REUBICACION">Reubicación</option>
                                <option value="POST-INCAPACIDAD">Post-incapacidad</option>
                            </select>
                        </div>
                    </div>

                    <!-- Modalidad tabs -->
                    <div class="form-group">
                        <label class="form-label">Modalidad</label>
                        <div class="modalidad-tabs">
                            <button type="button" class="modalidad-tab active" data-modalidad="presencial" onclick="cambiarModalidadOrden('presencial')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Presencial
                            </button>
                            <button type="button" class="modalidad-tab" data-modalidad="virtual" onclick="cambiarModalidadOrden('virtual')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                </svg>
                                Virtual
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Atención <span class="required">*</span></label>
                            <input type="date" class="form-input" id="modalFechaAtencion" onchange="validarYCargarTurnosDisponibles()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora de Atención <span class="required">*</span></label>
                            <select class="form-select" id="modalHoraAtencion">
                                <option value="">Primero seleccione fecha...</option>
                            </select>
                            <div class="info-tiempo" id="modalInfoTiempo">El sistema asignará automáticamente un médico disponible</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Exámenes</label>
                        <div class="examenes-container" id="modalExamenesContainer">
                            <div style="padding: 14px; color: var(--text-tertiary); font-size: 14px;">Cargando exámenes...</div>
                        </div>
                        <div class="examenes-selected" id="modalExamenesSelected"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="modalFooterPaso2" style="display: none;">
                <button type="button" class="btn-modal btn-modal-secondary" onclick="volverPaso1Modal()">← Volver</button>
                <button type="button" class="btn-modal btn-modal-primary" id="btnCrearOrden" onclick="crearOrdenEmpresa()">Crear Orden</button>
            </div>
        </div>
    </div>

    <!-- Modal de orden duplicada (PENDIENTE) -->
    <div class="modal-overlay-center" id="modalDuplicado">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 40px; height: 40px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2" width="20" height="20">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </span>
                    Orden existente
                </h2>
                <button class="modal-close" onclick="cerrarModalDuplicado()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Ya existe una orden <strong>pendiente</strong> para este número de documento.</p>
                <div id="ordenExistenteInfo" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px;"></div>
                <p id="mensajeFormulario" style="margin-top: 12px; font-size: 14px; color: var(--text-secondary);"></p>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button type="button" class="btn-modal btn-modal-primary" id="btnUsarExistente" style="width: 100%;">Usar orden existente</button>
                <button type="button" class="btn-modal" id="btnCrearNuevaModal" style="width: 100%; background: #F59E0B; color: white;">Crear nueva de todos modos</button>
                <button type="button" class="btn-modal btn-modal-secondary" onclick="cerrarModalDuplicado()" style="width: 100%;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de certificado existente (ATENDIDO) -->
    <div class="modal-overlay-center" id="modalAtendido">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 40px; height: 40px; background: #DBEAFE; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </span>
                    Certificado existente
                </h2>
                <button class="modal-close" onclick="cerrarModalAtendido()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Ya existe un <strong>certificado médico</strong> para este número de documento.</p>
                <div id="ordenAtendidaInfo" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px;"></div>
                <p style="margin-top: 12px; font-size: 14px; color: var(--text-secondary);">Si necesita crear una nueva orden, puede continuar.</p>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button type="button" class="btn-modal" id="btnCrearNuevaAtendido" style="width: 100%; background: #F59E0B; color: white;">Crear nueva orden</button>
                <button type="button" class="btn-modal btn-modal-secondary" onclick="cerrarModalAtendido()" style="width: 100%;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de cita expirada -->
    <div class="modal-overlay-center" id="modalExpirado">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 40px; height: 40px; background: #FEE2E2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                    </span>
                    Cita expirada
                </h2>
                <button class="modal-close" onclick="cerrarModalExpirado()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Tenía una cita programada pero la <strong>fecha ya pasó</strong>. Puede reagendar la cita.</p>
                <div id="ordenExpiradaInfo" style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 10px; padding: 16px; margin-bottom: 16px;"></div>

                <div style="background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 10px; padding: 16px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #166534; margin-bottom: 12px;">Nueva fecha y hora:</h4>

                    <!-- Tabs de modalidad -->
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Modalidad</label>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="modalidad-tab-expirado active" data-modalidad="presencial" onclick="cambiarModalidadExpirado('presencial')" style="flex: 1; padding: 10px; border: 1px solid #10B981; border-radius: 8px; background: #10B981; color: white; cursor: pointer; font-weight: 500;">
                                Presencial
                            </button>
                            <button type="button" class="modalidad-tab-expirado" data-modalidad="virtual" onclick="cambiarModalidadExpirado('virtual')" style="flex: 1; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; background: white; color: #374151; cursor: pointer; font-weight: 500;">
                                Virtual
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Fecha</label>
                        <input type="date" id="fechaExpirado" onchange="validarYCargarTurnosExpirado()" class="form-input" style="width: 100%; padding: 10px; border-radius: 8px;">
                    </div>

                    <div>
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Hora disponible</label>
                        <select id="horaExpirado" class="form-input" style="width: 100%; padding: 10px; border-radius: 8px;">
                            <option value="">Primero selecciona una fecha</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button type="button" class="btn-modal" id="btnActualizarFecha" onclick="actualizarFechaYContinuar()" style="width: 100%; background: #10B981; color: white;">Reagendar y continuar</button>
                <button type="button" class="btn-modal" id="btnCrearNuevaExpirado" style="width: 100%; background: #F59E0B; color: white;">Crear nueva orden</button>
                <button type="button" class="btn-modal btn-modal-secondary" onclick="cerrarModalExpirado()" style="width: 100%;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmación Orden Creada -->
    <div class="modal-overlay-center" id="modalConfirmacion" style="display: none;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="padding: 24px;">
                <div style="width: 60px; height: 60px; background: #10B981; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <h2 style="margin: 0 0 8px; color: var(--text-primary); font-size: 20px;">Orden Creada</h2>
                <p style="margin: 0 0 20px; color: var(--text-secondary);" id="confirmacionMensaje">La orden ha sido creada exitosamente.</p>
                <button class="btn-modal btn-modal-primary" onclick="cerrarModalConfirmacion()" style="width: 100%;">Aceptar</button>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let codEmpresa = '';
        let usuarioActual = null;
        let permisosUsuario = []; // Permisos cargados del servidor
        let configEmpresa = null; // Configuración de ciudades, exámenes y subempresas
        let allData = [];
        let filteredData = [];
        let currentPage = 0;
        const pageSize = 10;
        let searchTimeout = null;
        let busquedaActual = '';
        let currentFilter = 'todos';
        let pacienteActual = null;
        let fechaDesde = '';
        let fechaHasta = '';

        // Función para capitalizar (primera letra mayúscula de cada palabra)
        function capitalize(str) {
            if (!str) return str;
            return str.trim().toLowerCase().replace(/(^|\s)\S/g, char => char.toUpperCase());
        }

        // Elementos del DOM
        const loginScreen = document.getElementById('loginScreen');
        const panelScreen = document.getElementById('panelScreen');
        const loginError = document.getElementById('loginError');
        const searchInput = document.getElementById('searchInput');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const pagination = document.getElementById('pagination');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const paginationInfo = document.getElementById('paginationInfo');
        const tableCount = document.getElementById('tableCount');

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
                text.textContent = 'Light';
            } else {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                text.textContent = 'Dark';
            }
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // Función para verificar si tiene un permiso
        function tienePermiso(permiso) {
            return permisosUsuario.includes(permiso);
        }

        // Cargar permisos del usuario
        async function cargarPermisos() {
            try {
                const response = await Auth.fetchAuth('/api/auth/mis-permisos');
                if (response && response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        permisosUsuario = data.permisos || [];
                    }
                }
            } catch (error) {
                console.error('Error cargando permisos:', error);
                permisosUsuario = [];
            }
        }

        // Cargar configuración de la empresa (ciudades, exámenes, subempresas)
        async function cargarConfigEmpresa() {
            if (!codEmpresa) return;
            try {
                const response = await fetch(`/api/empresas/codigo/${encodeURIComponent(codEmpresa)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        configEmpresa = data.data;
                        console.log('Configuración de empresa cargada:', configEmpresa);
                    }
                }
            } catch (error) {
                console.error('Error cargando configuración de empresa:', error);
                configEmpresa = null;
            }
        }

        // Aplicar permisos a la UI
        function aplicarPermisosUI() {
            // VER_ORDENES - Si no tiene permiso, ocultar toda la sección de órdenes
            if (!tienePermiso('VER_ORDENES')) {
                const dataSection = document.querySelector('.data-section');
                if (dataSection) dataSection.style.display = 'none';
            }

            // CREAR_ORDEN - Siempre visible (no se oculta)
            // El botón "Nueva Orden" siempre está visible para todos los usuarios

            // VER_ESTADISTICAS - Siempre visible (forzar display)
            const statsGrid = document.querySelector('.stats-grid');
            if (statsGrid) {
                statsGrid.style.display = 'grid';
                console.log('✅ Estadísticas forzadas a mostrarse');
            }

            // PREGUNTA_LO_QUE_QUIERAS - Mostrar/ocultar botón según permiso
            const navPregunta = document.getElementById('navPreguntaLoQueQuieras');
            if (navPregunta) {
                if (tienePermiso('PREGUNTA_LO_QUE_QUIERAS')) {
                    navPregunta.style.display = 'flex';
                    console.log('✅ Botón "Pregunta lo que quieras" habilitado');
                } else {
                    navPregunta.style.display = 'none';
                    console.log('❌ Botón "Pregunta lo que quieras" oculto por falta de permiso');
                }
            }

            // APROBADOR - Mostrar botón "Sin Aprobar" solo para usuarios con permiso APROBADOR
            const tabSinAprobar = document.getElementById('tabSinAprobar');
            if (tabSinAprobar) {
                if (tienePermiso('APROBADOR')) {
                    tabSinAprobar.style.display = 'inline-block';
                    console.log('✅ Botón "Sin Aprobar" habilitado para APROBADOR');
                } else {
                    tabSinAprobar.style.display = 'none';
                }
            }
        }

        // ========== FUNCIONES DE LOGIN ==========
        function toggleLoginPassword() {
            const input = document.getElementById('loginPassword');
            const icon = document.getElementById('eyeIcon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
            } else {
                input.type = 'password';
                icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
            }
        }

        function mostrarAlertaLogin(mensaje, tipo = 'error') {
            const alert = document.getElementById('alertMsg');
            alert.textContent = mensaje;
            alert.className = `alert show ${tipo}`;
        }

        function ocultarAlertaLogin() {
            document.getElementById('alertMsg').className = 'alert';
        }

        async function handleLogin(e) {
            e.preventDefault();
            ocultarAlertaLogin();

            const btn = document.getElementById('btnLogin');
            btn.disabled = true;
            btn.textContent = 'Verificando...';

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            try {
                const result = await Auth.login(email, password);

                if (result.success) {
                    mostrarAlertaLogin('Inicio de sesion exitoso!', 'success');
                    setTimeout(async () => {
                        usuarioActual = result.usuario;
                        codEmpresa = usuarioActual.codEmpresa || usuarioActual.cod_empresa || '';

                        // Si es admin sin codEmpresa, redirigir al panel admin
                        if (usuarioActual.rol === 'admin' && !codEmpresa) {
                            window.location.href = '/panel-admin.html';
                            return;
                        }

                        // Cargar permisos y configuración
                        await cargarPermisos();
                        await cargarConfigEmpresa();
                        mostrarPanel();
                        aplicarPermisosUI();
                    }, 500);
                } else {
                    // Manejar diferentes estados
                    if (result.estado === 'pendiente') {
                        mostrarAlertaLogin('Tu cuenta esta pendiente de aprobacion. Te notificaremos cuando sea aprobada.', 'warning');
                    } else if (result.estado === 'rechazado') {
                        mostrarAlertaLogin('Tu solicitud de cuenta fue rechazada. Contacta al administrador.', 'error');
                    } else if (result.estado === 'suspendido') {
                        mostrarAlertaLogin('Tu cuenta ha sido suspendida. Contacta al administrador.', 'error');
                    } else {
                        mostrarAlertaLogin(result.message || 'Error al iniciar sesion');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlertaLogin('Error de conexion. Intenta de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar Sesion';
            }
        }

        // Verificar sesión con JWT
        document.addEventListener('DOMContentLoaded', async () => {
            // Agregar listener al formulario de login
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            // Verificar autenticación
            usuarioActual = await Auth.verificarSesion();

            if (usuarioActual) {
                // Usuario autenticado
                codEmpresa = usuarioActual.codEmpresa || '';

                // Si es admin sin codEmpresa, redirigir al panel admin
                if (usuarioActual.rol === 'admin' && !codEmpresa) {
                    window.location.href = '/panel-admin.html';
                    return;
                }

                // Cargar permisos y configuración de empresa antes de mostrar el panel
                await cargarPermisos();
                await cargarConfigEmpresa();
                mostrarPanel();
                aplicarPermisosUI();
            } else {
                // No autenticado - mostrar pantalla de login
                // El formulario de login ya está visible por defecto
            }

            // Tab filters
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    aplicarFiltros();
                });
            });

            // Filtros de fecha
            document.getElementById('fechaDesde').addEventListener('change', (e) => {
                fechaDesde = e.target.value;
                aplicarFiltros();
            });
            document.getElementById('fechaHasta').addEventListener('change', (e) => {
                fechaHasta = e.target.value;
                aplicarFiltros();
            });
        });

        function limpiarFiltroFechas() {
            fechaDesde = '';
            fechaHasta = '';
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            aplicarFiltros();
        }

        // Función para mostrar el panel (después de verificar autenticación)
        function mostrarPanel() {
            loginScreen.style.display = 'none';
            panelScreen.classList.add('active');
            document.getElementById('empresaNameTopbar').textContent = codEmpresa || usuarioActual?.email || 'Usuario';

            actualizarDatos();
        }

        // Cerrar sesión usando Auth.js
        function cerrarSesion() {
            if (confirm('¿Cerrar sesión?')) {
                Auth.logout();
            }
        }

        // Función para cambiar entre secciones
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.getElementById('seccionOrdenes').style.display = 'none';
            document.getElementById('seccionEstadisticas').style.display = 'none';

            // Remover clase active de todos los nav-items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Mostrar la sección seleccionada y activar su nav-item
            if (seccion === 'ordenes') {
                document.getElementById('seccionOrdenes').style.display = 'block';
                document.getElementById('navOrdenes').classList.add('active');
            } else if (seccion === 'estadisticas') {
                document.getElementById('seccionEstadisticas').style.display = 'block';
                document.getElementById('navPreguntaLoQueQuieras').classList.add('active');
                // Inicializar sección de estadísticas
                estadisticasInicializar();
            }
        }

        // Cargar datos con paginación del servidor
        let totalOrdenes = 0;
        const LIMIT_POR_PAGINA = 5000; // Cargar en lotes

        async function actualizarDatos() {
            mostrarLoading();
            allData = [];

            try {
                // Determinar el endpoint según el perfil
                // APROBADOR usa endpoint especial que solo muestra atendidos sin aprobación
                const esAprobador = tienePermiso('APROBADOR');
                const endpoint = esAprobador
                    ? `/api/ordenes-aprobador?codEmpresa=${encodeURIComponent(codEmpresa)}&limit=${LIMIT_POR_PAGINA}&offset=0`
                    : `/api/ordenes?codEmpresa=${encodeURIComponent(codEmpresa)}&limit=${LIMIT_POR_PAGINA}&offset=0`;

                // Primera carga: obtener stats y primera página
                const response = await Auth.fetchAuth(endpoint);
                if (!response) {
                    mostrarEmpty();
                    return;
                }
                const result = await response.json();

                if (result.success) {
                    allData = result.data || [];
                    totalOrdenes = result.total || allData.length;

                    // Actualizar estadísticas desde el servidor
                    if (result.stats) {
                        document.getElementById('statProgramadosHoy').textContent = result.stats.programadosHoy;
                        document.getElementById('statAtendidosHoy').textContent = result.stats.atendidosHoy;
                    }
                    document.getElementById('statTotalOrdenes').textContent = totalOrdenes;

                    // Si hay más datos, cargarlos en segundo plano
                    if (totalOrdenes > LIMIT_POR_PAGINA) {
                        // Mostrar indicador de carga
                        document.getElementById('statCargaCard').style.display = '';
                        document.getElementById('statCargados').textContent = allData.length;
                        document.getElementById('statCargaLabel').textContent = `de ${totalOrdenes} cargados...`;
                        cargarDatosRestantes();
                    } else {
                        document.getElementById('statCargaCard').style.display = 'none';
                    }

                    aplicarFiltros();
                } else {
                    mostrarEmpty();
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarEmpty();
            }
        }

        // Cargar datos restantes en segundo plano
        async function cargarDatosRestantes() {
            let offset = LIMIT_POR_PAGINA;
            const statCargaCard = document.getElementById('statCargaCard');
            const statCargados = document.getElementById('statCargados');
            const statCargaLabel = document.getElementById('statCargaLabel');
            const esAprobador = tienePermiso('APROBADOR');
            const baseEndpoint = esAprobador ? '/api/ordenes-aprobador' : '/api/ordenes';

            while (offset < totalOrdenes) {
                try {
                    const response = await Auth.fetchAuth(`${baseEndpoint}?codEmpresa=${encodeURIComponent(codEmpresa)}&limit=${LIMIT_POR_PAGINA}&offset=${offset}`);
                    if (!response) break;
                    const result = await response.json();

                    if (result.success && result.data) {
                        allData = allData.concat(result.data);
                        // Actualizar indicador de progreso
                        statCargados.textContent = allData.length;
                        statCargaLabel.textContent = `de ${totalOrdenes} cargados...`;
                        aplicarFiltros(); // Re-renderizar con nuevos datos
                    }

                    offset += LIMIT_POR_PAGINA;
                } catch (error) {
                    console.error('Error cargando datos adicionales:', error);
                    break;
                }
            }

            // Ocultar indicador cuando termine
            statCargaCard.style.display = 'none';
        }

        function aplicarFiltros() {
            let data = [...allData];

            // Aplicar filtro de estado
            if (currentFilter === 'atendido') {
                data = data.filter(o => o.atendido === 'ATENDIDO');
            } else if (currentFilter === 'pendiente') {
                data = data.filter(o => o.atendido !== 'ATENDIDO');
            } else if (currentFilter === 'sin-aprobar') {
                // Filtrar registros atendidos sin aprobación
                data = data.filter(o => o.atendido === 'ATENDIDO' && (!o.aprobacion || o.aprobacion === ''));
            }

            // Aplicar filtro de fechas (usa fechaAtencion)
            if (fechaDesde) {
                const desde = new Date(fechaDesde + 'T00:00:00');
                data = data.filter(o => {
                    if (!o.fechaAtencion) return false;
                    const fechaOrden = new Date(o.fechaAtencion);
                    return fechaOrden >= desde;
                });
            }
            if (fechaHasta) {
                const hasta = new Date(fechaHasta + 'T23:59:59');
                data = data.filter(o => {
                    if (!o.fechaAtencion) return false;
                    const fechaOrden = new Date(o.fechaAtencion);
                    return fechaOrden <= hasta;
                });
            }

            // Aplicar búsqueda local
            const cedulasLista = parsearCedulas(busquedaActual);
            if (cedulasLista) {
                data = data.filter(o => cedulasLista.includes(o.numeroId));
            } else if (busquedaActual && busquedaActual.length >= 2) {
                const query = busquedaActual.toLowerCase();
                data = data.filter(o => {
                    const nombre = `${o.primerNombre || ''} ${o.segundoNombre || ''} ${o.primerApellido || ''} ${o.segundoApellido || ''}`.toLowerCase();
                    const cedula = (o.numeroId || '').toLowerCase();
                    return nombre.includes(query) || cedula.includes(query);
                });
            }

            // Ordenar por fecha de atención (más reciente primero)
            filteredData = data.sort((a, b) => {
                const fechaA = a.fechaAtencion ? new Date(a.fechaAtencion) : new Date(0);
                const fechaB = b.fechaAtencion ? new Date(b.fechaAtencion) : new Date(0);
                return fechaB - fechaA;
            });
            currentPage = 0;
            renderTabla();
        }

        // Detectar lista de cédulas (separadas por comas, saltos de línea, tabs o espacios)
        function parsearCedulas(texto) {
            if (!texto) return null;
            const tokens = texto.split(/[\n\r,\t\s]+/).map(t => t.trim()).filter(t => /^\d{5,}$/.test(t));
            return tokens.length >= 2 ? tokens : null;
        }

        // Búsqueda
        function procesarBusqueda(texto) {
            clearTimeout(searchTimeout);
            busquedaActual = texto.trim();

            const cedulas = parsearCedulas(busquedaActual);
            if (cedulas) {
                aplicarFiltros();
                return;
            }

            searchTimeout = setTimeout(() => {
                if (busquedaActual.length >= 2 || busquedaActual.length === 0) {
                    aplicarFiltros();
                }
            }, 300);
        }

        searchInput.addEventListener('input', (e) => procesarBusqueda(e.target.value));
        searchInput.addEventListener('paste', (e) => {
            setTimeout(() => procesarBusqueda(e.target.value), 0);
        });

        // Paginación
        btnPrev.addEventListener('click', () => goToPage(currentPage - 1));
        btnNext.addEventListener('click', () => goToPage(currentPage + 1));

        function goToPage(page) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (page < 0) page = 0;
            if (page >= totalPages) page = totalPages - 1;
            currentPage = page;
            renderTabla();
        }

        // Render
        function mostrarLoading() {
            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            tableContainer.style.display = 'none';
        }

        function mostrarEmpty() {
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
            tableCount.innerHTML = '<strong>0</strong> registros';
        }

        // Función para determinar exámenes faltantes
        function obtenerExamenesFaltantes(orden) {
            const faltantes = [];

            // Para SITEL, SIEMPRE incluir Prueba ADC por defecto
            if (codEmpresa === 'SITEL') {
                faltantes.push('PRUEBA ADC');
            }

            // Si no hay exámenes programados, retornar solo ADC para SITEL
            if (!orden.examenes) return faltantes;

            const examenesProgramados = orden.examenes.split(',').map(e => e.trim().toLowerCase());

            // Lista de exámenes a verificar (sin ADC ya que se agregó arriba para SITEL)
            const examenesMap = {
                'audiometría': ['audiometria', 'audiometría'],
                'visiometría': ['visiometria', 'visiometría'],
                'espirometría': ['espirometria', 'espirometría']
            };

            // Verificar cada tipo de examen
            for (const [nombre, keywords] of Object.entries(examenesMap)) {
                const estaProgramado = keywords.some(kw => examenesProgramados.some(ep => ep.includes(kw)));

                if (estaProgramado) {
                    // Aquí deberías verificar si el examen está completado
                    // Por ahora, lo agregamos como faltante (esto se puede mejorar con datos reales)
                    faltantes.push(nombre.toUpperCase());
                }
            }

            return faltantes;
        }

        // Función para formatear estado de aprobación
        function obtenerEstadoAprobacion(aprobacion) {
            if (!aprobacion || aprobacion === '') return 'Pendiente';
            if (aprobacion === 'NO APROBADO') return 'No Aprobado';
            if (aprobacion === 'APROBADO') return 'Aprobado';
            return aprobacion;
        }

        // Función para actualizar encabezados de tabla según empresa
        function actualizarEncabezadosTabla() {
            const headerRow = document.getElementById('tableHeaderRow');
            if (!headerRow) return;

            if (codEmpresa === 'SITEL') {
                // Encabezados para SITEL
                headerRow.innerHTML = `
                    <th style="width: 40px; text-align: center;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Seleccionar todos" style="cursor: pointer;">
                    </th>
                    <th>Paciente</th>
                    <th>Cédula</th>
                    <th>Centro de Costo</th>
                    <th>Fecha Programada</th>
                    <th>Fecha Consulta</th>
                    <th>Estado</th>
                    <th>Aprobación SST</th>
                    <th style="width: 50px; text-align: center;">Descargar</th>
                `;
            } else {
                // Encabezados normales
                headerRow.innerHTML = `
                    <th style="width: 40px; text-align: center;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Seleccionar todos" style="cursor: pointer;">
                    </th>
                    <th>Paciente</th>
                    <th>Cédula</th>
                    <th>Fecha Programada</th>
                    <th>Fecha Consulta</th>
                    <th>Estado</th>
                    <th style="width: 50px; text-align: center;">Descargar</th>
                `;
            }
        }

        function renderTabla() {
            if (filteredData.length === 0) {
                mostrarEmpty();
                return;
            }

            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            tableContainer.style.display = 'block';

            // Actualizar encabezados según empresa
            actualizarEncabezadosTabla();

            const totalPages = Math.ceil(filteredData.length / pageSize);
            const start = currentPage * pageSize;
            const end = Math.min(start + pageSize, filteredData.length);
            const pageData = filteredData.slice(start, end);

            tableCount.innerHTML = `<strong>${filteredData.length}</strong> registros`;

            // Renderizar filas según empresa
            if (codEmpresa === 'SITEL') {
                // Vista SITEL con columnas personalizadas
                tableBody.innerHTML = pageData.map(orden => {
                    const nombre = `${orden.primerNombre || ''} ${orden.segundoNombre || ''} ${orden.primerApellido || ''} ${orden.segundoApellido || ''}`.trim();
                    const cedula = orden.numeroId || '-';
                    const fechaConsulta = orden.fechaConsulta ? new Date(orden.fechaConsulta).toLocaleDateString('es-CO') : '-';

                    // Fecha programada con hora
                    let fechaProgramada = '-';
                    if (orden.fechaAtencion) {
                        const fecha = new Date(orden.fechaAtencion);
                        const fechaStr = fecha.toLocaleDateString('es-CO', { timeZone: 'America/Bogota' });
                        const horaStr = fecha.toLocaleTimeString('es-CO', {
                            timeZone: 'America/Bogota',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                        fechaProgramada = `${fechaStr} ${horaStr}`;
                    }

                    const initials = nombre.split(' ').slice(0, 2).map(n => n.charAt(0)).join('').toUpperCase() || '?';
                    const hasFoto = orden.foto_url ? 'has-photo' : '';

                    // Estado de atención
                    const estado = orden.atendido || 'PENDIENTE';
                    const statusClass = estado === 'ATENDIDO' ? 'atendido' : (estado === 'EN PROCESO' ? 'proceso' : 'pendiente');

                    // Obtener estado de aprobación
                    const estadoAprobacion = obtenerEstadoAprobacion(orden.aprobacion);
                    const aprobacionColor = estadoAprobacion === 'Aprobado' ? '#10B981' : (estadoAprobacion === 'No Aprobado' ? '#EF4444' : '#F59E0B');
                    const aprobacionBadge = `<span style="display: inline-block; padding: 6px 12px; background: ${aprobacionColor}20; color: ${aprobacionColor}; border-radius: 6px; font-size: 13px; font-weight: 600;">${estadoAprobacion}</span>`;

                    // Centro de costo
                    const centroCosto = orden.centro_de_costo || '-';

                    return `
                        <tr>
                            <td style="text-align: center;" onclick="event.stopPropagation();">
                                <input type="checkbox" class="orden-checkbox" data-id="${orden._id}" onchange="actualizarSeleccion()" style="cursor: pointer; width: 18px; height: 18px;">
                            </td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">
                                <div class="cell-name">
                                    <div class="avatar ${hasFoto}">${orden.foto_url ? `<img src="${orden.foto_url}" alt="">` : initials}</div>
                                    <div class="name-info">
                                        <span class="name-primary">${nombre || 'Sin nombre'}</span>
                                    </div>
                                </div>
                            </td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${cedula}</td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${centroCosto}</td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${fechaProgramada}</td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${fechaConsulta}</td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;"><span class="status-badge ${statusClass}"><span class="status-dot"></span>${estado}</span></td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${aprobacionBadge}</td>
                            <td style="text-align: center;" onclick="event.stopPropagation();">
                                ${tienePermiso('DESCARGAR_CERTIFICADO_TABLA') ? `
                                <button class="btn-icon-small" onclick="descargarCertificado('${orden._id}')" title="Descargar certificado" style="padding: 6px; border: none; background: #F3F4F6; border-radius: 6px; cursor: pointer;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                // Vista normal para otras empresas
                tableBody.innerHTML = pageData.map(orden => {
                    const nombre = `${orden.primerNombre || ''} ${orden.segundoNombre || ''} ${orden.primerApellido || ''} ${orden.segundoApellido || ''}`.trim();
                    const cedula = orden.numeroId || '-';
                    const fechaConsulta = orden.fechaConsulta ? new Date(orden.fechaConsulta).toLocaleDateString('es-CO') : '-';

                    // Fecha de atención con hora
                    let fechaAtencion = '-';
                    if (orden.fechaAtencion) {
                        const fecha = new Date(orden.fechaAtencion);
                        const fechaStr = fecha.toLocaleDateString('es-CO', { timeZone: 'America/Bogota' });
                        const horaStr = fecha.toLocaleTimeString('es-CO', {
                            timeZone: 'America/Bogota',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                        fechaAtencion = `${fechaStr} ${horaStr}`;
                    }

                    const estado = orden.atendido || 'PENDIENTE';
                    const statusClass = estado === 'ATENDIDO' ? 'atendido' : (estado === 'EN PROCESO' ? 'proceso' : 'pendiente');
                    const initials = nombre.split(' ').slice(0, 2).map(n => n.charAt(0)).join('').toUpperCase() || '?';
                    const hasFoto = orden.foto_url ? 'has-photo' : '';

                    return `
                        <tr>
                            <td style="text-align: center;" onclick="event.stopPropagation();">
                                <input type="checkbox" class="orden-checkbox" data-id="${orden._id}" onchange="actualizarSeleccion()" style="cursor: pointer; width: 18px; height: 18px;">
                            </td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">
                                <div class="cell-name">
                                    <div class="avatar ${hasFoto}">${orden.foto_url ? `<img src="${orden.foto_url}" alt="">` : initials}</div>
                                    <div class="name-info">
                                        <span class="name-primary">${nombre || 'Sin nombre'}</span>
                                    </div>
                                </div>
                            </td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${cedula}</td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${fechaAtencion}</td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;">${fechaConsulta}</td>
                            <td onclick="abrirModalDetalles('${orden._id}')" style="cursor: pointer;"><span class="status-badge ${statusClass}"><span class="status-dot"></span>${estado}</span></td>
                            <td style="text-align: center;" onclick="event.stopPropagation();">
                                ${tienePermiso('DESCARGAR_CERTIFICADO_TABLA') ? `
                                <button class="btn-icon-small" onclick="descargarCertificado('${orden._id}')" title="Descargar certificado" style="padding: 6px; border: none; background: #F3F4F6; border-radius: 6px; cursor: pointer;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Render mobile cards
            renderMobileCards(pageData);

            // Actualizar paginación
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                paginationInfo.textContent = `Página ${currentPage + 1} de ${totalPages}`;
                btnPrev.disabled = currentPage <= 0;
                btnNext.disabled = currentPage >= totalPages - 1;
            } else {
                pagination.style.display = 'none';
            }
        }

        // ========== SELECCIÓN Y DESCARGA DE CERTIFICADOS ==========
        let ordenesSeleccionadas = new Set();

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.orden-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    ordenesSeleccionadas.add(cb.dataset.id);
                } else {
                    ordenesSeleccionadas.delete(cb.dataset.id);
                }
            });
            actualizarUISeleccion();
        }

        function actualizarSeleccion() {
            ordenesSeleccionadas.clear();
            const checkboxes = document.querySelectorAll('.orden-checkbox:checked');
            checkboxes.forEach(cb => ordenesSeleccionadas.add(cb.dataset.id));

            // Actualizar el checkbox de "seleccionar todos"
            const allCheckboxes = document.querySelectorAll('.orden-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
                selectAllCheckbox.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
            }

            actualizarUISeleccion();
        }

        function actualizarUISeleccion() {
            const count = ordenesSeleccionadas.size;
            const selectionActions = document.getElementById('selectionActions');
            const selectedCount = document.getElementById('selectedCount');

            if (count > 0) {
                selectionActions.style.display = 'flex';
                selectedCount.textContent = count;
            } else {
                selectionActions.style.display = 'none';
            }
        }

        function limpiarSeleccion() {
            ordenesSeleccionadas.clear();
            document.querySelectorAll('.orden-checkbox').forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            actualizarUISeleccion();
        }

        function descargarCertificado(ordenId) {
            const url = `https://bsl-utilidades-yp78a.ondigitalocean.app/generar-certificado-desde-wix/${ordenId}`;
            window.open(url, '_blank');
        }

        async function descargarCertificadosSeleccionados() {
            if (ordenesSeleccionadas.size === 0) {
                alert('No hay órdenes seleccionadas');
                return;
            }

            const ids = Array.from(ordenesSeleccionadas);
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            const container = document.getElementById('download-frames-container');

            // Limpiar iframes anteriores
            container.innerHTML = '';

            btn.disabled = true;
            btn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle; animation: spin 1s linear infinite;">
                    <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
                </svg>
                Descargando 0/${ids.length}...
            `;

            for (let i = 0; i < ids.length; i++) {
                const ordenId = ids[i];
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle; animation: spin 1s linear infinite;">
                        <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
                    </svg>
                    Descargando ${i + 1}/${ids.length}...
                `;

                // Usar iframe oculto para evitar bloqueo de popups
                const url = `https://bsl-utilidades-yp78a.ondigitalocean.app/generar-certificado-desde-wix/${ordenId}`;
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = url;
                container.appendChild(iframe);

                // Esperar 5 segundos antes de la siguiente descarga (excepto en la última)
                if (i < ids.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }

            btn.disabled = false;
            btn.innerHTML = originalText;

            // Limpiar selección después de descargar
            limpiarSeleccion();

            alert(`Se han iniciado ${ids.length} descargas de certificados.\n\nEsto tomará varios minutos. Revisa tu carpeta de descargas.`);

            // Limpiar iframes después de un tiempo
            setTimeout(() => {
                container.innerHTML = '';
            }, 30000);
        }

        // ========== MOBILE CARDS ==========
        function renderMobileCards(ordenes) {
            const container = document.getElementById('mobileCards');
            if (!container) return;

            if (ordenes.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = ordenes.map(orden => {
                const nombre = `${orden.primerNombre || ''} ${orden.primerApellido || ''}`.trim();
                const isAtendido = orden.atendido === 'ATENDIDO';
                const initials = nombre.split(' ').slice(0, 2).map(n => n.charAt(0)).join('').toUpperCase() || '?';

                // Formatear fecha
                let fechaStr = '';
                if (orden.fechaAtencion) {
                    const fecha = new Date(orden.fechaAtencion);
                    fechaStr = fecha.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
                }

                // Status indicator
                const statusIndicator = isAtendido
                    ? `<span class="mobile-status-indicator atendido"><span class="mobile-status-dot"></span>Atendido</span>`
                    : `<span class="mobile-status-indicator pendiente"><span class="mobile-status-dot"></span>Pendiente</span>`;

                return `
                    <div class="mobile-card" onclick="abrirModalDetalles('${orden._id}')">
                        <div class="mobile-card-avatar">${initials}</div>
                        <div class="mobile-card-content">
                            <div class="mobile-card-title">${nombre || 'Sin nombre'}</div>
                            <div class="mobile-card-subtitle">
                                <span>${orden.cargo || 'Sin cargo'}</span>
                                <span class="dot"></span>
                                <span>${orden.numeroId || '—'}</span>
                            </div>
                        </div>
                        <div class="mobile-card-right">
                            <div class="mobile-card-time">${fechaStr}</div>
                            ${statusIndicator}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== MODAL DETALLES ==========
        async function abrirModalDetalles(id) {
            const paciente = allData.find(p => p._id === id) || filteredData.find(p => p._id === id);
            if (!paciente) return;

            pacienteActual = paciente;

            // Cargar estado de pruebas desde el backend
            let estadoPruebas = null;
            try {
                const estadoResponse = await fetch(`/api/estado-pruebas/${id}`);
                const estadoResult = await estadoResponse.json();
                if (estadoResult.success) {
                    estadoPruebas = estadoResult.data;
                }
            } catch (e) {
                console.log('No se pudo cargar estado de pruebas:', e);
            }
            const nombre = `${paciente.primerNombre || ''} ${paciente.segundoNombre || ''} ${paciente.primerApellido || ''} ${paciente.segundoApellido || ''}`.trim();
            const initials = nombre.split(' ').slice(0, 2).map(n => n.charAt(0)).join('').toUpperCase() || '?';
            const estado = paciente.atendido || 'PENDIENTE';
            const statusClass = estado === 'ATENDIDO' ? 'atendido' : 'pendiente';
            const hasFoto = paciente.foto_url ? 'has-photo' : '';

            const modalBody = document.getElementById('modalDetallesBody');
            modalBody.innerHTML = `
                <div class="profile-header-horizontal">
                    <div class="profile-photo ${hasFoto}">${paciente.foto_url ? `<img src="${paciente.foto_url}" alt="Foto">` : initials}</div>
                    <div class="profile-info">
                        <div class="profile-name">${nombre || 'Sin nombre'}</div>
                        <div class="profile-meta">CC: ${paciente.numeroId || '-'}</div>
                        <div class="profile-status ${statusClass}">
                            <span class="status-dot"></span>
                            ${estado}
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-title">Información Personal</div>
                    <div class="detail-grid">
                        <div class="detail-field">
                            <div class="detail-field-label">Celular</div>
                            <div class="detail-field-value">${paciente.celular || '-'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-field-label">Ciudad</div>
                            <div class="detail-field-value">${paciente.ciudad || '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-title">Información Laboral</div>
                    <div class="detail-grid">
                        <div class="detail-field">
                            <div class="detail-field-label">Empresa</div>
                            <div class="detail-field-value">${paciente.empresa || paciente.codEmpresa || '-'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-field-label">Cargo</div>
                            <div class="detail-field-value">${paciente.cargo || '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-title">Información del Examen</div>
                    <div class="detail-grid">
                        <div class="detail-field">
                            <div class="detail-field-label">Tipo de Examen</div>
                            <div class="detail-field-value">${paciente.tipoExamen || '-'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-field-label">Fecha y Hora de Atención</div>
                            <div class="detail-field-value">${paciente.fechaAtencion ? (() => {
                                const fecha = new Date(paciente.fechaAtencion);
                                const fechaStr = fecha.toLocaleDateString('es-CO', { timeZone: 'America/Bogota', day: '2-digit', month: '2-digit', year: 'numeric' });
                                const horaStr = fecha.toLocaleTimeString('es-CO', { timeZone: 'America/Bogota', hour: '2-digit', minute: '2-digit', hour12: true });
                                return fechaStr + ', ' + horaStr;
                            })() : '-'}</div>
                        </div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Exámenes</div>
                        <div class="detail-field-value">${paciente.examenes || '-'}</div>
                    </div>
                </div>

                ${estadoPruebas && estadoPruebas.pruebas ? (() => {
                    const p = estadoPruebas.pruebas;
                    const esKM2 = paciente.codEmpresa === 'KM2';

                    // Mapeo de nombre de prueba a tipo de prueba para el backend
                    const tiposPrueba = {
                        'Formulario': 'formulario',
                        'Pruebas ADC': 'adc',
                        'Audiometría': 'audiometria',
                        'Visual': 'visiometria',
                        'SCL-90': 'scl90'
                    };

                    // Definir orden de escalera: 1. Formulario, 2. ADC (excepto KM2), 3. Audiometría, 4. Visual
                    let ordenPruebas = [
                        { numero: 1, nombre: 'Formulario', key: 'formulario' },
                        { numero: 2, nombre: 'Pruebas ADC', key: 'adc' },
                        { numero: 3, nombre: 'Audiometría', key: 'audiometria' },
                        { numero: 4, nombre: 'Visual', key: 'visiometria' },
                        ...(p.scl90 && p.scl90.requerido ? [{ numero: 5, nombre: 'SCL-90', key: 'scl90' }] : [])
                    ];

                    // Si es SIIGO, quitar Pruebas ADC (usan SCL-90 en su lugar)
                    const esSIIGO = paciente.codEmpresa === 'SIIGO';
                    if (esSIIGO) {
                        ordenPruebas = ordenPruebas.filter(prueba => prueba.key !== 'adc');
                        ordenPruebas = ordenPruebas.map((prueba, index) => ({ ...prueba, numero: index + 1 }));
                    }

                    // Si es KM2, quitar Pruebas ADC del orden y agregar Psicológica si no tiene audiometría
                    if (esKM2) {
                        ordenPruebas = ordenPruebas.filter(prueba => prueba.key !== 'adc');

                        // Si no tiene audiometría completada, agregar prueba "Psicológica"
                        if (!p.audiometria.completado) {
                            ordenPruebas.push({
                                numero: 2,
                                nombre: 'Psicológica',
                                key: 'psicologica',
                                urlKM2: `https://www.bsl.com.co/km2/${paciente.numeroId}`
                            });
                        }

                        // Renumerar después de filtrar/agregar
                        ordenPruebas = ordenPruebas.map((prueba, index) => ({
                            ...prueba,
                            numero: index + 1
                        }));
                    }

                    let tagsCompletados = [];
                    let tagsPendientes = [];

                    // Procesar pruebas en orden de escalera
                    ordenPruebas.forEach(prueba => {
                        // Para KM2, la prueba psicológica es un link externo, siempre pendiente si está en la lista
                        if (prueba.key === 'psicologica') {
                            tagsPendientes.push({ ...prueba });
                        } else if (p[prueba.key].completado) {
                            tagsCompletados.push({ ...prueba });
                        } else if (p[prueba.key].requerido) {
                            tagsPendientes.push({ ...prueba });
                        }
                    });

                    const tagsCompletadosHTML = tagsCompletados.map(prueba =>
                        `<span style="display: inline-block; padding: 6px 12px; background: #D1FAE5; color: #065F46; border-radius: 6px; font-size: 13px; margin: 4px;">${prueba.numero}. ${prueba.nombre} ✓</span>`
                    ).join('');

                    // Si el codEmpresa es Sitel, hacer clickeable SOLO la primera prueba pendiente (la siguiente en la escalera)
                    const esSitel = paciente.codEmpresa && paciente.codEmpresa.toUpperCase() === 'SITEL';
                    const ordenId = paciente._id;
                    const tagsPendientesHTML = tagsPendientes.map((prueba, index) => {
                        const esPrimeraPendiente = index === 0; // Solo la primera pendiente es clickeable

                        // Para KM2: Prueba Psicológica es un link externo clickeable
                        if (esKM2 && prueba.key === 'psicologica') {
                            return `<a href="${prueba.urlKM2}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #FEF3C7; color: #92400E; border-radius: 6px; font-size: 13px; margin: 4px; cursor: pointer; transition: all 0.2s; text-decoration: none;" onmouseover="this.style.background='#FDE68A'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#FEF3C7'; this.style.transform='translateY(0)'">${prueba.numero}. ${prueba.nombre} ⚠️</a>`;
                        }

                        if (esSitel && esPrimeraPendiente) {
                            // Primera pendiente: clickeable con cursor pointer y hover
                            return `<span class="prueba-tag-pendiente" data-tipo="${tiposPrueba[prueba.nombre]}" data-orden="${ordenId}" onclick="enviarLinkPrueba(this)" style="display: inline-block; padding: 6px 12px; background: #FEF3C7; color: #92400E; border-radius: 6px; font-size: 13px; margin: 4px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#FDE68A'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#FEF3C7'; this.style.transform='translateY(0)'">${prueba.numero}. ${prueba.nombre} ⚠️</span>`;
                        } else {
                            // Resto de pendientes: visible pero no clickeable
                            return `<span style="display: inline-block; padding: 6px 12px; background: #FEF3C7; color: #92400E; border-radius: 6px; font-size: 13px; margin: 4px; opacity: 0.5; cursor: not-allowed;">${prueba.numero}. ${prueba.nombre} ⚠️</span>`;
                        }
                    }).join('');

                    const hintText = esSitel && tagsPendientes.length > 0
                        ? `<div class="detail-field-label" style="color: #F59E0B; margin-top: 12px;">Pendientes <span style="font-size: 11px; font-weight: 400; color: #6B7280;">(clic en la siguiente prueba para enviar link por WhatsApp)</span></div>`
                        : esKM2 && tagsPendientes.some(p => p.key === 'psicologica')
                        ? `<div class="detail-field-label" style="color: #F59E0B; margin-top: 12px;">Pendientes <span style="font-size: 11px; font-weight: 400; color: #6B7280;">(clic en Psicológica para ir a la prueba)</span></div>`
                        : `<div class="detail-field-label" style="color: #F59E0B; margin-top: 12px;">Pendientes</div>`;

                    return `
                    <div class="detail-card" style="background: #F9FAFB; border: 1px solid #E5E7EB;">
                        <div class="detail-card-title" style="color: #374151;">Estado de Pruebas</div>
                        <div class="detail-field">
                            ${tagsCompletados.length > 0 ? `
                            <div class="detail-field-label" style="color: #10B981;">Completados</div>
                            <div class="detail-field-value">${tagsCompletadosHTML}</div>
                            ` : ''}
                            ${tagsPendientes.length > 0 ? `
                            ${hintText}
                            <div class="detail-field-value">${tagsPendientesHTML}</div>
                            ` : ''}
                            ${tagsCompletados.length === 0 && tagsPendientes.length === 0 ? `
                            <div class="detail-field-value" style="color: #6B7280;">No hay pruebas registradas</div>
                            ` : ''}
                        </div>
                    </div>
                    `;
                })() : ''}

                ${(paciente.atendido === 'ATENDIDO' && tienePermiso('VER_RESULTADOS_MEDICOS')) ? `
                <div class="detail-card">
                    <div class="detail-card-title">Resultados Médicos</div>
                    <div class="detail-field">
                        <div class="detail-field-label">Concepto Médico Final</div>
                        <div class="detail-field-value">${paciente.mdConceptoFinal || '-'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Recomendaciones Médicas</div>
                        <div class="detail-field-value">${paciente.mdRecomendacionesMedicasAdicionales || '-'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Observaciones del Certificado</div>
                        <div class="detail-field-value">${paciente.mdObservacionesCertificado || '-'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Observaciones solo para la empresa</div>
                        <div class="detail-field-value">${paciente.mdObsParaMiDocYa || '-'}</div>
                    </div>
                </div>
                ` : ''}

                ${tienePermiso('APROBADOR') ? `
                <div class="detail-card" style="background: #F0F9FF; border: 2px solid #0EA5E9;">
                    <div class="detail-card-title" style="color: #0369A1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Pruebas Psicológicas
                    </div>
                    <div id="resultadosPruebas" style="display: flex; flex-direction: column; gap: 12px; padding: 12px 0;">
                        <div style="text-align: center; color: #64748B;">Cargando resultados...</div>
                    </div>
                </div>

                <div class="detail-card" style="background: #FEF2F2; border: 2px solid #EF4444;">
                    <div class="detail-card-title" style="color: #DC2626;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        Aprobación del Certificado
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px 0;">
                        <input type="checkbox" id="checkboxNoAprobar" style="width: 24px; height: 24px; cursor: pointer; accent-color: #DC2626;">
                        <label for="checkboxNoAprobar" style="font-size: 18px; font-weight: 600; color: #DC2626; cursor: pointer;">
                            NO APROBAR ESTE CERTIFICADO
                        </label>
                    </div>
                    <p style="font-size: 13px; color: #991B1B;">
                        Si marca esta casilla, el certificado será rechazado. De lo contrario, será aprobado automáticamente.
                    </p>
                </div>
                ` : ''}
            `;

            // Configurar botón PDF según permisos
            const btnPDF = document.getElementById('btnDescargarPDF');
            if (!tienePermiso('DESCARGAR_CERTIFICADO')) {
                btnPDF.style.display = 'none';
            } else if (estado === 'ATENDIDO') {
                btnPDF.style.display = 'inline-flex';
                btnPDF.href = `https://bsl-utilidades-yp78a.ondigitalocean.app/generar-certificado-desde-wix/${paciente._id}`;
                btnPDF.style.opacity = '1';
                btnPDF.style.pointerEvents = 'auto';
            } else {
                btnPDF.style.display = 'inline-flex';
                btnPDF.href = '#';
                btnPDF.style.opacity = '0.5';
                btnPDF.style.pointerEvents = 'none';
            }

            // Configurar botón Resultado Psicológico solo para KM2
            const btnResultadoPsicologico = document.getElementById('btnResultadoPsicologico');
            if (paciente.codEmpresa === 'KM2') {
                btnResultadoPsicologico.style.display = 'inline-flex';
                btnResultadoPsicologico.href = `https://www.bsl.com.co/km2-resultados/${paciente._id}`;
            } else {
                btnResultadoPsicologico.style.display = 'none';
            }

            // Configurar botón Ver SCL-90
            const btnVerScl90 = document.getElementById('btnVerScl90');
            if (btnVerScl90) {
                const tieneScl90 = estadoPruebas?.pruebas?.scl90?.completado;
                btnVerScl90.style.display = tieneScl90 ? 'inline-flex' : 'none';
            }

            // Configurar botón Editar según permisos
            const btnEditar = document.querySelector('.modal-footer .btn-secondary[onclick*="abrirModalEdicion"]');
            if (btnEditar) {
                btnEditar.style.display = tienePermiso('EDITAR_ORDEN') ? 'inline-flex' : 'none';
            }

            // Configurar botón Aprobar según permisos (solo para APROBADOR)
            const btnAprobar = document.getElementById('btnAprobar');
            if (btnAprobar) {
                btnAprobar.style.display = tienePermiso('APROBADOR') ? 'inline-flex' : 'none';
            }

            document.getElementById('modalDetalles').classList.add('active');

            // Establecer estado del checkbox de aprobación según el valor actual
            if (tienePermiso('APROBADOR')) {
                const checkboxNoAprobar = document.getElementById('checkboxNoAprobar');
                if (checkboxNoAprobar) {
                    // Si aprobacion === 'NO APROBADO', marcar el checkbox
                    checkboxNoAprobar.checked = paciente.aprobacion === 'NO APROBADO';
                }
            }

            // Cargar pruebas psicológicas para APROBADOR
            if (tienePermiso('APROBADOR') && paciente.numeroId) {
                cargarPruebasPsicologicas(paciente.numeroId);
            }
        }

        // ========== FUNCIÓN CARGAR PRUEBAS PSICOLÓGICAS ==========
        async function cargarPruebasPsicologicas(numeroId) {
            const container = document.getElementById('resultadosPruebas');
            if (!container) return;

            try {
                const response = await fetch(`/api/pruebas-psicologicas/${numeroId}`);
                const data = await response.json();

                if (data.success) {
                    const formatResultado = (resultado) => {
                        if (typeof resultado === 'string') {
                            return { valor: '-', interpretacion: resultado };
                        }
                        return resultado;
                    };

                    const ansiedad = formatResultado(data.ansiedad);
                    const depresion = formatResultado(data.depresion);
                    const congruencia = data.congruencia;

                    let congruenciaHTML = '';
                    if (congruencia && typeof congruencia === 'object' && congruencia !== 'NO REALIZÓ PRUEBA') {
                        congruenciaHTML = `
                            <div style="padding: 12px; background: #fff; border-radius: 8px;">
                                <div style="font-weight: 600; color: #334155; margin-bottom: 8px;">Congruencia</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                    <div>
                                        <span style="color: #64748B;">Familia:</span>
                                        <span style="font-weight: 600; color: #0369A1; margin-left: 4px;">${congruencia.CongruenciaFamilia || '-'}</span>
                                    </div>
                                    <div>
                                        <span style="color: #64748B;">Relación:</span>
                                        <span style="font-weight: 600; color: #0369A1; margin-left: 4px;">${congruencia.CongruenciaRelacion || '-'}</span>
                                    </div>
                                    <div>
                                        <span style="color: #64748B;">Autocuidado:</span>
                                        <span style="font-weight: 600; color: #0369A1; margin-left: 4px;">${congruencia.CongruenciaAutocuidado || '-'}</span>
                                    </div>
                                    <div>
                                        <span style="color: #64748B;">Ocupacional:</span>
                                        <span style="font-weight: 600; color: #0369A1; margin-left: 4px;">${congruencia.CongruenciaOcupacional || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; color: #334155;">Ansiedad</div>
                                <div style="font-size: 13px; color: #64748B;">${ansiedad.interpretacion || ansiedad}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 700; color: #0369A1;">${ansiedad.valor || '-'}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; color: #334155;">Depresión</div>
                                <div style="font-size: 13px; color: #64748B;">${depresion.interpretacion || depresion}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 700; color: #0369A1;">${depresion.valor || '-'}</div>
                        </div>
                        ${congruenciaHTML}
                    `;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #EF4444;">Error al cargar resultados</div>';
                }
            } catch (error) {
                console.error('Error cargando pruebas psicológicas:', error);
                container.innerHTML = '<div style="text-align: center; color: #EF4444;">Error de conexión</div>';
            }
        }

        // ========== FUNCIÓN APROBAR ORDEN ==========
        async function aprobarOrden() {
            if (!pacienteActual) return;
            if (!tienePermiso('APROBADOR')) {
                alert('No tienes permiso para aprobar órdenes');
                return;
            }

            const checkbox = document.getElementById('checkboxNoAprobar');
            const noAprobar = checkbox ? checkbox.checked : false;
            const valorAprobacion = noAprobar ? 'NO APROBADO' : 'APROBADO';

            const btn = document.getElementById('btnAprobar');
            btn.disabled = true;
            btn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                    <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
                </svg>
                Guardando...
            `;

            try {
                const response = await fetch(`/api/historia-clinica/${pacienteActual._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ aprobacion: valorAprobacion })
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModalDetalles();
                    actualizarDatos();
                    alert(`Certificado ${valorAprobacion.toLowerCase()} exitosamente`);
                } else {
                    alert('Error al guardar: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Guardar';
            }
        }

        function cerrarModalDetalles() {
            document.getElementById('modalDetalles').classList.remove('active');
            pacienteActual = null;
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalDetalles').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalDetalles();
            }
        });

        // ========== MODAL RESULTADOS SCL-90 ==========
        const nombresDimensiones = {
            SOM: "Somatizacion", OBS: "Obsesivo-Compulsivo", SI: "Sensibilidad Interpersonal",
            DEP: "Depresion", ANS: "Ansiedad", HOS: "Hostilidad",
            FOB: "Ansiedad Fobica", PAR: "Ideacion Paranoide", PSIC: "Psicoticismo"
        };

        const interpretacionesTexto = {
            SOM: { ALTO: "Alta presencia de sintomas somaticos.", MEDIO: "Presencia moderada de sintomas somaticos.", BAJO: "Baja presencia de sintomas somaticos." },
            OBS: { ALTO: "Alta presencia de sintomas obsesivo-compulsivos.", MEDIO: "Presencia moderada de sintomas obsesivo-compulsivos.", BAJO: "Baja presencia de sintomas obsesivo-compulsivos." },
            SI: { ALTO: "Alta sensibilidad interpersonal.", MEDIO: "Sensibilidad interpersonal moderada.", BAJO: "Baja sensibilidad interpersonal." },
            DEP: { ALTO: "Alta presencia de sintomas depresivos.", MEDIO: "Presencia moderada de sintomas depresivos.", BAJO: "Baja presencia de sintomas depresivos." },
            ANS: { ALTO: "Alta presencia de ansiedad.", MEDIO: "Ansiedad moderada.", BAJO: "Baja ansiedad." },
            HOS: { ALTO: "Alta hostilidad o irritabilidad.", MEDIO: "Hostilidad moderada.", BAJO: "Baja hostilidad." },
            FOB: { ALTO: "Alta fobia o evitacion.", MEDIO: "Fobia moderada.", BAJO: "Baja fobia." },
            PAR: { ALTO: "Alta ideacion paranoide.", MEDIO: "Ideacion paranoide moderada.", BAJO: "Baja ideacion paranoide." },
            PSIC: { ALTO: "Alta sintomatologia psicotica.", MEDIO: "Sintomatologia psicotica moderada.", BAJO: "Baja sintomatologia psicotica." }
        };

        function interpretarGSI(v) { return v < 0.5 ? "Muy bajo" : v < 1 ? "Leve" : v < 1.3 ? "Moderado" : v < 1.7 ? "Clinico alto" : "Muy elevado"; }
        function interpretarPST(v) { return v < 30 ? "Pocos sintomas" : v < 50 ? "Moderado" : v < 65 ? "Muchos" : "Extensa carga de sintomas"; }
        function interpretarPSDI(v) { return v < 1 ? "Baja intensidad" : v < 1.5 ? "Moderada" : v < 2 ? "Moderada-alta" : "Alta intensidad"; }

        function categoriaClass(cat) {
            if (cat === 'BAJO') return 'scl90-cat-bajo';
            if (cat === 'MEDIO') return 'scl90-cat-medio';
            return 'scl90-cat-alto';
        }

        async function abrirModalScl90() {
            if (!pacienteActual) return;
            const ordenId = pacienteActual._id;
            const body = document.getElementById('modalScl90Body');
            body.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-tertiary);">Cargando resultados...</div>';
            document.getElementById('modalScl90').classList.add('active');

            try {
                const response = await fetch(`/api/scl90/${ordenId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();

                if (!result.success || !result.data || !result.data.resultado) {
                    body.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-tertiary);">No hay resultados SCL-90 para esta orden.</div>';
                    return;
                }

                const data = result.data;
                const res = data.resultado;
                const interp = data.interpretacion;
                const bar = data.baremos;
                const dims = ["SOM", "OBS", "SI", "DEP", "ANS", "HOS", "FOB", "PAR", "PSIC"];

                // Tabla de interpretación clínica
                const filasHTML = dims.map(dim => {
                    const cat = interp[dim] || 'BAJO';
                    const texto = interpretacionesTexto[dim]?.[cat] || '';
                    return `<tr>
                        <td>${nombresDimensiones[dim]}</td>
                        <td>${res[dim] ?? '-'}</td>
                        <td>${bar[dim]?.Pc50 ?? '-'}</td>
                        <td>${bar[dim]?.Pc85 ?? '-'}</td>
                        <td><span class="${categoriaClass(cat)}">${cat}</span></td>
                        <td style="text-align:left; font-size:12px;">${texto}</td>
                    </tr>`;
                }).join('');

                // Tabla de índices globales
                const globalesHTML = `
                    <tr>
                        <td>Indice Global de Severidad (GSI)</td>
                        <td>${res.GSI ?? '-'}</td>
                        <td>${interpretarGSI(res.GSI)}</td>
                    </tr>
                    <tr>
                        <td>Total de Sintomas Positivos (PST)</td>
                        <td>${res.PST ?? '-'}</td>
                        <td>${interpretarPST(res.PST)}</td>
                    </tr>
                    <tr>
                        <td>Densidad de Sintomas Positivos (PSDI)</td>
                        <td>${res.PSDI ?? '-'}</td>
                        <td>${interpretarPSDI(res.PSDI)}</td>
                    </tr>
                `;

                body.innerHTML = `
                    <div class="detail-card">
                        <div class="detail-card-title" style="margin-bottom:12px;">Interpretacion clinica</div>
                        <div style="overflow-x:auto;">
                            <table class="scl90-table">
                                <thead>
                                    <tr>
                                        <th>Dimension</th>
                                        <th>Puntaje</th>
                                        <th>Pc50</th>
                                        <th>Pc85</th>
                                        <th>Categoria</th>
                                        <th>Interpretacion</th>
                                    </tr>
                                </thead>
                                <tbody>${filasHTML}</tbody>
                            </table>
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-title" style="margin-bottom:12px;">Indices globales</div>
                        <div style="overflow-x:auto;">
                            <table class="scl90-table">
                                <thead>
                                    <tr>
                                        <th>Indice</th>
                                        <th>Valor</th>
                                        <th>Interpretacion</th>
                                    </tr>
                                </thead>
                                <tbody>${globalesHTML}</tbody>
                            </table>
                        </div>
                    </div>

                    <div style="text-align:center; padding:8px; font-size:11px; color:var(--text-tertiary);">
                        Genero: ${data.genero || 'N/A'} | Baremos oficiales Colombia | Fecha: ${new Date(data.created_at).toLocaleDateString('es-CO')}
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando SCL-90:', error);
                body.innerHTML = '<div style="text-align:center; padding:40px; color:#DC2626;">Error al cargar los resultados.</div>';
            }
        }

        function cerrarModalScl90() {
            document.getElementById('modalScl90').classList.remove('active');
        }

        document.getElementById('modalScl90').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalScl90();
        });

        // ========== MODAL EDICIÓN ==========
        function abrirModalEdicion() {
            if (!pacienteActual) return;
            if (!tienePermiso('EDITAR_ORDEN')) {
                alert('No tienes permiso para editar órdenes');
                return;
            }

            // Llenar el formulario con los datos del paciente
            document.getElementById('edit-id').value = pacienteActual._id || '';
            document.getElementById('edit-primerNombre').value = pacienteActual.primerNombre || '';
            document.getElementById('edit-segundoNombre').value = pacienteActual.segundoNombre || '';
            document.getElementById('edit-primerApellido').value = pacienteActual.primerApellido || '';
            document.getElementById('edit-segundoApellido').value = pacienteActual.segundoApellido || '';
            document.getElementById('edit-numeroId').value = pacienteActual.numeroId || '';
            document.getElementById('edit-celular').value = pacienteActual.celular || '';
            document.getElementById('edit-ciudad').value = pacienteActual.ciudad || '';
            document.getElementById('edit-cargo').value = pacienteActual.cargo || '';
            document.getElementById('edit-tipoExamen').value = pacienteActual.tipoExamen || '';

            // Cargar exámenes seleccionados
            const examenesStr = pacienteActual.examenes || '';
            examenesSeleccionadosEdit = examenesStr.split(',').map(e => e.trim()).filter(e => e);
            cargarExamenesEdit();

            // Formatear fecha y verificar si ya pasó
            const inputFecha = document.getElementById('edit-fechaAtencion');
            const inputHora = document.getElementById('edit-horaAtencion');

            if (pacienteActual.fechaAtencion) {
                const fecha = new Date(pacienteActual.fechaAtencion);
                const year = fecha.getFullYear();
                const month = String(fecha.getMonth() + 1).padStart(2, '0');
                const day = String(fecha.getDate()).padStart(2, '0');
                inputFecha.value = `${year}-${month}-${day}`;

                // Deshabilitar si la fecha ya pasó
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const fechaSinHora = new Date(year, fecha.getMonth(), parseInt(day));
                if (fechaSinHora < hoy) {
                    inputFecha.disabled = true;
                    inputHora.disabled = true;
                    inputFecha.title = 'No se puede editar una fecha de atención pasada';
                    inputHora.title = 'No se puede editar una fecha de atención pasada';
                } else {
                    inputFecha.disabled = false;
                    inputHora.disabled = false;
                    inputFecha.title = '';
                    inputHora.title = '';
                }
            } else {
                inputFecha.value = '';
                inputFecha.disabled = false;
                inputHora.disabled = false;
                inputFecha.title = '';
                inputHora.title = '';
            }

            inputHora.value = pacienteActual.horaAtencion || '';

            cerrarModalDetalles();
            document.getElementById('modalEdicion').classList.add('active');
        }

        function cerrarModalEdicion() {
            document.getElementById('modalEdicion').classList.remove('active');
        }

        async function guardarCambiosEdicion(event) {
            event.preventDefault();

            const btn = document.getElementById('btnGuardarEdicion');
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const ordenId = document.getElementById('edit-id').value;

            const datos = {
                primerNombre: capitalize(document.getElementById('edit-primerNombre').value),
                segundoNombre: document.getElementById('edit-segundoNombre').value.trim() ? capitalize(document.getElementById('edit-segundoNombre').value) : null,
                primerApellido: capitalize(document.getElementById('edit-primerApellido').value),
                segundoApellido: document.getElementById('edit-segundoApellido').value.trim() ? capitalize(document.getElementById('edit-segundoApellido').value) : null,
                celular: document.getElementById('edit-celular').value.trim(),
                ciudad: document.getElementById('edit-ciudad').value.trim(),
                cargo: document.getElementById('edit-cargo').value.trim(),
                tipoExamen: document.getElementById('edit-tipoExamen').value,
                examenes: examenesSeleccionadosEdit.join(', '),
                horaAtencion: document.getElementById('edit-horaAtencion').value
            };

            // Agregar fecha si está presente (formato datetime-local: YYYY-MM-DDTHH:MM)
            const fechaStr = document.getElementById('edit-fechaAtencion').value;
            if (fechaStr) {
                const horaStr = document.getElementById('edit-horaAtencion').value || '00:00';
                datos.fechaAtencion = `${fechaStr}T${horaStr}`;
            }

            try {
                const response = await fetch(`/api/historia-clinica/${ordenId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModalEdicion();
                    actualizarDatos();
                    alert('Orden actualizada exitosamente');
                } else {
                    alert('Error al actualizar: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Guardar Cambios';
            }
        }

        // Cerrar modal edición al hacer clic fuera
        document.getElementById('modalEdicion').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalEdicion();
            }
        });

        // ========== MODAL EDICIÓN - EXÁMENES ==========
        let examenesDataEdit = [];
        let examenesSeleccionadosEdit = [];

        async function cargarExamenesEdit() {
            try {
                const response = await fetch('/api/examenes');
                const data = await response.json();
                let examenes = data.filter(e => e.activo !== false);

                // Filtrar por configuración de empresa si existe
                if (configEmpresa && configEmpresa.examenes && configEmpresa.examenes.length > 0) {
                    examenes = examenes.filter(e => configEmpresa.examenes.includes(e.nombre));
                }

                examenesDataEdit = examenes;
                renderExamenesEdit();
            } catch (error) {
                console.error('Error al cargar exámenes:', error);
                document.getElementById('editExamenesContainer').innerHTML =
                    '<div style="padding: 14px; color: #EF4444; font-size: 14px;">Error al cargar exámenes</div>';
            }
        }

        function renderExamenesEdit() {
            const container = document.getElementById('editExamenesContainer');

            if (examenesDataEdit.length === 0) {
                container.innerHTML = '<div style="padding: 14px; color: var(--text-tertiary); font-size: 14px;">No hay exámenes disponibles</div>';
                return;
            }

            container.innerHTML = examenesDataEdit.map(examen => `
                <label class="examen-checkbox" onclick="toggleExamenEdit('${examen.nombre}')">
                    <input type="checkbox" id="edit-examen-${examen.id}" ${examenesSeleccionadosEdit.includes(examen.nombre) ? 'checked' : ''}>
                    <span>${examen.nombre}</span>
                </label>
            `).join('');
        }

        function toggleExamenEdit(nombre) {
            const index = examenesSeleccionadosEdit.indexOf(nombre);
            if (index === -1) {
                examenesSeleccionadosEdit.push(nombre);
            } else {
                examenesSeleccionadosEdit.splice(index, 1);
            }
            actualizarExamenesUIEdit();
        }

        function removeExamenEdit(nombre) {
            const index = examenesSeleccionadosEdit.indexOf(nombre);
            if (index !== -1) {
                examenesSeleccionadosEdit.splice(index, 1);
            }
            actualizarExamenesUIEdit();
        }

        function actualizarExamenesUIEdit() {
            examenesDataEdit.forEach(examen => {
                const checkbox = document.getElementById(`edit-examen-${examen.id}`);
                if (checkbox) {
                    checkbox.checked = examenesSeleccionadosEdit.includes(examen.nombre);
                }
            });

            const selectedContainer = document.getElementById('editExamenesSelected');
            selectedContainer.innerHTML = examenesSeleccionadosEdit.map(nombre => `
                <div class="selected-examen">
                    <span>${nombre}</span>
                    <button type="button" class="remove-examen" onclick="removeExamenEdit('${nombre}')">&times;</button>
                </div>
            `).join('');
        }

        // ========== MODAL NUEVA ORDEN ==========
        let modalidadActual = 'presencial';
        let examenesDataModal = [];
        let examenesSeleccionadosModal = [];
        let ordenExistenteActual = null;

        function abrirModalNuevaOrden() {
            if (!tienePermiso('CREAR_ORDEN')) {
                alert('No tienes permiso para crear órdenes');
                return;
            }
            document.getElementById('modalNuevaOrden').classList.add('active');
            document.getElementById('modalEmpresa').value = codEmpresa;
            modalidadActual = 'presencial';
            actualizarTabsModalidad();
            cargarExamenesModal();
            cargarCiudadesModal();
            cargarSubempresasModal();
            cargarCentrosCostoModal();
            cargarCargosModal();
            limpiarFormularioModal();
            document.getElementById('modalPaso1').style.display = 'block';
            document.getElementById('modalPaso2').style.display = 'none';
            document.getElementById('modalFooterPaso2').style.display = 'none';
        }

        // Cargar ciudades según configuración de empresa
        function cargarCiudadesModal() {
            const select = document.getElementById('modalCiudad');
            let ciudades = [];

            if (configEmpresa && configEmpresa.ciudades && configEmpresa.ciudades.length > 0) {
                ciudades = configEmpresa.ciudades;
            } else {
                // Lista por defecto de ciudades colombianas
                ciudades = [
                    'Bogotá', 'Medellín', 'Cali', 'Barranquilla', 'Cartagena',
                    'Cúcuta', 'Bucaramanga', 'Pereira', 'Santa Marta', 'Ibagué',
                    'Pasto', 'Manizales', 'Neiva', 'Villavicencio', 'Armenia',
                    'Valledupar', 'Montería', 'Sincelejo', 'Popayán', 'Floridablanca',
                    'Buenaventura', 'Soledad', 'Itagüí', 'Soacha', 'Bello',
                    'Palmira', 'Tunja', 'Girardot', 'Riohacha', 'Barrancabermeja',
                    'Dosquebradas', 'Envigado', 'Tuluá', 'Sogamoso', 'Duitama',
                    'Zipaquirá', 'Facatativá', 'Chía', 'Fusagasugá', 'Otro'
                ];
            }

            select.innerHTML = '<option value="">Seleccionar ciudad...</option>' +
                ciudades.map(ciudad => `<option value="${ciudad}">${ciudad}</option>`).join('');
        }

        // Cargar subempresas según configuración
        function cargarSubempresasModal() {
            const container = document.getElementById('subempresaContainer');
            if (!container) return;

            if (configEmpresa && configEmpresa.subempresas && configEmpresa.subempresas.length > 0) {
                container.style.display = 'block';
                const select = document.getElementById('modalSubempresa');
                select.innerHTML = '<option value="">Seleccionar subempresa...</option>' +
                    configEmpresa.subempresas.map(sub => `<option value="${sub}">${sub}</option>`).join('');
            } else {
                container.style.display = 'none';
            }
        }

        // Cargar centros de costo según configuración
        function cargarCentrosCostoModal() {
            const container = document.getElementById('centroCostoContainer');
            if (!container) return;

            if (configEmpresa && configEmpresa.centros_de_costo && configEmpresa.centros_de_costo.length > 0) {
                container.style.display = 'block';
                const select = document.getElementById('modalCentroCosto');
                select.innerHTML = '<option value="">Seleccionar centro de costo...</option>' +
                    configEmpresa.centros_de_costo.map(cc => `<option value="${cc}">${cc}</option>`).join('');
            } else {
                container.style.display = 'none';
            }
        }

        // Cargar cargos según configuración (dropdown o input de texto)
        function cargarCargosModal() {
            const container = document.getElementById('cargoContainer');
            if (!container) return;

            if (configEmpresa && configEmpresa.cargos && configEmpresa.cargos.length > 0) {
                // Reemplazar por select
                container.innerHTML = `
                    <label class="form-label">Cargo <span class="required">*</span></label>
                    <select class="form-select" id="modalCargo">
                        <option value="">Seleccionar cargo...</option>
                        ${configEmpresa.cargos.map(cargo => `<option value="${cargo}">${cargo}</option>`).join('')}
                    </select>
                `;
            } else {
                // Mantener como input de texto
                container.innerHTML = `
                    <label class="form-label">Cargo <span class="required">*</span></label>
                    <input type="text" class="form-input" id="modalCargo" placeholder="Cargo del trabajador">
                `;
            }
        }

        function cerrarModalNuevaOrden() {
            document.getElementById('modalNuevaOrden').classList.remove('active');
            ordenExistenteActual = null;
            ocultarAlertaModal();
        }

        function limpiarFormularioModal() {
            document.getElementById('modalNumeroId').value = '';
            document.getElementById('modalCelular').value = '';
            document.getElementById('modalPrimerNombre').value = '';
            document.getElementById('modalSegundoNombre').value = '';
            document.getElementById('modalPrimerApellido').value = '';
            document.getElementById('modalSegundoApellido').value = '';
            document.getElementById('modalCargo').value = '';
            document.getElementById('modalCiudad').value = '';
            document.getElementById('modalTipoExamen').value = '';
            const subempresaSelect = document.getElementById('modalSubempresa');
            if (subempresaSelect) subempresaSelect.value = '';
            const centroCostoSelect = document.getElementById('modalCentroCosto');
            if (centroCostoSelect) centroCostoSelect.value = '';
            const inputFecha = document.getElementById('modalFechaAtencion');
            inputFecha.value = '';
            document.getElementById('modalHoraAtencion').innerHTML = '<option value="">Primero seleccione fecha...</option>';
            examenesSeleccionadosModal = [];
            actualizarExamenesUIModal();
        }

        function cambiarModalidadOrden(modalidad) {
            modalidadActual = modalidad;
            actualizarTabsModalidad();
            if (document.getElementById('modalFechaAtencion').value) {
                validarYCargarTurnosDisponibles();
            }
        }

        function actualizarTabsModalidad() {
            document.querySelectorAll('.modalidad-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.modalidad === modalidadActual);
            });
        }

        function validarYCargarTurnosDisponibles() {
            const inputFecha = document.getElementById('modalFechaAtencion');
            const fecha = inputFecha.value;
            const select = document.getElementById('modalHoraAtencion');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero seleccione fecha...</option>';
                return;
            }

            // Verificar que la fecha esté completa y el año sea razonable (>= 2024)
            const match = fecha.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match || parseInt(match[1]) < 2024) {
                return; // Fecha incompleta o año inválido, esperar
            }

            // Validar que la fecha no sea pasada (timezone Colombia)
            const hoyColombia = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Bogota' });
            if (fecha < hoyColombia) {
                alert('No puedes seleccionar una fecha pasada');
                inputFecha.value = '';
                select.innerHTML = '<option value="">Selecciona una fecha válida</option>';
                return;
            }

            // Fecha válida, cargar turnos
            cargarTurnosDisponibles();
        }

        async function cargarTurnosDisponibles() {
            const inputFecha = document.getElementById('modalFechaAtencion');
            const fecha = inputFecha.value;
            const select = document.getElementById('modalHoraAtencion');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero seleccione fecha...</option>';
                return;
            }

            select.innerHTML = '<option value="">Cargando turnos disponibles...</option>';

            try {
                const response = await fetch(`/api/turnos-disponibles?fecha=${fecha}&modalidad=${modalidadActual}&codEmpresa=${encodeURIComponent(codEmpresa)}`);
                const result = await response.json();

                if (result.success && result.turnos && result.turnos.length > 0) {
                    select.innerHTML = '<option value="">Seleccionar hora...</option>';

                    result.turnos.forEach(turno => {
                        const [hora, minuto] = turno.hora.split(':').map(Number);
                        const hora12 = hora > 12 ? hora - 12 : (hora === 0 ? 12 : hora);
                        const ampm = hora >= 12 ? 'PM' : 'AM';
                        const texto = `${hora12}:${minuto.toString().padStart(2, '0')} ${ampm}`;

                        const option = document.createElement('option');
                        option.value = turno.hora;

                        if (turno.disponible) {
                            option.textContent = texto;
                        } else {
                            option.textContent = `${texto} (no disponible)`;
                            option.disabled = true;
                            option.style.color = 'var(--text-tertiary)';
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay turnos disponibles para este día</option>';
                }
            } catch (error) {
                console.error('Error al cargar turnos:', error);
                select.innerHTML = '<option value="">Error al cargar turnos</option>';
            }
        }

        async function cargarExamenesModal() {
            try {
                const response = await fetch('/api/examenes');
                const data = await response.json();
                let examenes = data.filter(e => e.activo !== false);

                // Filtrar por configuración de empresa si existe
                if (configEmpresa && configEmpresa.examenes && configEmpresa.examenes.length > 0) {
                    examenes = examenes.filter(e => configEmpresa.examenes.includes(e.nombre));
                }

                examenesDataModal = examenes;
                renderExamenesModal();
            } catch (error) {
                console.error('Error al cargar exámenes:', error);
                document.getElementById('modalExamenesContainer').innerHTML =
                    '<div style="padding: 14px; color: #EF4444; font-size: 14px;">Error al cargar exámenes</div>';
            }
        }

        function renderExamenesModal() {
            const container = document.getElementById('modalExamenesContainer');

            if (examenesDataModal.length === 0) {
                container.innerHTML = '<div style="padding: 14px; color: var(--text-tertiary); font-size: 14px;">No hay exámenes disponibles</div>';
                return;
            }

            container.innerHTML = examenesDataModal.map(examen => `
                <div class="examen-option" onclick="toggleExamenModal(${examen.id}, '${examen.nombre.replace(/'/g, "\\'")}')">
                    <input type="checkbox" id="modal-examen-${examen.id}" ${examenesSeleccionadosModal.includes(examen.nombre) ? 'checked' : ''}>
                    <label for="modal-examen-${examen.id}">${examen.nombre}</label>
                </div>
            `).join('');
        }

        function toggleExamenModal(id, nombre) {
            const index = examenesSeleccionadosModal.indexOf(nombre);
            if (index === -1) {
                examenesSeleccionadosModal.push(nombre);
            } else {
                examenesSeleccionadosModal.splice(index, 1);
            }
            actualizarExamenesUIModal();
        }

        function quitarExamenModal(nombre) {
            const index = examenesSeleccionadosModal.indexOf(nombre);
            if (index !== -1) {
                examenesSeleccionadosModal.splice(index, 1);
            }
            actualizarExamenesUIModal();
        }

        function actualizarExamenesUIModal() {
            examenesDataModal.forEach(examen => {
                const checkbox = document.getElementById(`modal-examen-${examen.id}`);
                if (checkbox) {
                    checkbox.checked = examenesSeleccionadosModal.includes(examen.nombre);
                }
            });

            const selectedContainer = document.getElementById('modalExamenesSelected');
            selectedContainer.innerHTML = examenesSeleccionadosModal.map(nombre => `
                <span class="examen-tag">
                    ${nombre}
                    <button type="button" onclick="quitarExamenModal('${nombre.replace(/'/g, "\\'")}')">&times;</button>
                </span>
            `).join('');
        }

        function mostrarAlertaModal(mensaje, tipo = 'error') {
            const alert = document.getElementById('modalAlert');
            alert.textContent = mensaje;
            alert.className = `modal-alert show ${tipo}`;
        }

        function ocultarAlertaModal() {
            document.getElementById('modalAlert').className = 'modal-alert';
        }

        async function crearOrdenEmpresa() {
            ocultarAlertaModal();

            const numeroId = document.getElementById('modalNumeroId').value.trim();
            const celular = document.getElementById('modalCelular').value.trim();
            const primerNombre = document.getElementById('modalPrimerNombre').value.trim();
            const primerApellido = document.getElementById('modalPrimerApellido').value.trim();
            const cargo = document.getElementById('modalCargo').value.trim();
            const ciudad = document.getElementById('modalCiudad').value.trim();
            const tipoExamen = document.getElementById('modalTipoExamen').value;
            const fechaAtencion = document.getElementById('modalFechaAtencion').value;
            const horaAtencion = document.getElementById('modalHoraAtencion').value;

            if (!numeroId || !celular || !primerNombre || !primerApellido || !cargo || !ciudad || !tipoExamen) {
                mostrarAlertaModal('Por favor complete todos los campos obligatorios');
                return;
            }

            if (examenesSeleccionadosModal.length === 0) {
                mostrarAlertaModal('Debe seleccionar al menos un examen médico');
                return;
            }

            if (!fechaAtencion || !horaAtencion) {
                mostrarAlertaModal('Debe seleccionar fecha y hora de atención');
                return;
            }

            const btn = document.getElementById('btnCrearOrden');
            btn.disabled = true;
            btn.textContent = 'Creando...';

            // Obtener subempresa si está configurada
            const subempresaSelect = document.getElementById('modalSubempresa');
            const subempresa = subempresaSelect && subempresaSelect.value ? subempresaSelect.value : null;

            // Obtener centro de costo si está configurado
            const centroCostoSelect = document.getElementById('modalCentroCosto');
            const centroDeCosto = centroCostoSelect && centroCostoSelect.value ? centroCostoSelect.value : null;

            const datos = {
                codEmpresa: codEmpresa,
                empresa: codEmpresa,
                numeroId: numeroId,
                celular: celular,
                primerNombre: capitalize(primerNombre),
                segundoNombre: document.getElementById('modalSegundoNombre').value.trim() ? capitalize(document.getElementById('modalSegundoNombre').value) : null,
                primerApellido: capitalize(primerApellido),
                segundoApellido: document.getElementById('modalSegundoApellido').value.trim() ? capitalize(document.getElementById('modalSegundoApellido').value) : null,
                cargo: cargo,
                ciudad: ciudad,
                subempresa: subempresa,
                centroDeCosto: centroDeCosto,
                tipoExamen: tipoExamen,
                fechaAtencion: fechaAtencion,
                horaAtencion: horaAtencion,
                examenes: examenesSeleccionadosModal.join(', '),
                atendido: 'PENDIENTE',
                asignarMedicoAuto: true,
                modalidad: modalidadActual
            };

            try {
                const response = await fetch('/api/ordenes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModalNuevaOrden();
                    actualizarDatos();
                    mostrarModalConfirmacion('Orden creada exitosamente');
                } else {
                    mostrarAlertaModal(result.message || 'Error al crear la orden');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlertaModal('Error de conexión. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Crear Orden';
            }
        }

        document.getElementById('modalNuevaOrden').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalNuevaOrden();
            }
        });

        // ========== FUNCIONES PARA VERIFICACIÓN DE DUPLICADOS ==========
        async function verificarDocumentoModal() {
            const numeroId = document.getElementById('modalNumeroId').value.trim();

            if (!numeroId) {
                mostrarAlertaModal('Por favor ingrese el número de documento');
                return;
            }

            const btn = document.getElementById('btnVerificarDocModal');
            btn.disabled = true;
            btn.textContent = 'Verificando...';
            ocultarAlertaModal();

            try {
                const response = await fetch(`/api/ordenes/verificar-duplicado/${encodeURIComponent(numeroId)}?codEmpresa=${encodeURIComponent(codEmpresa)}`);
                const result = await response.json();

                if (result.success && result.hayDuplicado) {
                    btn.disabled = false;
                    btn.textContent = 'Verificar y Continuar';

                    if (result.tipo === 'atendido') {
                        mostrarModalAtendido(result.ordenExistente);
                    } else if (result.tipo === 'expirado') {
                        mostrarModalExpirado(result.ordenExistente);
                    } else {
                        mostrarModalDuplicado(result.ordenExistente);
                    }
                } else {
                    mostrarPaso2Modal();
                }
            } catch (error) {
                console.error('Error al verificar:', error);
                mostrarAlertaModal('Error al verificar el documento. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verificar y Continuar';
            }
        }

        function mostrarPaso2Modal() {
            const numeroId = document.getElementById('modalNumeroId').value.trim();
            document.getElementById('modalNumeroIdDisplay').value = numeroId;
            document.getElementById('modalPaso1').style.display = 'none';
            document.getElementById('modalPaso2').style.display = 'block';
            document.getElementById('modalFooterPaso2').style.display = 'flex';
            ocultarAlertaModal();
        }

        function volverPaso1Modal() {
            document.getElementById('modalPaso1').style.display = 'block';
            document.getElementById('modalPaso2').style.display = 'none';
            document.getElementById('modalFooterPaso2').style.display = 'none';
            ocultarAlertaModal();
        }

        function mostrarModalDuplicado(ordenExistente) {
            ordenExistenteActual = ordenExistente;
            const fechaCreacion = new Date(ordenExistente.fechaCreacion).toLocaleDateString('es-CO', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            document.getElementById('ordenExistenteInfo').innerHTML = `
                <p style="margin: 4px 0;"><strong>Fecha de creación:</strong> ${fechaCreacion}</p>
            `;

            const mensajeFormulario = document.getElementById('mensajeFormulario');
            if (ordenExistente.tieneFormulario) {
                mensajeFormulario.innerHTML = 'Esta orden <strong>ya tiene</strong> un formulario médico completado.';
            } else {
                mensajeFormulario.innerHTML = 'Esta orden <strong>no tiene</strong> formulario médico completado aún.';
            }

            document.getElementById('modalDuplicado').classList.add('active');
        }

        function cerrarModalDuplicado() {
            document.getElementById('modalDuplicado').classList.remove('active');
        }

        function mostrarModalAtendido(ordenExistente) {
            ordenExistenteActual = ordenExistente;

            let fechaAtencionStr = 'No disponible';
            if (ordenExistente.fechaAtencion) {
                fechaAtencionStr = new Date(ordenExistente.fechaAtencion).toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            } else if (ordenExistente.fechaCreacion) {
                fechaAtencionStr = new Date(ordenExistente.fechaCreacion).toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            }

            document.getElementById('ordenAtendidaInfo').innerHTML = `
                <p style="margin: 4px 0;"><strong>Fecha de consulta:</strong> ${fechaAtencionStr}</p>
            `;

            document.getElementById('modalAtendido').classList.add('active');
        }

        function cerrarModalAtendido() {
            document.getElementById('modalAtendido').classList.remove('active');
        }

        let modalidadExpirado = 'presencial';

        function mostrarModalExpirado(ordenExistente) {
            ordenExistenteActual = ordenExistente;
            modalidadExpirado = 'presencial';

            let fechaAtencionStr = 'No disponible';
            if (ordenExistente.fechaAtencion) {
                fechaAtencionStr = new Date(ordenExistente.fechaAtencion).toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            }

            document.getElementById('ordenExpiradaInfo').innerHTML = `
                <p style="margin: 4px 0;"><strong>Fecha programada:</strong> <span style="color: #DC2626;">${fechaAtencionStr} (Expirada)</span></p>
            `;

            // Resetear controles
            actualizarTabsModalidadExpirado();
            document.getElementById('fechaExpirado').value = '';
            document.getElementById('horaExpirado').innerHTML = '<option value="">Primero selecciona una fecha</option>';

            document.getElementById('modalExpirado').classList.add('active');
        }

        function cerrarModalExpirado() {
            document.getElementById('modalExpirado').classList.remove('active');
        }

        // ========== MODAL CONFIRMACIÓN ==========
        function mostrarModalConfirmacion(mensaje = 'La orden ha sido creada exitosamente.') {
            document.getElementById('confirmacionMensaje').textContent = mensaje;
            document.getElementById('modalConfirmacion').style.display = 'flex';
        }

        function cerrarModalConfirmacion() {
            document.getElementById('modalConfirmacion').style.display = 'none';
        }

        function cambiarModalidadExpirado(modalidad) {
            modalidadExpirado = modalidad;
            actualizarTabsModalidadExpirado();
            // Si ya hay fecha seleccionada, recargar turnos
            if (document.getElementById('fechaExpirado').value) {
                validarYCargarTurnosExpirado();
            }
        }

        function actualizarTabsModalidadExpirado() {
            document.querySelectorAll('.modalidad-tab-expirado').forEach(tab => {
                const esActivo = tab.dataset.modalidad === modalidadExpirado;
                if (esActivo) {
                    tab.style.background = '#10B981';
                    tab.style.color = 'white';
                    tab.style.borderColor = '#10B981';
                } else {
                    tab.style.background = 'white';
                    tab.style.color = '#374151';
                    tab.style.borderColor = '#D1D5DB';
                }
            });
        }

        function validarYCargarTurnosExpirado() {
            const inputFecha = document.getElementById('fechaExpirado');
            const fecha = inputFecha.value;
            const select = document.getElementById('horaExpirado');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero selecciona una fecha</option>';
                return;
            }

            // Verificar que la fecha esté completa y el año sea razonable (>= 2024)
            const match = fecha.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match || parseInt(match[1]) < 2024) {
                return; // Fecha incompleta o año inválido, esperar
            }

            // Validar que la fecha no sea pasada (timezone Colombia)
            const hoyColombia = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Bogota' });
            if (fecha < hoyColombia) {
                alert('No puedes seleccionar una fecha pasada');
                inputFecha.value = '';
                select.innerHTML = '<option value="">Selecciona una fecha válida</option>';
                return;
            }

            // Fecha válida, cargar turnos
            cargarTurnosExpirado();
        }

        async function cargarTurnosExpirado() {
            const inputFecha = document.getElementById('fechaExpirado');
            const fecha = inputFecha.value;
            const select = document.getElementById('horaExpirado');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero selecciona una fecha</option>';
                return;
            }

            select.innerHTML = '<option value="">Cargando turnos disponibles...</option>';

            try {
                const response = await fetch(`/api/turnos-disponibles?fecha=${fecha}&modalidad=${modalidadExpirado}&codEmpresa=${encodeURIComponent(codEmpresa)}`);
                const result = await response.json();

                if (result.success && result.turnos && result.turnos.length > 0) {
                    select.innerHTML = '<option value="">Seleccionar hora...</option>';

                    result.turnos.forEach(turno => {
                        const [hora, minuto] = turno.hora.split(':').map(Number);
                        const hora12 = hora > 12 ? hora - 12 : (hora === 0 ? 12 : hora);
                        const ampm = hora >= 12 ? 'PM' : 'AM';
                        const texto = `${hora12}:${minuto.toString().padStart(2, '0')} ${ampm}`;

                        const option = document.createElement('option');
                        option.value = JSON.stringify({ hora: turno.hora, medico: turno.medico });

                        if (turno.disponible) {
                            option.textContent = texto;
                        } else {
                            option.textContent = `${texto} (no disponible)`;
                            option.disabled = true;
                            option.style.color = 'var(--text-tertiary)';
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay turnos disponibles para este día</option>';
                }
            } catch (error) {
                console.error('Error al cargar turnos:', error);
                select.innerHTML = '<option value="">Error al cargar turnos</option>';
            }
        }

        async function actualizarFechaYContinuar() {
            const fecha = document.getElementById('fechaExpirado').value;
            const turnoValue = document.getElementById('horaExpirado').value;

            if (!fecha || !turnoValue) {
                alert('Por favor selecciona una nueva fecha y hora');
                return;
            }

            let turnoData;
            try {
                turnoData = JSON.parse(turnoValue);
            } catch (e) {
                alert('Error al procesar el turno seleccionado');
                return;
            }

            const btn = document.getElementById('btnActualizarFecha');
            btn.disabled = true;
            btn.textContent = 'Actualizando...';

            try {
                const [year, month, day] = fecha.split('-').map(Number);
                const [hours, minutes] = turnoData.hora.split(':').map(Number);
                const fechaHora = new Date(year, month - 1, day, hours, minutes);

                const response = await fetch(`/api/ordenes/${ordenExistenteActual._id}/fecha-atencion`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fechaAtencion: fechaHora.toISOString(),
                        horaAtencion: turnoData.hora,
                        medico: turnoData.medico
                    })
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModalExpirado();
                    cerrarModalNuevaOrden();
                    const formUrl = `${window.location.origin}/?_id=${ordenExistenteActual._id}`;
                    window.open(formUrl, '_blank');
                    alert('Cita reagendada exitosamente. Se abrió el formulario en una nueva pestaña.');
                } else {
                    alert('Error al actualizar la fecha: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la fecha. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Reagendar y continuar';
            }
        }

        // Event listeners para botones del modal de duplicados
        document.getElementById('btnUsarExistente').addEventListener('click', () => {
            if (ordenExistenteActual) {
                const formUrl = `${window.location.origin}/?_id=${ordenExistenteActual._id}`;
                window.open(formUrl, '_blank');
                cerrarModalDuplicado();
                cerrarModalNuevaOrden();
                alert('Usando orden existente. Se abrió el formulario en una nueva pestaña.');
            }
        });

        document.getElementById('btnCrearNuevaModal').addEventListener('click', () => {
            cerrarModalDuplicado();
            mostrarPaso2Modal();
        });

        document.getElementById('modalDuplicado').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalDuplicado();
            }
        });

        document.getElementById('btnCrearNuevaAtendido').addEventListener('click', () => {
            cerrarModalAtendido();
            mostrarPaso2Modal();
        });

        document.getElementById('modalAtendido').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalAtendido();
            }
        });

        document.getElementById('btnCrearNuevaExpirado').addEventListener('click', () => {
            cerrarModalExpirado();
            mostrarPaso2Modal();
        });

        document.getElementById('modalExpirado').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalExpirado();
            }
        });

        // ==================== FUNCIONES SECCIÓN ESTADÍSTICAS ====================

        let estadisticasIsLoading = false;

        function estadisticasInicializar() {
            // Mostrar nombre de empresa
            const empresaNombreSpan = document.getElementById('estadisticasEmpresaNombre');
            if (empresaNombreSpan && codEmpresa) {
                empresaNombreSpan.textContent = codEmpresa;
            }
        }

        function estadisticasHandleKeyPress(event) {
            if (event.key === 'Enter' && !estadisticasIsLoading) {
                estadisticasEnviarPregunta();
            }
        }

        function estadisticasEnviarSugerencia(pregunta) {
            document.getElementById('estadisticasInputPregunta').value = pregunta;
            estadisticasEnviarPregunta();
        }

        async function estadisticasEnviarPregunta() {
            const input = document.getElementById('estadisticasInputPregunta');
            const pregunta = input.value.trim();

            if (!pregunta || estadisticasIsLoading) return;

            estadisticasIsLoading = true;

            // Ocultar sección de bienvenida y sugerencias después de la primera pregunta
            document.getElementById('estadisticasWelcomeSection').style.display = 'none';
            document.getElementById('estadisticasSuggestionsContainer').style.display = 'none';

            // Mostrar mensaje del usuario
            estadisticasAgregarMensaje(pregunta, 'user');
            input.value = '';

            // Mostrar indicador de carga
            const loadingId = estadisticasMostrarCargando();

            // Deshabilitar botón
            document.getElementById('estadisticasSendBtn').disabled = true;

            try {
                const response = await fetch('/api/estadisticas-ia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        codEmpresa: codEmpresa,
                        pregunta: pregunta
                    })
                });

                const result = await response.json();

                // Remover indicador de carga
                estadisticasRemoverCargando(loadingId);

                if (result.success) {
                    estadisticasAgregarMensaje(result.respuesta, 'ai');
                } else {
                    estadisticasAgregarMensaje('Lo siento, hubo un error al procesar tu consulta. Por favor intenta de nuevo.', 'ai');
                }

            } catch (error) {
                console.error('Error:', error);
                estadisticasRemoverCargando(loadingId);
                estadisticasAgregarMensaje('Lo siento, hubo un error de conexión. Por favor intenta de nuevo.', 'ai');
            }

            estadisticasIsLoading = false;
            document.getElementById('estadisticasSendBtn').disabled = false;
            input.focus();
        }

        function estadisticasAgregarMensaje(contenido, tipo) {
            const chatArea = document.getElementById('estadisticasChatArea');

            const messageDiv = document.createElement('div');
            messageDiv.className = `estadisticas-message estadisticas-message-${tipo}`;

            const avatar = tipo === 'user' ? '👤' : '🤖';

            // Formatear contenido para IA (convertir saltos de línea)
            let contenidoFormateado = contenido;
            if (tipo === 'ai') {
                contenidoFormateado = contenido
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => `<p>${line}</p>`)
                    .join('');
            }

            messageDiv.innerHTML = `
                <div class="estadisticas-message-avatar">${avatar}</div>
                <div class="estadisticas-message-content">${tipo === 'ai' ? contenidoFormateado : contenido}</div>
            `;

            chatArea.appendChild(messageDiv);

            // Scroll al final
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function estadisticasMostrarCargando() {
            const chatArea = document.getElementById('estadisticasChatArea');
            const loadingId = 'estadisticas-loading-' + Date.now();

            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'estadisticas-message estadisticas-message-ai';
            loadingDiv.innerHTML = `
                <div class="estadisticas-message-avatar">🤖</div>
                <div class="estadisticas-message-content">
                    <div class="estadisticas-loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            chatArea.appendChild(loadingDiv);
            loadingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });

            return loadingId;
        }

        function estadisticasRemoverCargando(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // ==================== FIN FUNCIONES SECCIÓN ESTADÍSTICAS ====================

        // ========== ENVIAR LINK PRUEBA POR WHATSAPP ==========
        async function enviarLinkPrueba(tagElement) {
            const tipoPrueba = tagElement.dataset.tipo;
            const ordenId = tagElement.dataset.orden;
            const nombrePrueba = tagElement.textContent;

            // Confirmación
            if (!confirm(`¿Enviar link de "${nombrePrueba.trim()}" por WhatsApp al paciente?`)) {
                return;
            }

            // Mostrar estado de carga en el tag
            const textoOriginal = tagElement.textContent;
            tagElement.textContent = 'Enviando...';
            tagElement.style.opacity = '0.6';
            tagElement.style.pointerEvents = 'none';

            try {
                const response = await fetch('/api/enviar-link-prueba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ordenId, tipoPrueba })
                });

                const result = await response.json();

                if (result.success) {
                    // Mostrar éxito temporalmente
                    tagElement.textContent = '✓ Enviado';
                    tagElement.style.background = '#D1FAE5';
                    tagElement.style.color = '#065F46';

                    setTimeout(() => {
                        tagElement.textContent = textoOriginal;
                        tagElement.style.background = '#FEF3C7';
                        tagElement.style.color = '#92400E';
                        tagElement.style.opacity = '1';
                        tagElement.style.pointerEvents = 'auto';
                    }, 2000);
                } else {
                    alert('Error: ' + (result.message || 'No se pudo enviar el mensaje'));
                    tagElement.textContent = textoOriginal;
                    tagElement.style.opacity = '1';
                    tagElement.style.pointerEvents = 'auto';
                }
            } catch (error) {
                console.error('Error enviando link:', error);
                alert('Error al enviar el mensaje. Intenta de nuevo.');
                tagElement.textContent = textoOriginal;
                tagElement.style.opacity = '1';
                tagElement.style.pointerEvents = 'auto';
            }
        }
    </script>

    <!-- Contenedor oculto para iframes de descarga -->
    <div id="download-frames-container" style="display: none;"></div>
</body>
</html>
