<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Empresas - BSL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #F3F3F3;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F3F3F3;
            --bg-input: #FFFFFF;
            --text-primary: #181818;
            --text-secondary: #444444;
            --text-tertiary: #706E6B;
            --border-color: #DDDBDA;
            --border-light: #E5E5E5;
            --accent-color: #0176D3;
            --accent-hover: #014486;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 2px 4px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --bg-tertiary: #374151;
            --bg-input: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --text-tertiary: #9CA3AF;
            --border-color: #374151;
            --border-light: #4B5563;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ========== LOGIN SCREEN ========== */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--bg-secondary);
        }

        .login-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 48px 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo img {
            max-height: 60px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 16px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 184, 230, 0.1);
        }

        .login-input::placeholder {
            text-transform: none;
            color: var(--text-tertiary);
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            background: var(--accent-hover);
        }

        .login-btn:disabled {
            background: #94A3B8;
            cursor: not-allowed;
        }

        .login-error {
            background: #FEF2F2;
            color: #DC2626;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* ========== PANEL SCREEN ========== */
        .panel-screen {
            display: none;
            min-height: 100vh;
        }

        .panel-screen.active {
            display: block;
        }

        /* ========== LAYOUT ========== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .sidebar-logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
            text-align: center;
        }

        .sidebar-logo img {
            max-width: 140px;
            height: auto;
        }

        .sidebar-nav {
            padding: 0 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 184, 230, 0.1);
            color: var(--accent-color);
        }

        [data-theme="dark"] .nav-item.active {
            background: rgba(0, 184, 230, 0.2);
            color: #60D9F7;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .empresa-name-topbar {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            padding: 6px 12px;
            background: rgba(0, 184, 230, 0.1);
            border-radius: 6px;
        }

        [data-theme="dark"] .empresa-name-topbar {
            background: rgba(0, 184, 230, 0.15);
        }

        /* Top Bar Fijo */
        .top-bar {
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            height: 64px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            z-index: 100;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .top-bar-search {
            position: relative;
            flex: 1;
            max-width: 600px;
        }

        .top-bar-search input {
            width: 100%;
            padding: 10px 16px 10px 42px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .top-bar-search input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 184, 230, 0.1);
            background: var(--bg-secondary);
        }

        .top-bar-search input::placeholder {
            color: var(--text-tertiary);
        }

        .top-bar-search svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            width: 18px;
            height: 18px;
            pointer-events: none;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }

        .theme-toggle span {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .btn-icon-top {
            background: var(--bg-tertiary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-icon-top:hover {
            background: var(--border-color);
        }

        .btn-icon-top svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
        }

        .btn-logout {
            background: #FEF2F2;
        }

        .btn-logout:hover {
            background: #FEE2E2;
        }

        .btn-logout svg {
            stroke: #DC2626;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 32px 40px;
            padding-top: 96px;
        }

        /* ========== HEADER ========== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .page-header-left h1 svg {
            width: 24px;
            height: 24px;
            stroke: var(--accent-color);
            color: var(--accent-color);
        }

        .page-header-left p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 34px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.1s ease;
            border: 1px solid transparent;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            line-height: 1.5;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #F3F3F3;
        }

        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ========== TABS & FILTERS ========== */
        .filters-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .stats-badge {
            padding: 10px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .stats-badge strong {
            color: var(--text-primary);
        }

        /* ========== TABLE ========== */
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s ease;
            cursor: pointer;
        }

        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tbody tr:active {
            background: var(--border-color);
        }

        .data-table td {
            padding: 16px;
            font-size: 14px;
            color: var(--text-primary);
            vertical-align: middle;
        }

        .cell-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar.has-photo {
            background: var(--bg-tertiary);
        }

        .name-info {
            display: flex;
            flex-direction: column;
        }

        .name-primary {
            font-weight: 600;
            color: var(--text-primary);
        }

        .name-secondary {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.atendido {
            background: #DCFCE7;
            color: #166534;
        }

        .status-badge.pendiente {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-badge.proceso {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Loading */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .pagination-btn {
            padding: 10px 16px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--border-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            padding: 0 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ========== MODAL DRAWER ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            justify-content: flex-end;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #F5F5F5;
            width: 100%;
            max-width: 480px;
            height: 100vh;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal.large,
        .modal.modal-large {
            max-width: 640px;
        }

        [data-theme="dark"] .modal {
            background: #1F2937;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: #F5F5F5;
            border-bottom: none;
            flex-shrink: 0;
        }

        [data-theme="dark"] .modal-header {
            background: #1F2937;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .btn-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-primary);
            transition: all 0.15s ease;
        }

        .btn-close:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .btn-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 0 24px 24px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin: 0 24px 24px;
            flex-shrink: 0;
        }

        .modal-footer .btn {
            padding: 10px 14px;
            font-size: 13px;
        }

        /* ========== DETAIL MODAL - Profile Style ========== */
        .profile-header-horizontal {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .profile-photo {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 600;
            flex-shrink: 0;
            overflow: hidden;
        }

        .profile-photo.has-photo {
            background: var(--bg-tertiary);
        }

        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .profile-meta {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .profile-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .profile-status.atendido {
            background: #ECFDF5;
            color: #059669;
        }

        .profile-status.pendiente {
            background: #FEF3C7;
            color: #D97706;
        }

        .detail-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .detail-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-field {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-field:last-child {
            border-bottom: none;
        }

        .detail-field-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            font-weight: 400;
        }

        .detail-field-value {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
            line-height: 1.5;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
        }

        .detail-grid .detail-field {
            padding: 12px 16px 12px 0;
        }

        .detail-grid .detail-field:nth-child(even) {
            padding-left: 16px;
            border-left: 1px solid var(--border-light);
        }

        /* ========== MODAL CENTRADO (Nueva Orden) ========== */
        .modal-overlay-center {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay-center.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-content .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-content .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--border-color);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
        }

        .modal-content .modal-body {
            padding: 24px;
        }

        .modal-content .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: var(--bg-secondary);
            margin: 0;
            border-radius: 0;
        }

        /* Form styles */
        .form-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-label .required {
            color: #EF4444;
            margin-left: 2px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--bg-secondary);
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 184, 230, 0.1);
        }

        .form-input:disabled,
        .form-select:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Modalidad tabs */
        .modalidad-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
        }

        .modalidad-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modalidad-tab:hover {
            color: var(--text-primary);
        }

        .modalidad-tab.active {
            background: var(--bg-secondary);
            color: var(--accent-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .modalidad-tab svg {
            width: 18px;
            height: 18px;
        }

        /* Exámenes multi-select */
        .examenes-container {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            max-height: 180px;
            overflow-y: auto;
            background: var(--bg-secondary);
        }

        .examen-option {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .examen-option:last-child {
            border-bottom: none;
        }

        .examen-option:hover {
            background: var(--bg-tertiary);
        }

        .examen-option input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .examen-option label {
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            flex: 1;
        }

        .examenes-selected {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .examen-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 184, 230, 0.1);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
        }

        .examen-tag button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 0;
            font-size: 16px;
            line-height: 1;
        }

        .btn-modal {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-modal-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-modal-secondary:hover {
            background: var(--border-color);
        }

        .btn-modal-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-modal-primary:hover {
            background: var(--accent-hover);
        }

        .btn-modal-primary:disabled {
            background: #94A3B8;
            cursor: not-allowed;
        }

        .info-tiempo {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Alert en modal */
        .modal-alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
            font-size: 14px;
        }

        .modal-alert.show {
            display: block;
        }

        .modal-alert.error {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FECACA;
        }

        .modal-alert.success {
            background: #ECFDF5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        /* ========== MOBILE STYLES ========== */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .top-bar {
                left: 0;
                padding: 0 16px;
                gap: 12px;
            }

            .top-bar-search {
                flex: 1;
                width: auto;
            }

            .theme-toggle span {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 20px 16px;
                padding-top: 84px;
            }
        }

        /* ========== MOBILE APP STYLE ========== */
        .mobile-cards {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                background: #F2F2F7;
            }

            .sidebar {
                display: none;
            }

            .top-bar {
                left: 0;
                padding: 0 16px;
                height: 56px;
            }

            .top-bar-search {
                max-width: 100%;
            }

            .top-bar-actions {
                gap: 8px;
            }

            .empresa-name-topbar {
                display: none;
            }

            .theme-toggle span {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
                padding-top: 72px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 16px;
            }

            .page-header-left h1 {
                font-size: 28px;
                font-weight: 700;
                letter-spacing: -0.5px;
            }

            .page-header-left p {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 12px;
                border-radius: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            .filters-bar {
                flex-direction: column;
                gap: 12px;
                background: white;
                padding: 16px;
                border-radius: 12px;
                margin-bottom: 16px;
            }

            .tabs {
                background: #E5E5EA;
                border-radius: 8px;
                padding: 2px;
                width: 100%;
            }

            .tab {
                flex: 1;
                border-radius: 6px;
                font-size: 13px;
                padding: 8px 12px;
            }

            .tab.active {
                background: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            .stats-badge {
                text-align: center;
                margin-left: 0;
                font-size: 13px;
            }

            /* Hide table on mobile */
            .table-container {
                display: none !important;
            }

            /* Mobile Cards estilo iOS */
            .mobile-cards {
                display: block;
                background: white;
                border-radius: 12px;
                overflow: hidden;
            }

            .mobile-card {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                border-bottom: 0.5px solid #C6C6C8;
                background: white;
                cursor: pointer;
                transition: background 0.15s ease;
                gap: 12px;
            }

            .mobile-card:last-child {
                border-bottom: none;
            }

            .mobile-card:active {
                background: #E5E5EA;
            }

            .mobile-card-avatar {
                width: 50px;
                height: 50px;
                border-radius: 8px;
                background: linear-gradient(135deg, #0099B2, #007A8C);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                font-weight: 600;
                flex-shrink: 0;
            }

            .mobile-card-content {
                flex: 1;
                min-width: 0;
            }

            .mobile-card-title {
                font-size: 17px;
                font-weight: 600;
                color: #000;
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .mobile-card-subtitle {
                font-size: 15px;
                color: #8E8E93;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .mobile-card-subtitle .dot {
                width: 3px;
                height: 3px;
                background: #8E8E93;
                border-radius: 50%;
            }

            .mobile-card-right {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 6px;
                flex-shrink: 0;
            }

            .mobile-card-time {
                font-size: 13px;
                color: #8E8E93;
            }

            .mobile-status-indicator {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                font-size: 13px;
                font-weight: 500;
            }

            .mobile-status-indicator.atendido {
                color: #34C759;
            }

            .mobile-status-indicator.pendiente {
                color: #FF9500;
            }

            .mobile-status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: currentColor;
            }

            /* Estados vacío y cargando */
            .loading-state, .empty-state {
                background: white;
                border-radius: 12px;
                padding: 40px 20px;
            }

            /* Modal estilo iOS */
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }

            .modal {
                max-width: 100%;
                border-radius: 12px 12px 0 0;
                max-height: 90vh;
                animation: modalSlideUp 0.3s ease-out;
            }

            @keyframes modalSlideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            .modal-header {
                padding: 16px;
                border-bottom: 0.5px solid #C6C6C8;
            }

            .modal-body {
                padding: 16px;
                max-height: calc(90vh - 120px);
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-footer {
                padding: 16px;
                gap: 8px;
                flex-wrap: wrap;
            }

            .modal-footer .btn {
                flex: 1;
                min-width: 0;
                font-size: 14px;
                padding: 12px 8px;
            }
        }

        /* Desktop: hide mobile cards */
        @media (min-width: 769px) {
            .mobile-cards {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen (solo se muestra si no está autenticado) -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <img src="/bsl-logo.png" alt="BSL">
            </div>
            <h1 class="login-title">Panel de Empresa</h1>
            <p class="login-subtitle">Verificando sesion...</p>

            <div class="login-error" id="loginError"></div>

            <a href="/login.html" class="login-btn" style="display: inline-block; text-align: center; text-decoration: none;">Iniciar Sesion</a>
            <p style="text-align: center; margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                No tienes cuenta? <a href="/registro.html" style="color: var(--accent-color);">Registrate</a>
            </p>
        </div>
    </div>

    <!-- Panel Screen -->
    <div class="panel-screen" id="panelScreen">
        <div class="app-container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/bsl-logo.png" alt="BSL - Bienestar & Salud Laboral">
                </div>
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item active" onclick="event.preventDefault()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        Órdenes
                    </a>
                    <a href="#" class="nav-item" onclick="abrirModalNuevaOrden(); event.preventDefault();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        Nueva Orden
                    </a>
                    <a href="estadisticas.html" class="nav-item" id="navPreguntaLoQueQuieras" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        Pregunta lo que quieras
                    </a>
                </nav>
            </aside>

            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-search">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Buscar por cédula o nombre...">
                </div>
                <div class="top-bar-actions">
                    <span class="empresa-name-topbar" id="empresaNameTopbar">EMPRESA</span>
                    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <span id="themeText">Dark</span>
                    </button>
                    <button class="btn-icon-top" onclick="actualizarDatos()" title="Actualizar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                    <a href="https://api.whatsapp.com/send?phone=573008021701&text=Hola.%20Requiero%20soporte%20con%20el%20panel%20de%20empresa" target="_blank" class="btn-icon-top" title="Soporte WhatsApp">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </a>
                    <button class="btn-icon-top btn-logout" onclick="cerrarSesion()" title="Cerrar sesión">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <main class="main-content">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Órdenes
                        </h1>
                        <p>Gestión de órdenes médicas</p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statProgramadosHoy">0</div>
                        <div class="stat-label">Programados Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statAtendidosHoy">0</div>
                        <div class="stat-label">Atendidos Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalOrdenes">0</div>
                        <div class="stat-label">Total Órdenes</div>
                    </div>
                    <div class="stat-card" id="statCargaCard" style="display: none;">
                        <div class="stat-value" id="statCargados">0</div>
                        <div class="stat-label" id="statCargaLabel">Cargados</div>
                    </div>
                </div>

                <!-- Filters Bar -->
                <div class="filters-bar">
                    <div class="tabs">
                        <button class="tab active" data-filter="todos">Todos</button>
                        <button class="tab" data-filter="atendido">Atendidos</button>
                        <button class="tab" data-filter="pendiente">Pendientes</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="date" id="fechaDesde" class="form-input" style="padding: 8px 12px; font-size: 13px; border-radius: 8px; width: auto;" title="Fecha desde">
                        <span style="color: var(--text-tertiary); font-size: 13px;">a</span>
                        <input type="date" id="fechaHasta" class="form-input" style="padding: 8px 12px; font-size: 13px; border-radius: 8px; width: auto;" title="Fecha hasta">
                        <button id="btnLimpiarFechas" onclick="limpiarFiltroFechas()" style="padding: 8px 12px; border: none; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--text-secondary);" title="Limpiar filtro de fechas">✕</button>
                    </div>
                    <div class="stats-badge" id="tableCount">
                        <strong>0</strong> registros
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Cargando órdenes...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    <p class="empty-state-title">No hay órdenes</p>
                    <p class="empty-state-text">No se encontraron órdenes para esta empresa</p>
                </div>

                <!-- Mobile Cards Container -->
                <div class="mobile-cards" id="mobileCards"></div>

                <!-- Table Container -->
                <div class="table-container" id="tableContainer" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Cédula</th>
                                <th>Fecha Consulta</th>
                                <th>Fecha Atención</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                    <div class="pagination" id="pagination" style="display: none;">
                        <button class="pagination-btn" id="btnPrev">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Anterior
                        </button>
                        <span class="pagination-info" id="paginationInfo">Página 1 de 1</span>
                        <button class="pagination-btn" id="btnNext">
                            Siguiente
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal: Ver Detalles -->
    <div id="modalDetalles" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Detalles del Paciente</h2>
                </div>
                <button class="btn-close" onclick="cerrarModalDetalles()">✕</button>
            </div>
            <div class="modal-body" id="modalDetallesBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="abrirModalEdicion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Editar
                </button>
                <a href="#" target="_blank" class="btn btn-primary" id="btnDescargarPDF">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Descargar PDF
                </a>
            </div>
        </div>
    </div>

    <!-- Modal Edición -->
    <div id="modalEdicion" class="modal-overlay">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 class="modal-title">Editar Orden</h2>
                <button class="btn-close" onclick="cerrarModalEdicion()">✕</button>
            </div>
            <div class="modal-body">
                <form id="formEdicion" onsubmit="guardarCambiosEdicion(event)">
                    <input type="hidden" id="edit-id">

                    <!-- Datos Personales -->
                    <div class="form-section-title">Datos Personales</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Nombre</label>
                            <input type="text" class="form-input" id="edit-primerNombre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Nombre</label>
                            <input type="text" class="form-input" id="edit-segundoNombre">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Apellido</label>
                            <input type="text" class="form-input" id="edit-primerApellido">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Apellido</label>
                            <input type="text" class="form-input" id="edit-segundoApellido">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cédula</label>
                            <input type="text" class="form-input" id="edit-numeroId" disabled style="background: var(--bg-tertiary);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Celular</label>
                            <input type="tel" class="form-input" id="edit-celular">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ciudad</label>
                            <select class="form-select" id="edit-ciudad">
                                <option value="">Seleccionar ciudad...</option>
                                <option value="Bogotá">Bogotá D.C.</option>
                                <option value="Medellín">Medellín</option>
                                <option value="Cali">Cali</option>
                                <option value="Barranquilla">Barranquilla</option>
                                <option value="Cartagena">Cartagena</option>
                                <option value="Cúcuta">Cúcuta</option>
                                <option value="Bucaramanga">Bucaramanga</option>
                                <option value="Pereira">Pereira</option>
                                <option value="Santa Marta">Santa Marta</option>
                                <option value="Ibagué">Ibagué</option>
                                <option value="Pasto">Pasto</option>
                                <option value="Manizales">Manizales</option>
                                <option value="Neiva">Neiva</option>
                                <option value="Villavicencio">Villavicencio</option>
                                <option value="Armenia">Armenia</option>
                                <option value="Valledupar">Valledupar</option>
                                <option value="Montería">Montería</option>
                                <option value="Sincelejo">Sincelejo</option>
                                <option value="Popayán">Popayán</option>
                                <option value="Floridablanca">Floridablanca</option>
                                <option value="Buenaventura">Buenaventura</option>
                                <option value="Soledad">Soledad</option>
                                <option value="Itagüí">Itagüí</option>
                                <option value="Soacha">Soacha</option>
                                <option value="Bello">Bello</option>
                                <option value="Palmira">Palmira</option>
                                <option value="Tunja">Tunja</option>
                                <option value="Girardot">Girardot</option>
                                <option value="Riohacha">Riohacha</option>
                                <option value="Barrancabermeja">Barrancabermeja</option>
                                <option value="Dosquebradas">Dosquebradas</option>
                                <option value="Envigado">Envigado</option>
                                <option value="Tuluá">Tuluá</option>
                                <option value="Sogamoso">Sogamoso</option>
                                <option value="Duitama">Duitama</option>
                                <option value="Zipaquirá">Zipaquirá</option>
                                <option value="Facatativá">Facatativá</option>
                                <option value="Chía">Chía</option>
                                <option value="Fusagasugá">Fusagasugá</option>
                                <option value="Otro">Otra ciudad</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cargo</label>
                            <input type="text" class="form-input" id="edit-cargo">
                        </div>
                    </div>

                    <!-- Información del Examen -->
                    <div class="form-section-title" style="margin-top: 20px;">Información del Examen</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Examen</label>
                            <select class="form-select" id="edit-tipoExamen">
                                <option value="">Seleccionar...</option>
                                <option value="INGRESO">Ingreso</option>
                                <option value="PERIODICO">Periódico</option>
                                <option value="RETIRO">Retiro</option>
                                <option value="REUBICACION">Reubicación</option>
                                <option value="POST-INCAPACIDAD">Post-incapacidad</option>
                                <option value="SEGUIMIENTO OCUPACIONAL">Seguimiento Ocupacional</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Atención</label>
                            <input type="date" class="form-input" id="edit-fechaAtencion">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Hora de Atención</label>
                            <input type="time" class="form-input" id="edit-horaAtencion">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exámenes</label>
                        <input type="text" class="form-input" id="edit-examenes">
                    </div>

                    <button type="submit" class="btn btn-primary" id="btnGuardarEdicion" style="width: 100%; margin-top: 20px;">
                        Guardar Cambios
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Orden -->
    <div class="modal-overlay-center" id="modalNuevaOrden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nueva Orden</h2>
                <button class="modal-close" onclick="cerrarModalNuevaOrden()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-alert" id="modalAlert"></div>

                <!-- PASO 1: Verificar Documento -->
                <div id="modalPaso1">
                    <div class="form-section-title">Paso 1: Verificar Documento</div>

                    <div class="form-group">
                        <label class="form-label">Número de Identificación <span class="required">*</span></label>
                        <input type="text" class="form-input" id="modalNumeroId" placeholder="Ingrese la cédula del paciente">
                    </div>

                    <button type="button" class="btn-modal btn-modal-primary" id="btnVerificarDocModal" onclick="verificarDocumentoModal()" style="width: 100%; margin-top: 16px;">Verificar y Continuar</button>
                </div>

                <!-- PASO 2: Resto del Formulario -->
                <div id="modalPaso2" style="display: none;">
                    <!-- Empresa (no editable) -->
                    <div class="form-group">
                        <label class="form-label">Empresa</label>
                        <input type="text" class="form-input" id="modalEmpresa" disabled>
                    </div>

                    <!-- Datos del Paciente -->
                    <div class="form-section-title">Datos del Paciente</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Número de Identificación</label>
                            <input type="text" class="form-input" id="modalNumeroIdDisplay" disabled style="background: var(--bg-tertiary);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Celular <span class="required">*</span></label>
                            <input type="tel" class="form-input" id="modalCelular" placeholder="Número de celular">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Nombre <span class="required">*</span></label>
                            <input type="text" class="form-input" id="modalPrimerNombre" placeholder="Primer nombre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Nombre</label>
                            <input type="text" class="form-input" id="modalSegundoNombre" placeholder="Segundo nombre">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primer Apellido <span class="required">*</span></label>
                            <input type="text" class="form-input" id="modalPrimerApellido" placeholder="Primer apellido">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segundo Apellido</label>
                            <input type="text" class="form-input" id="modalSegundoApellido" placeholder="Segundo apellido">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cargo <span class="required">*</span></label>
                            <input type="text" class="form-input" id="modalCargo" placeholder="Cargo del trabajador">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ciudad <span class="required">*</span></label>
                            <select class="form-select" id="modalCiudad">
                                <option value="">Seleccionar ciudad...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Subempresa (solo visible si la empresa tiene subempresas configuradas) -->
                    <div class="form-row" id="subempresaContainer" style="display: none;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Subempresa / Sede</label>
                            <select class="form-select" id="modalSubempresa">
                                <option value="">Seleccionar subempresa...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Datos del Examen -->
                    <div class="form-section-title">Datos del Examen</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Examen <span class="required">*</span></label>
                            <select class="form-select" id="modalTipoExamen">
                                <option value="">Seleccionar...</option>
                                <option value="INGRESO">Ingreso</option>
                                <option value="PERIODICO">Periódico</option>
                                <option value="RETIRO">Retiro</option>
                                <option value="REUBICACION">Reubicación</option>
                                <option value="POST-INCAPACIDAD">Post-incapacidad</option>
                            </select>
                        </div>
                    </div>

                    <!-- Modalidad tabs -->
                    <div class="form-group">
                        <label class="form-label">Modalidad</label>
                        <div class="modalidad-tabs">
                            <button type="button" class="modalidad-tab active" data-modalidad="presencial" onclick="cambiarModalidadOrden('presencial')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Presencial
                            </button>
                            <button type="button" class="modalidad-tab" data-modalidad="virtual" onclick="cambiarModalidadOrden('virtual')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                </svg>
                                Virtual
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Atención <span class="required">*</span></label>
                            <input type="date" class="form-input" id="modalFechaAtencion" onchange="validarYCargarTurnosDisponibles()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora de Atención <span class="required">*</span></label>
                            <select class="form-select" id="modalHoraAtencion">
                                <option value="">Primero seleccione fecha...</option>
                            </select>
                            <div class="info-tiempo" id="modalInfoTiempo">El sistema asignará automáticamente un médico disponible</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Exámenes</label>
                        <div class="examenes-container" id="modalExamenesContainer">
                            <div style="padding: 14px; color: var(--text-tertiary); font-size: 14px;">Cargando exámenes...</div>
                        </div>
                        <div class="examenes-selected" id="modalExamenesSelected"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="modalFooterPaso2" style="display: none;">
                <button type="button" class="btn-modal btn-modal-secondary" onclick="volverPaso1Modal()">← Volver</button>
                <button type="button" class="btn-modal btn-modal-primary" id="btnCrearOrden" onclick="crearOrdenEmpresa()">Crear Orden</button>
            </div>
        </div>
    </div>

    <!-- Modal de orden duplicada (PENDIENTE) -->
    <div class="modal-overlay-center" id="modalDuplicado">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 40px; height: 40px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2" width="20" height="20">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </span>
                    Orden existente
                </h2>
                <button class="modal-close" onclick="cerrarModalDuplicado()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Ya existe una orden <strong>pendiente</strong> para este número de documento.</p>
                <div id="ordenExistenteInfo" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px;"></div>
                <p id="mensajeFormulario" style="margin-top: 12px; font-size: 14px; color: var(--text-secondary);"></p>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button type="button" class="btn-modal btn-modal-primary" id="btnUsarExistente" style="width: 100%;">Usar orden existente</button>
                <button type="button" class="btn-modal" id="btnCrearNuevaModal" style="width: 100%; background: #F59E0B; color: white;">Crear nueva de todos modos</button>
                <button type="button" class="btn-modal btn-modal-secondary" onclick="cerrarModalDuplicado()" style="width: 100%;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de certificado existente (ATENDIDO) -->
    <div class="modal-overlay-center" id="modalAtendido">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 40px; height: 40px; background: #DBEAFE; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </span>
                    Certificado existente
                </h2>
                <button class="modal-close" onclick="cerrarModalAtendido()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Ya existe un <strong>certificado médico</strong> para este número de documento.</p>
                <div id="ordenAtendidaInfo" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px;"></div>
                <p style="margin-top: 12px; font-size: 14px; color: var(--text-secondary);">Si necesita crear una nueva orden, puede continuar.</p>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button type="button" class="btn-modal" id="btnCrearNuevaAtendido" style="width: 100%; background: #F59E0B; color: white;">Crear nueva orden</button>
                <button type="button" class="btn-modal btn-modal-secondary" onclick="cerrarModalAtendido()" style="width: 100%;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de cita expirada -->
    <div class="modal-overlay-center" id="modalExpirado">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 40px; height: 40px; background: #FEE2E2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                    </span>
                    Cita expirada
                </h2>
                <button class="modal-close" onclick="cerrarModalExpirado()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Tenía una cita programada pero la <strong>fecha ya pasó</strong>. Puede reagendar la cita.</p>
                <div id="ordenExpiradaInfo" style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 10px; padding: 16px; margin-bottom: 16px;"></div>

                <div style="background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 10px; padding: 16px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #166534; margin-bottom: 12px;">Nueva fecha y hora:</h4>

                    <!-- Tabs de modalidad -->
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Modalidad</label>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="modalidad-tab-expirado active" data-modalidad="presencial" onclick="cambiarModalidadExpirado('presencial')" style="flex: 1; padding: 10px; border: 1px solid #10B981; border-radius: 8px; background: #10B981; color: white; cursor: pointer; font-weight: 500;">
                                Presencial
                            </button>
                            <button type="button" class="modalidad-tab-expirado" data-modalidad="virtual" onclick="cambiarModalidadExpirado('virtual')" style="flex: 1; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; background: white; color: #374151; cursor: pointer; font-weight: 500;">
                                Virtual
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Fecha</label>
                        <input type="date" id="fechaExpirado" onchange="validarYCargarTurnosExpirado()" class="form-input" style="width: 100%; padding: 10px; border-radius: 8px;">
                    </div>

                    <div>
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Hora disponible</label>
                        <select id="horaExpirado" class="form-input" style="width: 100%; padding: 10px; border-radius: 8px;">
                            <option value="">Primero selecciona una fecha</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button type="button" class="btn-modal" id="btnActualizarFecha" onclick="actualizarFechaYContinuar()" style="width: 100%; background: #10B981; color: white;">Reagendar y continuar</button>
                <button type="button" class="btn-modal" id="btnCrearNuevaExpirado" style="width: 100%; background: #F59E0B; color: white;">Crear nueva orden</button>
                <button type="button" class="btn-modal btn-modal-secondary" onclick="cerrarModalExpirado()" style="width: 100%;">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let codEmpresa = '';
        let usuarioActual = null;
        let permisosUsuario = []; // Permisos cargados del servidor
        let configEmpresa = null; // Configuración de ciudades, exámenes y subempresas
        let allData = [];
        let filteredData = [];
        let currentPage = 0;
        const pageSize = 10;
        let searchTimeout = null;
        let busquedaActual = '';
        let currentFilter = 'todos';
        let pacienteActual = null;
        let fechaDesde = '';
        let fechaHasta = '';

        // Función para capitalizar (primera letra mayúscula de cada palabra)
        function capitalize(str) {
            if (!str) return str;
            return str.trim().toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        }

        // Elementos del DOM
        const loginScreen = document.getElementById('loginScreen');
        const panelScreen = document.getElementById('panelScreen');
        const loginError = document.getElementById('loginError');
        const searchInput = document.getElementById('searchInput');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const pagination = document.getElementById('pagination');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const paginationInfo = document.getElementById('paginationInfo');
        const tableCount = document.getElementById('tableCount');

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
                text.textContent = 'Light';
            } else {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                text.textContent = 'Dark';
            }
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // Función para verificar si tiene un permiso
        function tienePermiso(permiso) {
            return permisosUsuario.includes(permiso);
        }

        // Cargar permisos del usuario
        async function cargarPermisos() {
            try {
                const response = await Auth.fetchAuth('/api/auth/mis-permisos');
                if (response && response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        permisosUsuario = data.permisos || [];
                    }
                }
            } catch (error) {
                console.error('Error cargando permisos:', error);
                permisosUsuario = [];
            }
        }

        // Cargar configuración de la empresa (ciudades, exámenes, subempresas)
        async function cargarConfigEmpresa() {
            if (!codEmpresa) return;
            try {
                const response = await fetch(`/api/empresas/codigo/${encodeURIComponent(codEmpresa)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        configEmpresa = data.data;
                        console.log('Configuración de empresa cargada:', configEmpresa);
                    }
                }
            } catch (error) {
                console.error('Error cargando configuración de empresa:', error);
                configEmpresa = null;
            }
        }

        // Aplicar permisos a la UI
        function aplicarPermisosUI() {
            // VER_ORDENES - Si no tiene permiso, ocultar toda la sección de órdenes
            if (!tienePermiso('VER_ORDENES')) {
                const dataSection = document.querySelector('.data-section');
                if (dataSection) dataSection.style.display = 'none';
            }

            // CREAR_ORDEN - Ocultar botón de nueva orden en sidebar
            if (!tienePermiso('CREAR_ORDEN')) {
                const navNuevaOrden = document.querySelector('.nav-item[onclick*="abrirModalNuevaOrden"]');
                if (navNuevaOrden) navNuevaOrden.style.display = 'none';
            }

            // VER_ESTADISTICAS - Ocultar tarjetas de estadísticas
            if (!tienePermiso('VER_ESTADISTICAS')) {
                const statsGrid = document.querySelector('.stats-grid');
                if (statsGrid) statsGrid.style.display = 'none';
            }
        }

        // Verificar sesión con JWT
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticación
            usuarioActual = await Auth.verificarSesion();

            if (usuarioActual) {
                // Usuario autenticado
                codEmpresa = usuarioActual.codEmpresa || '';

                // Si es admin sin codEmpresa, redirigir al panel admin
                if (usuarioActual.rol === 'admin' && !codEmpresa) {
                    window.location.href = '/panel-admin.html';
                    return;
                }

                // Cargar permisos y configuración de empresa antes de mostrar el panel
                await cargarPermisos();
                await cargarConfigEmpresa();
                mostrarPanel();
                aplicarPermisosUI();
            } else {
                // No autenticado - mostrar pantalla de login con opciones
                document.querySelector('.login-subtitle').textContent = 'Debes iniciar sesion para continuar';
            }

            // Tab filters
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    aplicarFiltros();
                });
            });

            // Filtros de fecha
            document.getElementById('fechaDesde').addEventListener('change', (e) => {
                fechaDesde = e.target.value;
                aplicarFiltros();
            });
            document.getElementById('fechaHasta').addEventListener('change', (e) => {
                fechaHasta = e.target.value;
                aplicarFiltros();
            });
        });

        function limpiarFiltroFechas() {
            fechaDesde = '';
            fechaHasta = '';
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            aplicarFiltros();
        }

        // Función para mostrar el panel (después de verificar autenticación)
        function mostrarPanel() {
            loginScreen.style.display = 'none';
            panelScreen.classList.add('active');
            document.getElementById('empresaNameTopbar').textContent = codEmpresa || usuarioActual?.email || 'Usuario';

            // Mostrar "Pregunta lo que quieras" solo para SANITHELP-JJ
            const navPregunta = document.getElementById('navPreguntaLoQueQuieras');
            if (navPregunta) {
                navPregunta.style.display = codEmpresa === 'SANITHELP-JJ' ? 'flex' : 'none';
            }

            actualizarDatos();
        }

        // Cerrar sesión usando Auth.js
        function cerrarSesion() {
            if (confirm('¿Cerrar sesión?')) {
                Auth.logout();
            }
        }

        // Cargar datos con paginación del servidor
        let totalOrdenes = 0;
        const LIMIT_POR_PAGINA = 5000; // Cargar en lotes

        async function actualizarDatos() {
            mostrarLoading();
            allData = [];

            try {
                // Primera carga: obtener stats y primera página
                const response = await fetch(`/api/ordenes?codEmpresa=${encodeURIComponent(codEmpresa)}&limit=${LIMIT_POR_PAGINA}&offset=0`);
                const result = await response.json();

                if (result.success) {
                    allData = result.data || [];
                    totalOrdenes = result.total || allData.length;

                    // Actualizar estadísticas desde el servidor
                    if (result.stats) {
                        document.getElementById('statProgramadosHoy').textContent = result.stats.programadosHoy;
                        document.getElementById('statAtendidosHoy').textContent = result.stats.atendidosHoy;
                    }
                    document.getElementById('statTotalOrdenes').textContent = totalOrdenes;

                    // Si hay más datos, cargarlos en segundo plano
                    if (totalOrdenes > LIMIT_POR_PAGINA) {
                        // Mostrar indicador de carga
                        document.getElementById('statCargaCard').style.display = '';
                        document.getElementById('statCargados').textContent = allData.length;
                        document.getElementById('statCargaLabel').textContent = `de ${totalOrdenes} cargados...`;
                        cargarDatosRestantes();
                    } else {
                        document.getElementById('statCargaCard').style.display = 'none';
                    }

                    aplicarFiltros();
                } else {
                    mostrarEmpty();
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarEmpty();
            }
        }

        // Cargar datos restantes en segundo plano
        async function cargarDatosRestantes() {
            let offset = LIMIT_POR_PAGINA;
            const statCargaCard = document.getElementById('statCargaCard');
            const statCargados = document.getElementById('statCargados');
            const statCargaLabel = document.getElementById('statCargaLabel');

            while (offset < totalOrdenes) {
                try {
                    const response = await fetch(`/api/ordenes?codEmpresa=${encodeURIComponent(codEmpresa)}&limit=${LIMIT_POR_PAGINA}&offset=${offset}`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        allData = allData.concat(result.data);
                        // Actualizar indicador de progreso
                        statCargados.textContent = allData.length;
                        statCargaLabel.textContent = `de ${totalOrdenes} cargados...`;
                        aplicarFiltros(); // Re-renderizar con nuevos datos
                    }

                    offset += LIMIT_POR_PAGINA;
                } catch (error) {
                    console.error('Error cargando datos adicionales:', error);
                    break;
                }
            }

            // Ocultar indicador cuando termine
            statCargaCard.style.display = 'none';
        }

        function aplicarFiltros() {
            let data = [...allData];

            // Aplicar filtro de estado
            if (currentFilter === 'atendido') {
                data = data.filter(o => o.atendido === 'ATENDIDO');
            } else if (currentFilter === 'pendiente') {
                data = data.filter(o => o.atendido !== 'ATENDIDO');
            }

            // Aplicar filtro de fechas (usa fechaAtencion)
            if (fechaDesde) {
                const desde = new Date(fechaDesde + 'T00:00:00');
                data = data.filter(o => {
                    if (!o.fechaAtencion) return false;
                    const fechaOrden = new Date(o.fechaAtencion);
                    return fechaOrden >= desde;
                });
            }
            if (fechaHasta) {
                const hasta = new Date(fechaHasta + 'T23:59:59');
                data = data.filter(o => {
                    if (!o.fechaAtencion) return false;
                    const fechaOrden = new Date(o.fechaAtencion);
                    return fechaOrden <= hasta;
                });
            }

            // Aplicar búsqueda local
            if (busquedaActual && busquedaActual.length >= 2) {
                const query = busquedaActual.toLowerCase();
                data = data.filter(o => {
                    const nombre = `${o.primerNombre || ''} ${o.segundoNombre || ''} ${o.primerApellido || ''} ${o.segundoApellido || ''}`.toLowerCase();
                    const cedula = (o.numeroId || '').toLowerCase();
                    return nombre.includes(query) || cedula.includes(query);
                });
            }

            filteredData = data;
            currentPage = 0;
            renderTabla();
        }

        // Búsqueda
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            busquedaActual = e.target.value.trim();

            searchTimeout = setTimeout(() => {
                if (busquedaActual.length >= 2 || busquedaActual.length === 0) {
                    aplicarFiltros();
                }
            }, 300);
        });

        // Paginación
        btnPrev.addEventListener('click', () => goToPage(currentPage - 1));
        btnNext.addEventListener('click', () => goToPage(currentPage + 1));

        function goToPage(page) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (page < 0) page = 0;
            if (page >= totalPages) page = totalPages - 1;
            currentPage = page;
            renderTabla();
        }

        // Render
        function mostrarLoading() {
            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            tableContainer.style.display = 'none';
        }

        function mostrarEmpty() {
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
            tableCount.innerHTML = '<strong>0</strong> registros';
        }

        function renderTabla() {
            if (filteredData.length === 0) {
                mostrarEmpty();
                return;
            }

            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            tableContainer.style.display = 'block';

            const totalPages = Math.ceil(filteredData.length / pageSize);
            const start = currentPage * pageSize;
            const end = Math.min(start + pageSize, filteredData.length);
            const pageData = filteredData.slice(start, end);

            tableCount.innerHTML = `<strong>${filteredData.length}</strong> registros`;

            tableBody.innerHTML = pageData.map(orden => {
                const nombre = `${orden.primerNombre || ''} ${orden.segundoNombre || ''} ${orden.primerApellido || ''} ${orden.segundoApellido || ''}`.trim();
                const cedula = orden.numeroId || '-';
                const fechaConsulta = orden.fechaConsulta ? new Date(orden.fechaConsulta).toLocaleDateString('es-CO') : '-';
                const fechaAtencion = orden.fechaAtencion ? new Date(orden.fechaAtencion).toLocaleDateString('es-CO') : '-';
                const estado = orden.atendido || 'PENDIENTE';
                const statusClass = estado === 'ATENDIDO' ? 'atendido' : (estado === 'EN PROCESO' ? 'proceso' : 'pendiente');
                const initials = nombre.split(' ').slice(0, 2).map(n => n.charAt(0)).join('').toUpperCase() || '?';
                const hasFoto = orden.foto_url ? 'has-photo' : '';

                return `
                    <tr onclick="abrirModalDetalles('${orden._id}')">
                        <td>
                            <div class="cell-name">
                                <div class="avatar ${hasFoto}">${orden.foto_url ? `<img src="${orden.foto_url}" alt="">` : initials}</div>
                                <div class="name-info">
                                    <span class="name-primary">${nombre || 'Sin nombre'}</span>
                                </div>
                            </div>
                        </td>
                        <td>${cedula}</td>
                        <td>${fechaConsulta}</td>
                        <td>${fechaAtencion}</td>
                        <td><span class="status-badge ${statusClass}"><span class="status-dot"></span>${estado}</span></td>
                    </tr>
                `;
            }).join('');

            // Render mobile cards
            renderMobileCards(pageData);

            // Actualizar paginación
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                paginationInfo.textContent = `Página ${currentPage + 1} de ${totalPages}`;
                btnPrev.disabled = currentPage <= 0;
                btnNext.disabled = currentPage >= totalPages - 1;
            } else {
                pagination.style.display = 'none';
            }
        }

        // ========== MOBILE CARDS ==========
        function renderMobileCards(ordenes) {
            const container = document.getElementById('mobileCards');
            if (!container) return;

            if (ordenes.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = ordenes.map(orden => {
                const nombre = `${orden.primerNombre || ''} ${orden.primerApellido || ''}`.trim();
                const isAtendido = orden.atendido === 'ATENDIDO';
                const initials = nombre.split(' ').slice(0, 2).map(n => n.charAt(0)).join('').toUpperCase() || '?';

                // Formatear fecha
                let fechaStr = '';
                if (orden.fechaAtencion) {
                    const fecha = new Date(orden.fechaAtencion);
                    fechaStr = fecha.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
                }

                // Status indicator
                const statusIndicator = isAtendido
                    ? `<span class="mobile-status-indicator atendido"><span class="mobile-status-dot"></span>Atendido</span>`
                    : `<span class="mobile-status-indicator pendiente"><span class="mobile-status-dot"></span>Pendiente</span>`;

                return `
                    <div class="mobile-card" onclick="abrirModalDetalles('${orden._id}')">
                        <div class="mobile-card-avatar">${initials}</div>
                        <div class="mobile-card-content">
                            <div class="mobile-card-title">${nombre || 'Sin nombre'}</div>
                            <div class="mobile-card-subtitle">
                                <span>${orden.cargo || 'Sin cargo'}</span>
                                <span class="dot"></span>
                                <span>${orden.numeroId || '—'}</span>
                            </div>
                        </div>
                        <div class="mobile-card-right">
                            <div class="mobile-card-time">${fechaStr}</div>
                            ${statusIndicator}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== MODAL DETALLES ==========
        function abrirModalDetalles(id) {
            const paciente = allData.find(p => p._id === id) || filteredData.find(p => p._id === id);
            if (!paciente) return;

            pacienteActual = paciente;
            const nombre = `${paciente.primerNombre || ''} ${paciente.segundoNombre || ''} ${paciente.primerApellido || ''} ${paciente.segundoApellido || ''}`.trim();
            const initials = nombre.split(' ').slice(0, 2).map(n => n.charAt(0)).join('').toUpperCase() || '?';
            const estado = paciente.atendido || 'PENDIENTE';
            const statusClass = estado === 'ATENDIDO' ? 'atendido' : 'pendiente';
            const hasFoto = paciente.foto_url ? 'has-photo' : '';

            const modalBody = document.getElementById('modalDetallesBody');
            modalBody.innerHTML = `
                <div class="profile-header-horizontal">
                    <div class="profile-photo ${hasFoto}">${paciente.foto_url ? `<img src="${paciente.foto_url}" alt="Foto">` : initials}</div>
                    <div class="profile-info">
                        <div class="profile-name">${nombre || 'Sin nombre'}</div>
                        <div class="profile-meta">CC: ${paciente.numeroId || '-'}</div>
                        <div class="profile-status ${statusClass}">
                            <span class="status-dot"></span>
                            ${estado}
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-title">Información Personal</div>
                    <div class="detail-grid">
                        <div class="detail-field">
                            <div class="detail-field-label">Celular</div>
                            <div class="detail-field-value">${paciente.celular || '-'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-field-label">Ciudad</div>
                            <div class="detail-field-value">${paciente.ciudad || '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-title">Información Laboral</div>
                    <div class="detail-grid">
                        <div class="detail-field">
                            <div class="detail-field-label">Empresa</div>
                            <div class="detail-field-value">${paciente.empresa || paciente.codEmpresa || '-'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-field-label">Cargo</div>
                            <div class="detail-field-value">${paciente.cargo || '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-title">Información del Examen</div>
                    <div class="detail-grid">
                        <div class="detail-field">
                            <div class="detail-field-label">Tipo de Examen</div>
                            <div class="detail-field-value">${paciente.tipoExamen || '-'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-field-label">Fecha y Hora de Atención</div>
                            <div class="detail-field-value">${paciente.fechaAtencion ? (() => {
                                const fecha = new Date(paciente.fechaAtencion);
                                const fechaStr = fecha.toLocaleDateString('es-CO', { timeZone: 'America/Bogota', day: '2-digit', month: '2-digit', year: 'numeric' });
                                const horaStr = fecha.toLocaleTimeString('es-CO', { timeZone: 'America/Bogota', hour: '2-digit', minute: '2-digit', hour12: true });
                                return fechaStr + ', ' + horaStr;
                            })() : '-'}</div>
                        </div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Exámenes</div>
                        <div class="detail-field-value">${paciente.examenes || '-'}</div>
                    </div>
                </div>

                ${(paciente.atendido === 'ATENDIDO' && tienePermiso('VER_RESULTADOS_MEDICOS')) ? `
                <div class="detail-card">
                    <div class="detail-card-title">Resultados Médicos</div>
                    <div class="detail-field">
                        <div class="detail-field-label">Concepto Médico Final</div>
                        <div class="detail-field-value">${paciente.mdConceptoFinal || '-'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Recomendaciones Médicas</div>
                        <div class="detail-field-value">${paciente.mdRecomendacionesMedicasAdicionales || '-'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Observaciones del Certificado</div>
                        <div class="detail-field-value">${paciente.mdObservacionesCertificado || '-'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Observaciones solo para la empresa</div>
                        <div class="detail-field-value">${paciente.mdObsParaMiDocYa || '-'}</div>
                    </div>
                </div>
                ` : ''}
            `;

            // Configurar botón PDF según permisos
            const btnPDF = document.getElementById('btnDescargarPDF');
            if (!tienePermiso('DESCARGAR_CERTIFICADO')) {
                btnPDF.style.display = 'none';
            } else if (estado === 'ATENDIDO') {
                btnPDF.style.display = 'inline-flex';
                btnPDF.href = `https://bsl-utilidades-yp78a.ondigitalocean.app/generar-certificado-desde-wix/${paciente._id}`;
                btnPDF.style.opacity = '1';
                btnPDF.style.pointerEvents = 'auto';
            } else {
                btnPDF.style.display = 'inline-flex';
                btnPDF.href = '#';
                btnPDF.style.opacity = '0.5';
                btnPDF.style.pointerEvents = 'none';
            }

            // Configurar botón Editar según permisos
            const btnEditar = document.querySelector('.modal-footer .btn-secondary[onclick*="abrirModalEdicion"]');
            if (btnEditar) {
                btnEditar.style.display = tienePermiso('EDITAR_ORDEN') ? 'inline-flex' : 'none';
            }

            document.getElementById('modalDetalles').classList.add('active');
        }

        function cerrarModalDetalles() {
            document.getElementById('modalDetalles').classList.remove('active');
            pacienteActual = null;
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalDetalles').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalDetalles();
            }
        });

        // ========== MODAL EDICIÓN ==========
        function abrirModalEdicion() {
            if (!pacienteActual) return;
            if (!tienePermiso('EDITAR_ORDEN')) {
                alert('No tienes permiso para editar órdenes');
                return;
            }

            // Llenar el formulario con los datos del paciente
            document.getElementById('edit-id').value = pacienteActual._id || '';
            document.getElementById('edit-primerNombre').value = pacienteActual.primerNombre || '';
            document.getElementById('edit-segundoNombre').value = pacienteActual.segundoNombre || '';
            document.getElementById('edit-primerApellido').value = pacienteActual.primerApellido || '';
            document.getElementById('edit-segundoApellido').value = pacienteActual.segundoApellido || '';
            document.getElementById('edit-numeroId').value = pacienteActual.numeroId || '';
            document.getElementById('edit-celular').value = pacienteActual.celular || '';
            document.getElementById('edit-ciudad').value = pacienteActual.ciudad || '';
            document.getElementById('edit-cargo').value = pacienteActual.cargo || '';
            document.getElementById('edit-tipoExamen').value = pacienteActual.tipoExamen || '';
            document.getElementById('edit-examenes').value = pacienteActual.examenes || '';

            // Formatear fecha y verificar si ya pasó
            const inputFecha = document.getElementById('edit-fechaAtencion');
            const inputHora = document.getElementById('edit-horaAtencion');

            if (pacienteActual.fechaAtencion) {
                const fecha = new Date(pacienteActual.fechaAtencion);
                const year = fecha.getFullYear();
                const month = String(fecha.getMonth() + 1).padStart(2, '0');
                const day = String(fecha.getDate()).padStart(2, '0');
                inputFecha.value = `${year}-${month}-${day}`;

                // Deshabilitar si la fecha ya pasó
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const fechaSinHora = new Date(year, fecha.getMonth(), parseInt(day));
                if (fechaSinHora < hoy) {
                    inputFecha.disabled = true;
                    inputHora.disabled = true;
                    inputFecha.title = 'No se puede editar una fecha de atención pasada';
                    inputHora.title = 'No se puede editar una fecha de atención pasada';
                } else {
                    inputFecha.disabled = false;
                    inputHora.disabled = false;
                    inputFecha.title = '';
                    inputHora.title = '';
                }
            } else {
                inputFecha.value = '';
                inputFecha.disabled = false;
                inputHora.disabled = false;
                inputFecha.title = '';
                inputHora.title = '';
            }

            inputHora.value = pacienteActual.horaAtencion || '';

            cerrarModalDetalles();
            document.getElementById('modalEdicion').classList.add('active');
        }

        function cerrarModalEdicion() {
            document.getElementById('modalEdicion').classList.remove('active');
        }

        async function guardarCambiosEdicion(event) {
            event.preventDefault();

            const btn = document.getElementById('btnGuardarEdicion');
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const ordenId = document.getElementById('edit-id').value;

            const datos = {
                primerNombre: capitalize(document.getElementById('edit-primerNombre').value),
                segundoNombre: document.getElementById('edit-segundoNombre').value.trim() ? capitalize(document.getElementById('edit-segundoNombre').value) : null,
                primerApellido: capitalize(document.getElementById('edit-primerApellido').value),
                segundoApellido: document.getElementById('edit-segundoApellido').value.trim() ? capitalize(document.getElementById('edit-segundoApellido').value) : null,
                celular: document.getElementById('edit-celular').value.trim(),
                ciudad: document.getElementById('edit-ciudad').value.trim(),
                cargo: document.getElementById('edit-cargo').value.trim(),
                tipoExamen: document.getElementById('edit-tipoExamen').value,
                examenes: document.getElementById('edit-examenes').value.trim(),
                horaAtencion: document.getElementById('edit-horaAtencion').value
            };

            // Agregar fecha si está presente
            const fechaStr = document.getElementById('edit-fechaAtencion').value;
            if (fechaStr) {
                const horaStr = document.getElementById('edit-horaAtencion').value || '00:00';
                const [year, month, day] = fechaStr.split('-').map(Number);
                const [hours, minutes] = horaStr.split(':').map(Number);
                const fechaHora = new Date(year, month - 1, day, hours, minutes);
                datos.fechaAtencion = fechaHora.toISOString();
            }

            try {
                const response = await fetch(`/api/historia-clinica/${ordenId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModalEdicion();
                    actualizarDatos();
                    alert('Orden actualizada exitosamente');
                } else {
                    alert('Error al actualizar: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Guardar Cambios';
            }
        }

        // Cerrar modal edición al hacer clic fuera
        document.getElementById('modalEdicion').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalEdicion();
            }
        });

        // ========== MODAL NUEVA ORDEN ==========
        let modalidadActual = 'presencial';
        let examenesDataModal = [];
        let examenesSeleccionadosModal = [];
        let ordenExistenteActual = null;

        function abrirModalNuevaOrden() {
            if (!tienePermiso('CREAR_ORDEN')) {
                alert('No tienes permiso para crear órdenes');
                return;
            }
            document.getElementById('modalNuevaOrden').classList.add('active');
            document.getElementById('modalEmpresa').value = codEmpresa;
            modalidadActual = 'presencial';
            actualizarTabsModalidad();
            cargarExamenesModal();
            cargarCiudadesModal();
            cargarSubempresasModal();
            limpiarFormularioModal();
            document.getElementById('modalPaso1').style.display = 'block';
            document.getElementById('modalPaso2').style.display = 'none';
            document.getElementById('modalFooterPaso2').style.display = 'none';
        }

        // Cargar ciudades según configuración de empresa
        function cargarCiudadesModal() {
            const select = document.getElementById('modalCiudad');
            let ciudades = [];

            if (configEmpresa && configEmpresa.ciudades && configEmpresa.ciudades.length > 0) {
                ciudades = configEmpresa.ciudades;
            } else {
                // Lista por defecto de ciudades colombianas
                ciudades = [
                    'Bogotá', 'Medellín', 'Cali', 'Barranquilla', 'Cartagena',
                    'Cúcuta', 'Bucaramanga', 'Pereira', 'Santa Marta', 'Ibagué',
                    'Pasto', 'Manizales', 'Neiva', 'Villavicencio', 'Armenia',
                    'Valledupar', 'Montería', 'Sincelejo', 'Popayán', 'Floridablanca',
                    'Buenaventura', 'Soledad', 'Itagüí', 'Soacha', 'Bello',
                    'Palmira', 'Tunja', 'Girardot', 'Riohacha', 'Barrancabermeja',
                    'Dosquebradas', 'Envigado', 'Tuluá', 'Sogamoso', 'Duitama',
                    'Zipaquirá', 'Facatativá', 'Chía', 'Fusagasugá', 'Otro'
                ];
            }

            select.innerHTML = '<option value="">Seleccionar ciudad...</option>' +
                ciudades.map(ciudad => `<option value="${ciudad}">${ciudad}</option>`).join('');
        }

        // Cargar subempresas según configuración
        function cargarSubempresasModal() {
            const container = document.getElementById('subempresaContainer');
            if (!container) return;

            if (configEmpresa && configEmpresa.subempresas && configEmpresa.subempresas.length > 0) {
                container.style.display = 'block';
                const select = document.getElementById('modalSubempresa');
                select.innerHTML = '<option value="">Seleccionar subempresa...</option>' +
                    configEmpresa.subempresas.map(sub => `<option value="${sub}">${sub}</option>`).join('');
            } else {
                container.style.display = 'none';
            }
        }

        function cerrarModalNuevaOrden() {
            document.getElementById('modalNuevaOrden').classList.remove('active');
            ordenExistenteActual = null;
            ocultarAlertaModal();
        }

        function limpiarFormularioModal() {
            document.getElementById('modalNumeroId').value = '';
            document.getElementById('modalCelular').value = '';
            document.getElementById('modalPrimerNombre').value = '';
            document.getElementById('modalSegundoNombre').value = '';
            document.getElementById('modalPrimerApellido').value = '';
            document.getElementById('modalSegundoApellido').value = '';
            document.getElementById('modalCargo').value = '';
            document.getElementById('modalCiudad').value = '';
            document.getElementById('modalTipoExamen').value = '';
            const subempresaSelect = document.getElementById('modalSubempresa');
            if (subempresaSelect) subempresaSelect.value = '';
            const inputFecha = document.getElementById('modalFechaAtencion');
            inputFecha.value = '';
            document.getElementById('modalHoraAtencion').innerHTML = '<option value="">Primero seleccione fecha...</option>';
            examenesSeleccionadosModal = [];
            actualizarExamenesUIModal();
        }

        function cambiarModalidadOrden(modalidad) {
            modalidadActual = modalidad;
            actualizarTabsModalidad();
            if (document.getElementById('modalFechaAtencion').value) {
                validarYCargarTurnosDisponibles();
            }
        }

        function actualizarTabsModalidad() {
            document.querySelectorAll('.modalidad-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.modalidad === modalidadActual);
            });
        }

        function validarYCargarTurnosDisponibles() {
            const inputFecha = document.getElementById('modalFechaAtencion');
            const fecha = inputFecha.value;
            const select = document.getElementById('modalHoraAtencion');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero seleccione fecha...</option>';
                return;
            }

            // Verificar que la fecha esté completa y el año sea razonable (>= 2024)
            const match = fecha.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match || parseInt(match[1]) < 2024) {
                return; // Fecha incompleta o año inválido, esperar
            }

            // Validar que la fecha no sea pasada (timezone Colombia)
            const hoyColombia = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Bogota' });
            if (fecha < hoyColombia) {
                alert('No puedes seleccionar una fecha pasada');
                inputFecha.value = '';
                select.innerHTML = '<option value="">Selecciona una fecha válida</option>';
                return;
            }

            // Fecha válida, cargar turnos
            cargarTurnosDisponibles();
        }

        async function cargarTurnosDisponibles() {
            const inputFecha = document.getElementById('modalFechaAtencion');
            const fecha = inputFecha.value;
            const select = document.getElementById('modalHoraAtencion');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero seleccione fecha...</option>';
                return;
            }

            select.innerHTML = '<option value="">Cargando turnos disponibles...</option>';

            try {
                const response = await fetch(`/api/turnos-disponibles?fecha=${fecha}&modalidad=${modalidadActual}`);
                const result = await response.json();

                if (result.success && result.turnos && result.turnos.length > 0) {
                    select.innerHTML = '<option value="">Seleccionar hora...</option>';

                    result.turnos.forEach(turno => {
                        const [hora, minuto] = turno.hora.split(':').map(Number);
                        const hora12 = hora > 12 ? hora - 12 : (hora === 0 ? 12 : hora);
                        const ampm = hora >= 12 ? 'PM' : 'AM';
                        const texto = `${hora12}:${minuto.toString().padStart(2, '0')} ${ampm}`;

                        const option = document.createElement('option');
                        option.value = turno.hora;

                        if (turno.disponible) {
                            option.textContent = texto;
                        } else {
                            option.textContent = `${texto} (no disponible)`;
                            option.disabled = true;
                            option.style.color = 'var(--text-tertiary)';
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay turnos disponibles para este día</option>';
                }
            } catch (error) {
                console.error('Error al cargar turnos:', error);
                select.innerHTML = '<option value="">Error al cargar turnos</option>';
            }
        }

        async function cargarExamenesModal() {
            try {
                const response = await fetch('/api/examenes');
                const data = await response.json();
                let examenes = data.filter(e => e.activo !== false);

                // Filtrar por configuración de empresa si existe
                if (configEmpresa && configEmpresa.examenes && configEmpresa.examenes.length > 0) {
                    examenes = examenes.filter(e => configEmpresa.examenes.includes(e.nombre));
                }

                examenesDataModal = examenes;
                renderExamenesModal();
            } catch (error) {
                console.error('Error al cargar exámenes:', error);
                document.getElementById('modalExamenesContainer').innerHTML =
                    '<div style="padding: 14px; color: #EF4444; font-size: 14px;">Error al cargar exámenes</div>';
            }
        }

        function renderExamenesModal() {
            const container = document.getElementById('modalExamenesContainer');

            if (examenesDataModal.length === 0) {
                container.innerHTML = '<div style="padding: 14px; color: var(--text-tertiary); font-size: 14px;">No hay exámenes disponibles</div>';
                return;
            }

            container.innerHTML = examenesDataModal.map(examen => `
                <div class="examen-option" onclick="toggleExamenModal(${examen.id}, '${examen.nombre.replace(/'/g, "\\'")}')">
                    <input type="checkbox" id="modal-examen-${examen.id}" ${examenesSeleccionadosModal.includes(examen.nombre) ? 'checked' : ''}>
                    <label for="modal-examen-${examen.id}">${examen.nombre}</label>
                </div>
            `).join('');
        }

        function toggleExamenModal(id, nombre) {
            const index = examenesSeleccionadosModal.indexOf(nombre);
            if (index === -1) {
                examenesSeleccionadosModal.push(nombre);
            } else {
                examenesSeleccionadosModal.splice(index, 1);
            }
            actualizarExamenesUIModal();
        }

        function quitarExamenModal(nombre) {
            const index = examenesSeleccionadosModal.indexOf(nombre);
            if (index !== -1) {
                examenesSeleccionadosModal.splice(index, 1);
            }
            actualizarExamenesUIModal();
        }

        function actualizarExamenesUIModal() {
            examenesDataModal.forEach(examen => {
                const checkbox = document.getElementById(`modal-examen-${examen.id}`);
                if (checkbox) {
                    checkbox.checked = examenesSeleccionadosModal.includes(examen.nombre);
                }
            });

            const selectedContainer = document.getElementById('modalExamenesSelected');
            selectedContainer.innerHTML = examenesSeleccionadosModal.map(nombre => `
                <span class="examen-tag">
                    ${nombre}
                    <button type="button" onclick="quitarExamenModal('${nombre.replace(/'/g, "\\'")}')">&times;</button>
                </span>
            `).join('');
        }

        function mostrarAlertaModal(mensaje, tipo = 'error') {
            const alert = document.getElementById('modalAlert');
            alert.textContent = mensaje;
            alert.className = `modal-alert show ${tipo}`;
        }

        function ocultarAlertaModal() {
            document.getElementById('modalAlert').className = 'modal-alert';
        }

        async function crearOrdenEmpresa() {
            ocultarAlertaModal();

            const numeroId = document.getElementById('modalNumeroId').value.trim();
            const celular = document.getElementById('modalCelular').value.trim();
            const primerNombre = document.getElementById('modalPrimerNombre').value.trim();
            const primerApellido = document.getElementById('modalPrimerApellido').value.trim();
            const cargo = document.getElementById('modalCargo').value.trim();
            const ciudad = document.getElementById('modalCiudad').value.trim();
            const tipoExamen = document.getElementById('modalTipoExamen').value;
            const fechaAtencion = document.getElementById('modalFechaAtencion').value;
            const horaAtencion = document.getElementById('modalHoraAtencion').value;

            if (!numeroId || !celular || !primerNombre || !primerApellido || !cargo || !ciudad || !tipoExamen) {
                mostrarAlertaModal('Por favor complete todos los campos obligatorios');
                return;
            }

            if (!fechaAtencion || !horaAtencion) {
                mostrarAlertaModal('Debe seleccionar fecha y hora de atención');
                return;
            }

            const btn = document.getElementById('btnCrearOrden');
            btn.disabled = true;
            btn.textContent = 'Creando...';

            // Obtener subempresa si está configurada
            const subempresaSelect = document.getElementById('modalSubempresa');
            const subempresa = subempresaSelect && subempresaSelect.value ? subempresaSelect.value : null;

            const datos = {
                codEmpresa: codEmpresa,
                empresa: codEmpresa,
                numeroId: numeroId,
                celular: celular,
                primerNombre: capitalize(primerNombre),
                segundoNombre: document.getElementById('modalSegundoNombre').value.trim() ? capitalize(document.getElementById('modalSegundoNombre').value) : null,
                primerApellido: capitalize(primerApellido),
                segundoApellido: document.getElementById('modalSegundoApellido').value.trim() ? capitalize(document.getElementById('modalSegundoApellido').value) : null,
                cargo: cargo,
                ciudad: ciudad,
                subempresa: subempresa,
                tipoExamen: tipoExamen,
                fechaAtencion: fechaAtencion,
                horaAtencion: horaAtencion,
                examenes: examenesSeleccionadosModal.join(', '),
                atendido: 'PENDIENTE',
                asignarMedicoAuto: true,
                modalidad: modalidadActual
            };

            try {
                const response = await fetch('/api/ordenes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModalNuevaOrden();
                    actualizarDatos();
                    alert('Orden creada exitosamente');
                } else {
                    mostrarAlertaModal(result.message || 'Error al crear la orden');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlertaModal('Error de conexión. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Crear Orden';
            }
        }

        document.getElementById('modalNuevaOrden').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalNuevaOrden();
            }
        });

        // ========== FUNCIONES PARA VERIFICACIÓN DE DUPLICADOS ==========
        async function verificarDocumentoModal() {
            const numeroId = document.getElementById('modalNumeroId').value.trim();

            if (!numeroId) {
                mostrarAlertaModal('Por favor ingrese el número de documento');
                return;
            }

            const btn = document.getElementById('btnVerificarDocModal');
            btn.disabled = true;
            btn.textContent = 'Verificando...';
            ocultarAlertaModal();

            try {
                const response = await fetch(`/api/ordenes/verificar-duplicado/${encodeURIComponent(numeroId)}`);
                const result = await response.json();

                if (result.success && result.hayDuplicado) {
                    btn.disabled = false;
                    btn.textContent = 'Verificar y Continuar';

                    if (result.tipo === 'atendido') {
                        mostrarModalAtendido(result.ordenExistente);
                    } else if (result.tipo === 'expirado') {
                        mostrarModalExpirado(result.ordenExistente);
                    } else {
                        mostrarModalDuplicado(result.ordenExistente);
                    }
                } else {
                    mostrarPaso2Modal();
                }
            } catch (error) {
                console.error('Error al verificar:', error);
                mostrarAlertaModal('Error al verificar el documento. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verificar y Continuar';
            }
        }

        function mostrarPaso2Modal() {
            const numeroId = document.getElementById('modalNumeroId').value.trim();
            document.getElementById('modalNumeroIdDisplay').value = numeroId;
            document.getElementById('modalPaso1').style.display = 'none';
            document.getElementById('modalPaso2').style.display = 'block';
            document.getElementById('modalFooterPaso2').style.display = 'flex';
            ocultarAlertaModal();
        }

        function volverPaso1Modal() {
            document.getElementById('modalPaso1').style.display = 'block';
            document.getElementById('modalPaso2').style.display = 'none';
            document.getElementById('modalFooterPaso2').style.display = 'none';
            ocultarAlertaModal();
        }

        function mostrarModalDuplicado(ordenExistente) {
            ordenExistenteActual = ordenExistente;
            const fechaCreacion = new Date(ordenExistente.fechaCreacion).toLocaleDateString('es-CO', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            document.getElementById('ordenExistenteInfo').innerHTML = `
                <p style="margin: 4px 0;"><strong>Fecha de creación:</strong> ${fechaCreacion}</p>
            `;

            const mensajeFormulario = document.getElementById('mensajeFormulario');
            if (ordenExistente.tieneFormulario) {
                mensajeFormulario.innerHTML = 'Esta orden <strong>ya tiene</strong> un formulario médico completado.';
            } else {
                mensajeFormulario.innerHTML = 'Esta orden <strong>no tiene</strong> formulario médico completado aún.';
            }

            document.getElementById('modalDuplicado').classList.add('active');
        }

        function cerrarModalDuplicado() {
            document.getElementById('modalDuplicado').classList.remove('active');
        }

        function mostrarModalAtendido(ordenExistente) {
            ordenExistenteActual = ordenExistente;

            let fechaAtencionStr = 'No disponible';
            if (ordenExistente.fechaAtencion) {
                fechaAtencionStr = new Date(ordenExistente.fechaAtencion).toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            } else if (ordenExistente.fechaCreacion) {
                fechaAtencionStr = new Date(ordenExistente.fechaCreacion).toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            }

            document.getElementById('ordenAtendidaInfo').innerHTML = `
                <p style="margin: 4px 0;"><strong>Fecha de consulta:</strong> ${fechaAtencionStr}</p>
            `;

            document.getElementById('modalAtendido').classList.add('active');
        }

        function cerrarModalAtendido() {
            document.getElementById('modalAtendido').classList.remove('active');
        }

        let modalidadExpirado = 'presencial';

        function mostrarModalExpirado(ordenExistente) {
            ordenExistenteActual = ordenExistente;
            modalidadExpirado = 'presencial';

            let fechaAtencionStr = 'No disponible';
            if (ordenExistente.fechaAtencion) {
                fechaAtencionStr = new Date(ordenExistente.fechaAtencion).toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            }

            document.getElementById('ordenExpiradaInfo').innerHTML = `
                <p style="margin: 4px 0;"><strong>Fecha programada:</strong> <span style="color: #DC2626;">${fechaAtencionStr} (Expirada)</span></p>
            `;

            // Resetear controles
            actualizarTabsModalidadExpirado();
            document.getElementById('fechaExpirado').value = '';
            document.getElementById('horaExpirado').innerHTML = '<option value="">Primero selecciona una fecha</option>';

            document.getElementById('modalExpirado').classList.add('active');
        }

        function cerrarModalExpirado() {
            document.getElementById('modalExpirado').classList.remove('active');
        }

        function cambiarModalidadExpirado(modalidad) {
            modalidadExpirado = modalidad;
            actualizarTabsModalidadExpirado();
            // Si ya hay fecha seleccionada, recargar turnos
            if (document.getElementById('fechaExpirado').value) {
                validarYCargarTurnosExpirado();
            }
        }

        function actualizarTabsModalidadExpirado() {
            document.querySelectorAll('.modalidad-tab-expirado').forEach(tab => {
                const esActivo = tab.dataset.modalidad === modalidadExpirado;
                if (esActivo) {
                    tab.style.background = '#10B981';
                    tab.style.color = 'white';
                    tab.style.borderColor = '#10B981';
                } else {
                    tab.style.background = 'white';
                    tab.style.color = '#374151';
                    tab.style.borderColor = '#D1D5DB';
                }
            });
        }

        function validarYCargarTurnosExpirado() {
            const inputFecha = document.getElementById('fechaExpirado');
            const fecha = inputFecha.value;
            const select = document.getElementById('horaExpirado');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero selecciona una fecha</option>';
                return;
            }

            // Verificar que la fecha esté completa y el año sea razonable (>= 2024)
            const match = fecha.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match || parseInt(match[1]) < 2024) {
                return; // Fecha incompleta o año inválido, esperar
            }

            // Validar que la fecha no sea pasada (timezone Colombia)
            const hoyColombia = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Bogota' });
            if (fecha < hoyColombia) {
                alert('No puedes seleccionar una fecha pasada');
                inputFecha.value = '';
                select.innerHTML = '<option value="">Selecciona una fecha válida</option>';
                return;
            }

            // Fecha válida, cargar turnos
            cargarTurnosExpirado();
        }

        async function cargarTurnosExpirado() {
            const inputFecha = document.getElementById('fechaExpirado');
            const fecha = inputFecha.value;
            const select = document.getElementById('horaExpirado');

            if (!fecha) {
                select.innerHTML = '<option value="">Primero selecciona una fecha</option>';
                return;
            }

            select.innerHTML = '<option value="">Cargando turnos disponibles...</option>';

            try {
                const response = await fetch(`/api/turnos-disponibles?fecha=${fecha}&modalidad=${modalidadExpirado}`);
                const result = await response.json();

                if (result.success && result.turnos && result.turnos.length > 0) {
                    select.innerHTML = '<option value="">Seleccionar hora...</option>';

                    result.turnos.forEach(turno => {
                        const [hora, minuto] = turno.hora.split(':').map(Number);
                        const hora12 = hora > 12 ? hora - 12 : (hora === 0 ? 12 : hora);
                        const ampm = hora >= 12 ? 'PM' : 'AM';
                        const texto = `${hora12}:${minuto.toString().padStart(2, '0')} ${ampm}`;

                        const option = document.createElement('option');
                        option.value = JSON.stringify({ hora: turno.hora, medico: turno.medico });

                        if (turno.disponible) {
                            option.textContent = texto;
                        } else {
                            option.textContent = `${texto} (no disponible)`;
                            option.disabled = true;
                            option.style.color = 'var(--text-tertiary)';
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay turnos disponibles para este día</option>';
                }
            } catch (error) {
                console.error('Error al cargar turnos:', error);
                select.innerHTML = '<option value="">Error al cargar turnos</option>';
            }
        }

        async function actualizarFechaYContinuar() {
            const fecha = document.getElementById('fechaExpirado').value;
            const turnoValue = document.getElementById('horaExpirado').value;

            if (!fecha || !turnoValue) {
                alert('Por favor selecciona una nueva fecha y hora');
                return;
            }

            let turnoData;
            try {
                turnoData = JSON.parse(turnoValue);
            } catch (e) {
                alert('Error al procesar el turno seleccionado');
                return;
            }

            const btn = document.getElementById('btnActualizarFecha');
            btn.disabled = true;
            btn.textContent = 'Actualizando...';

            try {
                const [year, month, day] = fecha.split('-').map(Number);
                const [hours, minutes] = turnoData.hora.split(':').map(Number);
                const fechaHora = new Date(year, month - 1, day, hours, minutes);

                const response = await fetch(`/api/ordenes/${ordenExistenteActual._id}/fecha-atencion`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fechaAtencion: fechaHora.toISOString(),
                        horaAtencion: turnoData.hora,
                        medico: turnoData.medico
                    })
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModalExpirado();
                    cerrarModalNuevaOrden();
                    const formUrl = `${window.location.origin}/?_id=${ordenExistenteActual._id}`;
                    window.open(formUrl, '_blank');
                    alert('Cita reagendada exitosamente. Se abrió el formulario en una nueva pestaña.');
                } else {
                    alert('Error al actualizar la fecha: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la fecha. Intente de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Reagendar y continuar';
            }
        }

        // Event listeners para botones del modal de duplicados
        document.getElementById('btnUsarExistente').addEventListener('click', () => {
            if (ordenExistenteActual) {
                const formUrl = `${window.location.origin}/?_id=${ordenExistenteActual._id}`;
                window.open(formUrl, '_blank');
                cerrarModalDuplicado();
                cerrarModalNuevaOrden();
                alert('Usando orden existente. Se abrió el formulario en una nueva pestaña.');
            }
        });

        document.getElementById('btnCrearNuevaModal').addEventListener('click', () => {
            cerrarModalDuplicado();
            mostrarPaso2Modal();
        });

        document.getElementById('modalDuplicado').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalDuplicado();
            }
        });

        document.getElementById('btnCrearNuevaAtendido').addEventListener('click', () => {
            cerrarModalAtendido();
            mostrarPaso2Modal();
        });

        document.getElementById('modalAtendido').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalAtendido();
            }
        });

        document.getElementById('btnCrearNuevaExpirado').addEventListener('click', () => {
            cerrarModalExpirado();
            mostrarPaso2Modal();
        });

        document.getElementById('modalExpirado').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalExpirado();
            }
        });
    </script>
</body>
</html>
