<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel RIPS - BSL Plataforma</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Medical Color Palette - Profesional y confiable */
            --medical-primary: #0C4A6E;
            --medical-secondary: #0EA5E9;
            --success-green: #059669;
            --warning-amber: #F59E0B;
            --error-red: #DC2626;
            --info-blue: #3B82F6;

            /* Neutrals refinados */
            --bg-primary: #F8FAFC;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F1F5F9;
            --bg-input: #FFFFFF;
            --surface-elevated: #FFFFFF;
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;
            --border-color: #E2E8F0;
            --border-subtle: #F1F5F9;

            /* Legacy compatibility */
            --accent-color: #0C4A6E;
            --accent-hover: #0A3A54;
            --text-tertiary: #94A3B8;
            --border-light: #E2E8F0;

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(15, 23, 42, 0.04);
            --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.08);
            --shadow-md: 0 4px 6px rgba(15, 23, 42, 0.1), 0 2px 4px rgba(15, 23, 42, 0.06);
            --shadow-lg: 0 10px 15px rgba(15, 23, 42, 0.1), 0 4px 6px rgba(15, 23, 42, 0.05);
            --shadow-xl: 0 20px 25px rgba(15, 23, 42, 0.1), 0 10px 10px rgba(15, 23, 42, 0.04);

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;

            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --bg-tertiary: #374151;
            --bg-input: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --text-tertiary: #9CA3AF;
            --border-color: #374151;
            --border-light: #4B5563;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Figtree', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ========== LAYOUT ========== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            overflow-x: visible;
            transition: width 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            z-index: 150;
        }

        .sidebar.collapsed {
            width: 68px;
        }

        .sidebar-logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
            text-align: center;
            transition: padding 0.3s ease;
        }

        .sidebar.collapsed .sidebar-logo {
            padding: 0 10px 24px;
        }

        .sidebar-logo img {
            max-width: 140px;
            height: auto;
            transition: max-width 0.3s ease;
        }

        .sidebar.collapsed .sidebar-logo img {
            max-width: 44px;
        }

        /* Toggle Button */
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            right: -14px;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 200;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .sidebar-toggle:hover {
            background: var(--bg-tertiary);
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }

        .sidebar-toggle i {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed .sidebar-toggle i {
            transform: rotate(180deg);
        }

        .sidebar-nav {
            padding: 0 12px;
        }

        .sidebar.collapsed .sidebar-nav {
            padding: 0 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .nav-item {
            padding: 10px;
            justify-content: center;
        }

        .nav-item span {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .sidebar.collapsed .nav-item span {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
        }

        [data-theme="dark"] .nav-item.active {
            background: #1E3A5F;
            color: #60A5FA;
        }

        .nav-item i {
            width: 20px;
            height: 20px;
            stroke-width: 2;
            flex-shrink: 0;
        }

        /* Tooltip para sidebar colapsado */
        .sidebar.collapsed .nav-item {
            position: relative;
        }

        .sidebar.collapsed .nav-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            margin-left: 10px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            z-index: 200;
        }

        .sidebar.collapsed .nav-item:hover::after {
            opacity: 1;
        }

        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            height: 64px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            z-index: 100;
            transition: left 0.3s ease, background 0.3s ease, border-color 0.3s ease;
        }

        .sidebar.collapsed ~ .top-bar,
        body.sidebar-collapsed .top-bar {
            left: 68px;
        }

        .top-bar-search {
            position: relative;
            flex: 1;
            max-width: 600px;
        }

        .top-bar-search input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: 'Figtree', sans-serif;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .top-bar-search input:focus {
            outline: none;
            border-color: var(--medical-primary);
            box-shadow: 0 0 0 3px rgba(12, 74, 110, 0.1);
            background: var(--bg-secondary);
        }

        .top-bar-search input::placeholder {
            color: var(--text-muted);
        }

        .top-bar-search i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            width: 18px;
            height: 18px;
            pointer-events: none;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .theme-toggle i {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }

        .theme-toggle span {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 32px 40px;
            padding-top: 96px;
            transition: margin-left 0.3s ease;
        }

        body.sidebar-collapsed .main-content {
            margin-left: 68px;
        }

        /* ========== HEADER ========== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-header-left h1 {
            font-family: 'Figtree', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--medical-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .page-header-left h1 i {
            width: 24px;
            height: 24px;
            stroke: var(--accent-color);
            color: var(--accent-color);
        }

        .page-header-left p {
            font-size: 16px;
            color: var(--text-secondary);
            margin-left: 34px;
            font-weight: 500;
        }

        /* ========== TABS ========== */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: 'Figtree', sans-serif;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        /* ========== TAB CONTENT ========== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ========== BUTTONS ========== */
        .btn {
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-family: 'Figtree', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--medical-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0A3A54;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--medical-primary);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-danger:hover {
            background: #B91C1C;
        }

        /* ========== TABLE ========== */
        .table-container {
            background: var(--surface-elevated);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-color);
        }

        .data-table th {
            font-family: 'Figtree', sans-serif;
            padding: 16px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .data-table tbody tr {
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.15s ease;
        }

        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table td {
            padding: 18px 20px;
            font-size: 14px;
            color: var(--text-primary);
            vertical-align: middle;
        }

        /* ========== FORM STYLES ========== */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: 'Figtree', sans-serif;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--medical-primary);
            box-shadow: 0 0 0 3px rgba(12, 74, 110, 0.1);
            background: var(--bg-secondary);
        }

        /* ========== ALERTS ========== */
        .alert {
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .alert-info {
            background: #E0F2FE;
            border: 1px solid #7DD3FC;
            color: #0C4A6E;
        }

        .alert-warning {
            background: #FEF3C7;
            border: 1px solid #FBBF24;
            color: #92400E;
        }

        .alert-error {
            background: #FEE2E2;
            border: 1px solid #FCA5A5;
            color: #991B1B;
        }

        .alert-success {
            background: #D1FAE5;
            border: 1px solid #6EE7B7;
            color: #065F46;
        }

        /* ========== BADGES ========== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-error {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* ========== STATS ========== */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .stat-card .label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ========== JSON PREVIEW ========== */
        .json-preview {
            background: #1E293B;
            color: #E2E8F0;
            padding: 20px;
            border-radius: var(--radius-md);
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: var(--shadow-md);
        }

        /* ========== LOADING STATE ========== */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--medical-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* ========== ACTIONS ========== */
        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* ========== SECTION ========== */
        .section {
            margin-bottom: 30px;
        }

        .section-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* ========== MOBILE STYLES ========== */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .top-bar {
                left: 0;
                padding: 0 16px;
                gap: 12px;
            }

            .top-bar-search {
                flex: 1;
                width: auto;
            }

            .theme-toggle span {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 20px 16px;
                padding-top: 84px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .page-header-left h1 {
                font-size: 28px;
            }

            .page-header-left p {
                font-size: 14px;
                margin-left: 0;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
                <i data-feather="chevron-left"></i>
            </button>
            <div class="sidebar-logo">
                <img src="/bsl-logo.png" alt="BSL - Bienestar & Salud Laboral">
            </div>
            <nav class="sidebar-nav">
                <a href="/ordenes.html" class="nav-item" data-tooltip="Ordenes">
                    <i data-feather="clipboard-list"></i>
                    <span>Ordenes</span>
                </a>
                <a href="/nueva-orden.html" class="nav-item" data-tooltip="Nueva Orden">
                    <i data-feather="plus-circle"></i>
                    <span>Nueva Orden</span>
                </a>
                <a href="/subir-lote.html" target="_blank" class="nav-item" data-tooltip="Subir Lote">
                    <i data-feather="upload"></i>
                    <span>Subir Lote</span>
                </a>
                <a href="/medicos.html" class="nav-item" data-tooltip="M√©dicos">
                    <i data-feather="users"></i>
                    <span>M√©dicos</span>
                </a>
                <a href="/examenes.html" class="nav-item" data-tooltip="Ex√°menes">
                    <i data-feather="activity"></i>
                    <span>Ex√°menes</span>
                </a>
                <a href="/empresas.html" class="nav-item" data-tooltip="Empresas">
                    <i data-feather="briefcase"></i>
                    <span>Empresas</span>
                </a>
                <a href="/panel-admin.html" class="nav-item" data-tooltip="Panel Admin">
                    <i data-feather="settings"></i>
                    <span>Panel Admin</span>
                </a>
                <a href="/panel-rips.html" class="nav-item active" data-tooltip="Panel RIPS">
                    <i data-feather="file-text"></i>
                    <span>Panel RIPS</span>
                </a>
                <a href="https://bsl-plataforma.com/panel-empresas.html" class="nav-item" target="_blank" data-tooltip="Panel Empresas">
                    <i data-feather="grid"></i>
                    <span>Panel Empresas</span>
                </a>
            </nav>
        </aside>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-search">
                <i data-feather="search"></i>
                <input type="text" placeholder="Buscar en panel RIPS...">
            </div>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                <i data-feather="moon" id="themeIcon"></i>
                <span id="themeText">Dark</span>
            </button>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>
                        <i data-feather="file-text"></i>
                        Panel de Generaci√≥n RIPS
                    </h1>
                    <p>Registro Individual de Prestaci√≥n de Servicios de Salud - Resoluci√≥n 2275 de 2023</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab(0)">
                    Configuraci√≥n de Ex√°menes
                </button>
                <button class="tab" onclick="cambiarTab(1)">
                    Generar RIPS
                </button>
                <button class="tab" onclick="cambiarTab(2)">
                    Hist√≥rico
                </button>
            </div>

            <!-- TAB 1: Configuraci√≥n de Ex√°menes -->
            <div class="tab-content active" id="tab-examenes">
                <div class="section">
                    <p class="section-description">
                        Configure los c√≥digos CUPS, grupos de servicio y precios para cada examen que ofrece BSL.
                        Estos datos son obligatorios para generar los archivos RIPS.
                    </p>

                    <div class="alert alert-info">
                        <span>‚ÑπÔ∏è</span>
                        <div>
                            <strong>Importante:</strong> Todos los ex√°menes deben tener c√≥digo CUPS configurado para poder generar RIPS.
                            Los c√≥digos CUPS deben obtenerse de las tablas oficiales SISPRO del Ministerio de Salud.
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-success" onclick="guardarExamenes()">
                            üíæ Guardar Cambios
                        </button>
                        <button class="btn btn-secondary" onclick="cargarExamenes()">
                            üîÑ Recargar
                        </button>
                    </div>

                    <div class="table-container" style="margin-top: 20px;">
                        <table class="data-table" id="tabla-examenes">
                            <thead>
                                <tr>
                                    <th>Nombre del Examen</th>
                                    <th style="width: 150px">C√≥digo CUPS</th>
                                    <th style="width: 120px">Grupo</th>
                                    <th style="width: 150px">Precio ($)</th>
                                    <th style="width: 100px">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="examenes-tbody">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <div class="loading active">
                                            <div class="spinner"></div>
                                            <p>Cargando ex√°menes...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Generar RIPS -->
            <div class="tab-content" id="tab-generar">
                <div class="section">
                    <p class="section-description">
                        Genere el archivo RIPS en formato JSON para un periodo espec√≠fico.
                        El sistema incluir√° todos los pacientes atendidos en el rango de fechas seleccionado.
                    </p>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha-inicio">Fecha Inicio</label>
                            <input type="date" id="fecha-inicio" required>
                        </div>
                        <div class="form-group">
                            <label for="fecha-fin">Fecha Fin</label>
                            <input type="date" id="fecha-fin" required>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-primary" onclick="generarRIPS()">
                            üìã Generar RIPS
                        </button>
                    </div>

                    <div id="resultado-generacion" style="margin-top: 30px; display: none;">
                        <div class="stat-grid" id="stats-rips"></div>

                        <div id="errores-rips" style="display: none;"></div>

                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">Vista Previa JSON</h3>
                        <div class="json-preview" id="json-preview"></div>

                        <div class="actions">
                            <button class="btn btn-success" onclick="descargarRIPS()">
                                üíæ Descargar JSON
                            </button>
                            <button class="btn btn-primary" onclick="exportarRIPS()">
                                üì§ Guardar Exportaci√≥n
                            </button>
                        </div>
                    </div>

                    <div class="loading" id="loading-generar">
                        <div class="spinner"></div>
                        <p>Generando archivo RIPS...</p>
                    </div>
                </div>
            </div>

            <!-- TAB 3: Hist√≥rico -->
            <div class="tab-content" id="tab-historico">
                <div class="section">
                    <p class="section-description">
                        Consulte y descargue archivos RIPS generados anteriormente.
                    </p>

                    <button class="btn btn-secondary" onclick="cargarHistorico()" style="margin-bottom: 20px;">
                        üîÑ Actualizar
                    </button>

                    <div class="table-container">
                        <table class="data-table" id="tabla-historico">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Periodo</th>
                                    <th>Fecha Generaci√≥n</th>
                                    <th>Registros</th>
                                    <th>Pacientes</th>
                                    <th>Estado</th>
                                    <th>Usuario</th>
                                    <th style="width: 150px">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historico-tbody">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <div class="loading active">
                                            <div class="spinner"></div>
                                            <p>Cargando hist√≥rico...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        // Initialize feather icons
        feather.replace();

        // Estado global
        let examenes = [];
        let ripsGenerado = null;
        let usuarioActual = null;

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const body = document.body;
            sidebar.classList.toggle('collapsed');
            body.classList.toggle('sidebar-collapsed');
            feather.replace();
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme');
                themeIcon.setAttribute('data-feather', 'moon');
                themeText.textContent = 'Dark';
            } else {
                html.setAttribute('data-theme', 'dark');
                themeIcon.setAttribute('data-feather', 'sun');
                themeText.textContent = 'Light';
            }

            feather.replace();
        }

        // Cambiar entre tabs
        function cambiarTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });

            // Cargar datos al cambiar a tab
            if (index === 0) cargarExamenes();
            if (index === 2) cargarHistorico();
        }

        // FUNCIONES TAB 1: Configuraci√≥n de Ex√°menes
        async function cargarExamenes() {
            try {
                const response = await fetch('/api/rips/examenes', {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                const data = await response.json();
                if (data.success) {
                    examenes = data.data;
                    renderizarTablaExamenes();
                }
            } catch (error) {
                console.error('Error cargando ex√°menes:', error);
                alert('Error al cargar ex√°menes');
            }
        }

        function renderizarTablaExamenes() {
            const tbody = document.getElementById('examenes-tbody');

            if (examenes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <p>No hay ex√°menes configurados</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = examenes.map((examen, index) => `
                <tr>
                    <td><strong>${examen.nombre}</strong></td>
                    <td>
                        <input type="text"
                               value="${examen.codigo_cups || ''}"
                               placeholder="Ej: 890314"
                               onchange="actualizarExamen(${index}, 'codigo_cups', this.value)">
                    </td>
                    <td>
                        <select onchange="actualizarExamen(${index}, 'grupo_servicio', this.value)">
                            <option value="">Seleccionar</option>
                            <option value="01" ${examen.grupo_servicio === '01' ? 'selected' : ''}>01 - Consulta</option>
                            <option value="03" ${examen.grupo_servicio === '03' ? 'selected' : ''}>03 - Apoyo diagn√≥stico</option>
                            <option value="04" ${examen.grupo_servicio === '04' ? 'selected' : ''}>04 - Quir√∫rgico</option>
                        </select>
                    </td>
                    <td>
                        <input type="number"
                               value="${examen.precio || 0}"
                               min="0"
                               step="1000"
                               onchange="actualizarExamen(${index}, 'precio', this.value)">
                    </td>
                    <td>
                        ${examen.codigo_cups ?
                            '<span class="badge badge-success">‚úì Configurado</span>' :
                            '<span class="badge badge-warning">‚ö†Ô∏è Sin CUPS</span>'
                        }
                    </td>
                </tr>
            `).join('');
        }

        function actualizarExamen(index, campo, valor) {
            examenes[index][campo] = valor;
        }

        async function guardarExamenes() {
            try {
                const promises = examenes.map(examen =>
                    fetch(`/api/rips/examenes/${examen.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${Auth.getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            codigo_cups: examen.codigo_cups,
                            grupo_servicio: examen.grupo_servicio,
                            precio: examen.precio,
                            descripcion: examen.descripcion
                        })
                    })
                );

                await Promise.all(promises);
                alert('‚úÖ Ex√°menes guardados correctamente');
                cargarExamenes();
            } catch (error) {
                console.error('Error guardando ex√°menes:', error);
                alert('‚ùå Error al guardar ex√°menes');
            }
        }

        // FUNCIONES TAB 2: Generar RIPS
        async function generarRIPS() {
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;

            if (!fechaInicio || !fechaFin) {
                alert('Por favor seleccione ambas fechas');
                return;
            }

            const loading = document.getElementById('loading-generar');
            const resultado = document.getElementById('resultado-generacion');

            loading.classList.add('active');
            resultado.style.display = 'none';

            try {
                const response = await fetch(
                    `/api/rips/generar?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`,
                    { headers: { 'Authorization': `Bearer ${Auth.getToken()}` } }
                );

                const data = await response.json();

                if (data.success) {
                    ripsGenerado = data;
                    mostrarResultado(data);
                } else {
                    // Hay errores de ex√°menes sin CUPS
                    mostrarErroresCUPS(data.errores);
                }
            } catch (error) {
                console.error('Error generando RIPS:', error);
                alert('Error al generar RIPS');
            } finally {
                loading.classList.remove('active');
            }
        }

        function mostrarResultado(data) {
            const resultado = document.getElementById('resultado-generacion');
            const stats = document.getElementById('stats-rips');
            const preview = document.getElementById('json-preview');
            const erroresDiv = document.getElementById('errores-rips');

            // Ocultar errores si hubo alguno previo
            erroresDiv.style.display = 'none';

            // Stats
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="label">Total Pacientes</div>
                    <div class="value">${data.metadata.totalPacientes}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Consultas</div>
                    <div class="value">${data.metadata.totalConsultas}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Registros</div>
                    <div class="value">${data.metadata.totalRegistros}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Periodo</div>
                    <div class="value" style="font-size: 14px;">${data.metadata.periodoInicio} al ${data.metadata.periodoFin}</div>
                </div>
            `;

            // Preview JSON (limitado)
            const jsonStr = JSON.stringify(data.rips, null, 2);
            preview.textContent = jsonStr.length > 10000
                ? jsonStr.substring(0, 10000) + '\n\n... (JSON truncado, descargue el archivo completo)'
                : jsonStr;

            resultado.style.display = 'block';
        }

        function mostrarErroresCUPS(errores) {
            const erroresDiv = document.getElementById('errores-rips');
            const resultado = document.getElementById('resultado-generacion');

            if (!errores || errores.length === 0) {
                erroresDiv.style.display = 'none';
                return;
            }

            const examenesUnicos = new Set();
            errores.forEach(error => {
                error.examenesNoConfigurados.forEach(ex => examenesUnicos.add(ex));
            });

            erroresDiv.innerHTML = `
                <div class="alert alert-error">
                    <span>‚ùå</span>
                    <div>
                        <strong>No se puede generar RIPS</strong><br>
                        Los siguientes ex√°menes no tienen c√≥digo CUPS configurado:
                        <ul style="margin-top: 8px; padding-left: 20px;">
                            ${Array.from(examenesUnicos).map(ex => `<li>${ex}</li>`).join('')}
                        </ul>
                        <p style="margin-top: 12px;">
                            Por favor, configure los c√≥digos CUPS en la pesta√±a
                            <a href="#" onclick="cambiarTab(0); return false;" style="color: #991b1b; text-decoration: underline;">
                                <strong>Configuraci√≥n de Ex√°menes</strong>
                            </a>
                        </p>
                    </div>
                </div>
            `;

            erroresDiv.style.display = 'block';
            resultado.style.display = 'block';
        }

        function descargarRIPS() {
            if (!ripsGenerado) return;

            const blob = new Blob([JSON.stringify(ripsGenerado.rips, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RIPS_${ripsGenerado.metadata.periodoInicio}_${ripsGenerado.metadata.periodoFin}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportarRIPS() {
            if (!ripsGenerado) return;

            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;

            try {
                const response = await fetch('/api/rips/exportar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fecha_inicio: fechaInicio, fecha_fin: fechaFin })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nID de exportaci√≥n: ${data.exportacionId}`);
                    cambiarTab(2); // Ir a hist√≥rico
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('Error exportando RIPS:', error);
                alert('Error al guardar exportaci√≥n');
            }
        }

        // FUNCIONES TAB 3: Hist√≥rico
        async function cargarHistorico() {
            try {
                const response = await fetch('/api/rips/exportaciones', {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                const data = await response.json();
                if (data.success) {
                    renderizarHistorico(data.data);
                }
            } catch (error) {
                console.error('Error cargando hist√≥rico:', error);
                alert('Error al cargar hist√≥rico');
            }
        }

        function renderizarHistorico(exportaciones) {
            const tbody = document.getElementById('historico-tbody');

            if (exportaciones.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <p>No hay exportaciones RIPS a√∫n</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = exportaciones.map(exp => {
                const fecha = new Date(exp.fecha_generacion).toLocaleString('es-CO');
                const periodo = `${exp.periodo_inicio} - ${exp.periodo_fin}`;

                let estadoBadge = '';
                if (exp.estado === 'generado') {
                    estadoBadge = '<span class="badge badge-success">‚úì Generado</span>';
                } else if (exp.estado === 'generado_con_advertencias') {
                    estadoBadge = '<span class="badge badge-warning">‚ö†Ô∏è Con advertencias</span>';
                } else {
                    estadoBadge = `<span class="badge badge-error">${exp.estado}</span>`;
                }

                return `
                    <tr>
                        <td><strong>#${exp.id}</strong></td>
                        <td>${periodo}</td>
                        <td>${fecha}</td>
                        <td>${exp.total_registros}</td>
                        <td>${exp.total_pacientes}</td>
                        <td>${estadoBadge}</td>
                        <td>${exp.usuario_generador}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;"
                                    onclick="descargarExportacion(${exp.id})">
                                üì• Descargar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function descargarExportacion(id) {
            try {
                window.open(`/api/rips/exportaciones/${id}/download`, '_blank');
            } catch (error) {
                console.error('Error descargando exportaci√≥n:', error);
                alert('Error al descargar archivo');
            }
        }

        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', async () => {
            // Proteger p√°gina - solo admin puede acceder
            usuarioActual = await Auth.protegerPagina(['admin']);
            if (!usuarioActual) return;

            // Actualizar nombre en topbar (con retry por si a√∫n no est√° cargado)
            const updateTopbar = () => {
                if (typeof window.updateTopbarUserName === 'function') {
                    window.updateTopbarUserName(usuarioActual);
                } else {
                    setTimeout(updateTopbar, 50);
                }
            };
            updateTopbar();

            // Initialize feather icons
            feather.replace();

            cargarExamenes();

            // Setear fecha de hoy por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-fin').value = hoy;

            // Primer d√≠a del mes
            const primerDia = new Date();
            primerDia.setDate(1);
            document.getElementById('fecha-inicio').value = primerDia.toISOString().split('T')[0];
        });
    </script>
</body>
</html>
