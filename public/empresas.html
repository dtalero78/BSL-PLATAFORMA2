<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Empresas - BSL Sistema M√©dico</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #F3F3F3;
            color: #181818;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #E5E7EB;
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid #E5E7EB;
            margin-bottom: 16px;
            text-align: center;
        }

        .sidebar-logo img {
            max-width: 140px;
            height: auto;
        }

        .sidebar-logo span {
            display: block;
            font-size: 11px;
            color: #6B7280;
            font-weight: 400;
            margin-top: 8px;
        }

        .sidebar-nav {
            padding: 0 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #4B5563;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: all 0.15s ease;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #F3F4F6;
            color: #111827;
        }

        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        /* Top Bar Fijo */
        .top-bar {
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            height: 64px;
            background: white;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            padding: 0 32px;
            z-index: 100;
        }

        .top-bar-search {
            position: relative;
            width: 400px;
        }

        .top-bar-search input {
            width: 100%;
            padding: 10px 16px 10px 42px;
            border: 1px solid #E5E7EB;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: #F9FAFB;
            transition: all 0.2s ease;
        }

        .top-bar-search input:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: white;
        }

        .top-bar-search input::placeholder {
            color: #9CA3AF;
        }

        .top-bar-search svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            width: 18px;
            height: 18px;
            pointer-events: none;
        }

        /* Main content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 32px;
            padding-top: 96px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #2563EB;
            color: white;
        }

        .btn-primary:hover {
            background: #1D4ED8;
        }

        .btn-secondary {
            background: #F3F4F6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #E5E7EB;
        }

        .btn-danger {
            background: #FEE2E2;
            color: #DC2626;
        }

        .btn-danger:hover {
            background: #FECACA;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 20px;
            text-align: left;
        }

        th {
            background: #F9FAFB;
            font-size: 12px;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #E5E7EB;
        }

        td {
            font-size: 14px;
            color: #1F2937;
            border-bottom: 1px solid #F3F4F6;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #F9FAFB;
        }

        .empresa-code {
            font-family: monospace;
            background: #E6F7FA;
            color: #0099B2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-actions .btn {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6B7280;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #111827;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-label .required {
            color: #EF4444;
            margin-left: 2px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 10px 14px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 14px;
            color: #1F2937;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #0099B2;
            box-shadow: 0 0 0 3px rgba(0, 153, 178, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Secci√≥n de configuraci√≥n */
        .config-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #E5E7EB;
        }

        .config-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-section-title svg {
            width: 16px;
            height: 16px;
            color: #6B7280;
        }

        /* Chips container */
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            min-height: 48px;
            background: #F9FAFB;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #0099B2;
            color: white;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .chip-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            opacity: 0.8;
        }

        .chip-remove:hover {
            opacity: 1;
        }

        /* Add input */
        .add-input-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .add-input-container input,
        .add-input-container select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 13px;
        }

        .btn-add {
            padding: 8px 16px;
            background: #10B981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-add:hover {
            background: #059669;
        }

        /* Dropdown con checkboxes */
        .dropdown-select {
            position: relative;
        }

        .dropdown-toggle {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-toggle:hover {
            border-color: #9CA3AF;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 13px;
        }

        .dropdown-item:hover {
            background: #F3F4F6;
        }

        .dropdown-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #0099B2;
        }

        .dropdown-search {
            padding: 10px 14px;
            border-bottom: 1px solid #E5E7EB;
        }

        .dropdown-search input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 13px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: #6B7280;
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* Loading */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #E5E7EB;
            border-top-color: #0099B2;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .page-header-left {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .page-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
            }

            .table-container {
                overflow-x: auto;
            }
        }
        /* Men√∫ con subitems desplegables */
        .nav-group {
            position: relative;
        }

        .nav-item.has-submenu {
            cursor: pointer;
        }

        .nav-item.has-submenu::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid #64748B;
            margin-left: auto;
            transition: transform 0.2s ease;
        }

        .nav-group.open .nav-item.has-submenu::after {
            transform: rotate(180deg);
        }

        .nav-submenu {
            display: none;
            overflow: hidden;
        }

        .nav-group.open .nav-submenu {
            display: block;
        }

        .nav-submenu .nav-item {
            padding-left: 44px;
            font-size: 13px;
        }

        .nav-submenu .nav-item i {
            width: 16px;
            height: 16px;
        }

    </style>
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <!-- Sidebar (cargado din√°micamente) -->
        <div id="sidebar-container"></div>

        <!-- Top Bar con buscador global -->
        <!-- Top Bar (cargado din√°micamente) -->
        <div id="topbar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div class="page-header-left">
                    <h1 class="page-title">Gesti√≥n de Empresas</h1>
                </div>
                <button class="btn btn-primary" onclick="abrirModalNuevo()">
                    <i data-feather="plus"></i> Nueva Empresa
                </button>
            </div>

            <div id="loadingState" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Cargando empresas...</p>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon"><i data-feather="briefcase" style="width:48px;height:48px;stroke:#9CA3AF;"></i></div>
                <h3 class="empty-state-title">No hay empresas registradas</h3>
                <p class="empty-state-text">Agrega la primera empresa para comenzar</p>
                <button class="btn btn-primary" onclick="abrirModalNuevo()">
                    <i data-feather="plus"></i> Nueva Empresa
                </button>
            </div>

            <div id="tableContainer" class="table-container" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Empresa</th>
                            <th>NIT</th>
                            <th>Profesiograma</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="empresasBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal Crear/Editar -->
    <div class="modal" id="modalEmpresa">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nueva Empresa</h2>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <form id="formEmpresa">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">C√≥digo Empresa <span class="required">*</span></label>
                            <input type="text" class="form-input" name="codEmpresa" required placeholder="Ej: SIIGO">
                        </div>
                        <div class="form-group">
                            <label class="form-label">NIT</label>
                            <input type="text" class="form-input" name="nit" placeholder="Ej: 900.123.456-7">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Nombre Empresa <span class="required">*</span></label>
                            <input type="text" class="form-input" name="empresa" required placeholder="Nombre completo de la empresa">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Profesiograma</label>
                            <textarea class="form-textarea" name="profesiograma" placeholder="Descripci√≥n del profesiograma o requerimientos especiales..."></textarea>
                        </div>
                    </div>

                    <!-- Secci√≥n Ciudades -->
                    <div class="config-section">
                        <div class="config-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            Ciudades disponibles para √≥rdenes
                        </div>
                        <div class="chips-container" id="ciudadesChips">
                            <span style="color: #9CA3AF; font-size: 13px;">Sin ciudades configuradas (se mostrar√°n todas)</span>
                        </div>
                        <div class="add-input-container">
                            <select id="selectCiudad">
                                <option value="">Seleccionar ciudad...</option>
                            </select>
                            <button type="button" class="btn-add" onclick="agregarCiudad()">Agregar</button>
                        </div>
                    </div>

                    <!-- Secci√≥n Ex√°menes -->
                    <div class="config-section">
                        <div class="config-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            Ex√°menes m√©dicos disponibles
                        </div>
                        <div class="chips-container" id="examenesChips">
                            <span style="color: #9CA3AF; font-size: 13px;">Sin ex√°menes configurados (se mostrar√°n todos)</span>
                        </div>
                        <div class="add-input-container">
                            <select id="selectExamen">
                                <option value="">Seleccionar examen...</option>
                            </select>
                            <button type="button" class="btn-add" onclick="agregarExamen()">Agregar</button>
                        </div>
                    </div>

                    <!-- Secci√≥n Subempresas -->
                    <div class="config-section">
                        <div class="config-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            Subempresas / Sedes
                        </div>
                        <div class="chips-container" id="subempresasChips">
                            <span style="color: #9CA3AF; font-size: 13px;">Sin subempresas configuradas</span>
                        </div>
                        <div class="add-input-container">
                            <input type="text" id="inputSubempresa" placeholder="Nombre de la subempresa o sede...">
                            <button type="button" class="btn-add" onclick="agregarSubempresa()">Agregar</button>
                        </div>
                    </div>

                    <!-- Secci√≥n Centros de Costo -->
                    <div class="config-section">
                        <div class="config-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                            Centros de Costo
                        </div>
                        <div class="chips-container" id="centrosCostoChips">
                            <span style="color: #9CA3AF; font-size: 13px;">Sin centros de costo configurados</span>
                        </div>
                        <div class="add-input-container">
                            <input type="text" id="inputCentroCosto" placeholder="Un centro o varios separados por coma...">
                            <button type="button" class="btn-add" onclick="agregarCentroCosto()">Agregar</button>
                        </div>
                        <div style="font-size: 11px; color: #9CA3AF; margin-top: 4px;">
                            Tip: Puedes pegar varios valores separados por coma (ej: Centro1, Centro2, Centro3)
                        </div>
                    </div>

                    <!-- Secci√≥n Cargos -->
                    <div class="config-section">
                        <div class="config-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            Cargos predeterminados
                        </div>
                        <div class="chips-container" id="cargosChips">
                            <span style="color: #9CA3AF; font-size: 13px;">Sin cargos configurados (campo de texto libre)</span>
                        </div>
                        <div class="add-input-container">
                            <input type="text" id="inputCargo" placeholder="Un cargo o varios separados por coma...">
                            <button type="button" class="btn-add" onclick="agregarCargo()">Agregar</button>
                        </div>
                        <div style="font-size: 11px; color: #9CA3AF; margin-top: 4px;">
                            Si se configuran cargos, aparecer√°n como dropdown en Nueva Orden
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
                </div>
            </form>
            <div style="text-align: center; padding: 4px; font-size: 10px; color: #94a3b8; border-top: 1px solid #e2e8f0;">modalEmpresa</div>
        </div>
    </div>

    <script>
        let empresas = [];
        let empresaEditando = null;
        let ciudadesSeleccionadas = [];
        let examenesSeleccionados = [];
        let subempresasSeleccionadas = [];
        let centrosCostoSeleccionados = [];
        let cargosSeleccionados = [];
        let todasLasCiudades = [];
        let todosLosExamenes = [];

        // Lista de ciudades de Colombia
        const CIUDADES_COLOMBIA = [
            'Bogota', 'Medellin', 'Cali', 'Barranquilla', 'Cartagena',
            'Bucaramanga', 'Cucuta', 'Pereira', 'Santa Marta', 'Ibague',
            'Manizales', 'Villavicencio', 'Pasto', 'Monteria', 'Neiva',
            'Armenia', 'Valledupar', 'Popayan', 'Sincelejo', 'Tunja',
            'Florencia', 'Riohacha', 'Quibdo', 'Yopal', 'Mocoa',
            'Leticia', 'Puerto Carreno', 'Inirida', 'Mitu', 'San Jose del Guaviare',
            'Arauca', 'San Andres', 'Sogamoso', 'Duitama', 'Zipaquira'
        ].sort();

        // Buscar √≥rdenes globalmente
        function buscarGlobal(event) {
            if (event.key === 'Enter') {
                const query = event.target.value.trim();
                if (query) {
                    window.location.href = `/ordenes.html?buscar=${encodeURIComponent(query)}`;
                }
            }
        }

        // Cargar empresas al iniciar
        document.addEventListener('DOMContentLoaded', () => {
        // Proteger p√°gina con autenticaci√≥n
        Auth.protegerPagina(["admin","ADMIN","usuario_ips"]).then(usuarioActual => {
            if (!usuarioActual) return; // Redirigido a login

            // Usuario autenticado, continuar con inicializaci√≥n
            console.log('Usuario autenticado:', usuarioActual.nombre);

            // Actualizar nombre en topbar (con retry por si a√∫n no est√° cargado)
            const updateTopbar = () => {
                if (typeof window.updateTopbarUserName === 'function') {
                    window.updateTopbarUserName(usuarioActual);
                } else {
                    setTimeout(updateTopbar, 50);
                }
            };
            updateTopbar();

            feather.replace();
            cargarEmpresas();
            cargarExamenesDisponibles();
            cargarCiudadesDisponibles();
        }); // Fin Auth.protegerPagina
        });

        // Cargar ex√°menes del servidor
        async function cargarExamenesDisponibles() {
            try {
                const response = await fetch('/api/examenes');
                const result = await response.json();
                // El endpoint retorna un array directamente
                if (Array.isArray(result)) {
                    todosLosExamenes = result;
                    actualizarSelectExamenes();
                }
            } catch (error) {
                console.error('Error al cargar ex√°menes:', error);
            }
        }

        // Cargar ciudades disponibles
        function cargarCiudadesDisponibles() {
            todasLasCiudades = CIUDADES_COLOMBIA;
            actualizarSelectCiudades();
        }

        // Actualizar select de ciudades
        function actualizarSelectCiudades() {
            const select = document.getElementById('selectCiudad');
            const ciudadesDisponibles = todasLasCiudades.filter(c => !ciudadesSeleccionadas.includes(c));
            select.innerHTML = '<option value="">Seleccionar ciudad...</option>' +
                ciudadesDisponibles.map(ciudad => `<option value="${ciudad}">${ciudad}</option>`).join('');
        }

        // Actualizar select de ex√°menes
        function actualizarSelectExamenes() {
            const select = document.getElementById('selectExamen');
            const examenesDisponibles = todosLosExamenes.filter(e => !examenesSeleccionados.includes(e.nombre));
            select.innerHTML = '<option value="">Seleccionar examen...</option>' +
                examenesDisponibles.map(examen => `<option value="${examen.nombre}">${examen.nombre}</option>`).join('');
        }

        // Funciones para agregar items
        function agregarCiudad() {
            const select = document.getElementById('selectCiudad');
            const ciudad = select.value;
            if (ciudad && !ciudadesSeleccionadas.includes(ciudad)) {
                ciudadesSeleccionadas.push(ciudad);
                renderChips('ciudadesChips', ciudadesSeleccionadas, 'ciudad');
                actualizarSelectCiudades();
            }
        }

        function agregarExamen() {
            const select = document.getElementById('selectExamen');
            const examen = select.value;
            if (examen && !examenesSeleccionados.includes(examen)) {
                examenesSeleccionados.push(examen);
                renderChips('examenesChips', examenesSeleccionados, 'examen');
                actualizarSelectExamenes();
            }
        }

        function agregarSubempresa() {
            const input = document.getElementById('inputSubempresa');
            const subempresa = input.value.trim();
            if (subempresa && !subempresasSeleccionadas.includes(subempresa)) {
                subempresasSeleccionadas.push(subempresa);
                renderChips('subempresasChips', subempresasSeleccionadas, 'subempresa');
                input.value = '';
            }
        }

        // Funciones para eliminar items
        function eliminarCiudad(ciudad) {
            ciudadesSeleccionadas = ciudadesSeleccionadas.filter(c => c !== ciudad);
            renderChips('ciudadesChips', ciudadesSeleccionadas, 'ciudad');
            actualizarSelectCiudades();
        }

        function eliminarExamen(examen) {
            examenesSeleccionados = examenesSeleccionados.filter(e => e !== examen);
            renderChips('examenesChips', examenesSeleccionados, 'examen');
            actualizarSelectExamenes();
        }

        function eliminarSubempresa(subempresa) {
            subempresasSeleccionadas = subempresasSeleccionadas.filter(s => s !== subempresa);
            renderChips('subempresasChips', subempresasSeleccionadas, 'subempresa');
        }

        function agregarCentroCosto() {
            const input = document.getElementById('inputCentroCosto');
            const valor = input.value.trim();
            if (!valor) return;

            // Soporta m√∫ltiples valores separados por coma
            const centros = valor.split(',').map(c => c.trim()).filter(c => c.length > 0);
            let agregados = 0;

            centros.forEach(centroCosto => {
                if (centroCosto && !centrosCostoSeleccionados.includes(centroCosto)) {
                    centrosCostoSeleccionados.push(centroCosto);
                    agregados++;
                }
            });

            if (agregados > 0) {
                renderChips('centrosCostoChips', centrosCostoSeleccionados, 'centroCosto');
            }
            input.value = '';
        }

        function eliminarCentroCosto(centroCosto) {
            centrosCostoSeleccionados = centrosCostoSeleccionados.filter(c => c !== centroCosto);
            renderChips('centrosCostoChips', centrosCostoSeleccionados, 'centroCosto');
        }

        function agregarCargo() {
            const input = document.getElementById('inputCargo');
            const valor = input.value.trim();
            if (!valor) return;

            // Soporta m√∫ltiples valores separados por coma
            const cargos = valor.split(',').map(c => c.trim()).filter(c => c.length > 0);
            let agregados = 0;

            cargos.forEach(cargo => {
                if (cargo && !cargosSeleccionados.includes(cargo)) {
                    cargosSeleccionados.push(cargo);
                    agregados++;
                }
            });

            if (agregados > 0) {
                renderChips('cargosChips', cargosSeleccionados, 'cargo');
            }
            input.value = '';
        }

        function eliminarCargo(cargo) {
            cargosSeleccionados = cargosSeleccionados.filter(c => c !== cargo);
            renderChips('cargosChips', cargosSeleccionados, 'cargo');
        }

        // Renderizar chips
        function renderChips(containerId, items, tipo) {
            const container = document.getElementById(containerId);
            if (items.length === 0) {
                const mensajes = {
                    ciudad: 'Sin ciudades configuradas (se mostrar√°n todas)',
                    examen: 'Sin ex√°menes configurados (se mostrar√°n todos)',
                    subempresa: 'Sin subempresas configuradas',
                    centroCosto: 'Sin centros de costo configurados',
                    cargo: 'Sin cargos configurados (campo de texto libre)'
                };
                container.innerHTML = `<span style="color: #9CA3AF; font-size: 13px;">${mensajes[tipo]}</span>`;
                return;
            }

            container.innerHTML = items.map(item => `
                <span class="chip">
                    ${item}
                    <button type="button" class="chip-remove" onclick="eliminar${tipo.charAt(0).toUpperCase() + tipo.slice(1)}('${item.replace(/'/g, "\\'")}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </span>
            `).join('');
        }

        // Limpiar selecciones del modal
        function limpiarSelecciones() {
            ciudadesSeleccionadas = [];
            examenesSeleccionados = [];
            subempresasSeleccionadas = [];
            centrosCostoSeleccionados = [];
            cargosSeleccionados = [];
            renderChips('ciudadesChips', [], 'ciudad');
            renderChips('examenesChips', [], 'examen');
            renderChips('subempresasChips', [], 'subempresa');
            renderChips('centrosCostoChips', [], 'centroCosto');
            renderChips('cargosChips', [], 'cargo');
            actualizarSelectCiudades();
            actualizarSelectExamenes();
        }

        async function cargarEmpresas() {
            try {
                const response = await fetch('/api/empresas');
                const result = await response.json();

                document.getElementById('loadingState').style.display = 'none';

                if (!result.success || result.total === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('tableContainer').style.display = 'none';
                    return;
                }

                empresas = result.data;
                renderEmpresas();

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>Error al cargar empresas</p>
                `;
            }
        }

        function renderEmpresas() {
            const tbody = document.getElementById('empresasBody');
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';

            tbody.innerHTML = empresas.map(empresa => `
                <tr>
                    <td><span class="empresa-code">${empresa.cod_empresa}</span></td>
                    <td>${empresa.empresa}</td>
                    <td>${empresa.nit || '‚Äî'}</td>
                    <td>${empresa.profesiograma ? empresa.profesiograma.substring(0, 50) + (empresa.profesiograma.length > 50 ? '...' : '') : '‚Äî'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="editarEmpresa(${empresa.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger" onclick="eliminarEmpresa(${empresa.id}, '${empresa.empresa}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalNuevo() {
            empresaEditando = null;
            document.getElementById('modalTitle').textContent = 'Nueva Empresa';
            document.getElementById('formEmpresa').reset();
            limpiarSelecciones();
            document.getElementById('modalEmpresa').classList.add('active');
        }

        async function editarEmpresa(id) {
            try {
                const response = await fetch(`/api/empresas/${id}`);
                const result = await response.json();

                if (!result.success) {
                    alert('Error al cargar empresa');
                    return;
                }

                const empresa = result.data;
                empresaEditando = id;

                document.getElementById('modalTitle').textContent = 'Editar Empresa';

                const form = document.getElementById('formEmpresa');
                form.codEmpresa.value = empresa.cod_empresa || '';
                form.empresa.value = empresa.empresa || '';
                form.nit.value = empresa.nit || '';
                form.profesiograma.value = empresa.profesiograma || '';

                // Cargar configuraciones existentes
                ciudadesSeleccionadas = empresa.ciudades || [];
                examenesSeleccionados = empresa.examenes || [];
                subempresasSeleccionadas = empresa.subempresas || [];
                centrosCostoSeleccionados = empresa.centros_de_costo || [];
                cargosSeleccionados = empresa.cargos || [];

                renderChips('ciudadesChips', ciudadesSeleccionadas, 'ciudad');
                renderChips('examenesChips', examenesSeleccionados, 'examen');
                renderChips('subempresasChips', subempresasSeleccionadas, 'subempresa');
                renderChips('centrosCostoChips', centrosCostoSeleccionados, 'centroCosto');
                renderChips('cargosChips', cargosSeleccionados, 'cargo');
                actualizarSelectCiudades();
                actualizarSelectExamenes();

                document.getElementById('modalEmpresa').classList.add('active');

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar empresa');
            }
        }

        function cerrarModal() {
            document.getElementById('modalEmpresa').classList.remove('active');
        }

        document.getElementById('formEmpresa').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const datos = {
                codEmpresa: form.codEmpresa.value,
                empresa: form.empresa.value,
                nit: form.nit.value || null,
                profesiograma: form.profesiograma.value || null,
                ciudades: ciudadesSeleccionadas,
                examenes: examenesSeleccionados,
                subempresas: subempresasSeleccionadas,
                centrosDeCosto: centrosCostoSeleccionados,
                cargos: cargosSeleccionados
            };

            const btnGuardar = document.getElementById('btnGuardar');
            btnGuardar.disabled = true;
            btnGuardar.textContent = 'Guardando...';

            try {
                const url = empresaEditando ? `/api/empresas/${empresaEditando}` : '/api/empresas';
                const method = empresaEditando ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();

                if (result.success) {
                    cerrarModal();
                    cargarEmpresas();
                } else {
                    alert(result.message || 'Error al guardar');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar empresa');
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.textContent = 'Guardar';
            }
        });

        async function eliminarEmpresa(id, nombre) {
            if (!confirm(`¬øEst√°s seguro de eliminar la empresa "${nombre}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/empresas/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    cargarEmpresas();
                } else {
                    alert(result.message || 'Error al eliminar');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar empresa');
            }
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalEmpresa').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                cerrarModal();
            }
        });
    </script>
    <!-- Sistema de autenticaci√≥n -->
    <script src="/js/auth.js"></script>

    <!-- Cargar componentes compartidos -->
    <script src="/js/modal-disponibilidad.js"></script>
    <script src="/js/load-sidebar.js"></script>
    <script src="/js/load-topbar.js?v=3">

        // Toggle navigation group (para men√∫ con submen√∫s)
        function toggleNavGroup(element) {
            const group = element.closest('.nav-group');
            group.classList.toggle('open');
        }
</script>
</body>
</html>
