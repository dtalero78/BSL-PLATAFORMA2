<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audiometr√≠a Virtual - BSL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #F2F2F7;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: #1C1C1E;
            -webkit-font-smoothing: antialiased;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header estilo app */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0 16px;
        }

        .header-logo {
            height: 50px;
            width: auto;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            color: #1C1C1E;
            letter-spacing: -0.3px;
        }

        /* Paciente info card */
        .patient-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .patient-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #0099B2, #007A8C);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .patient-info {
            flex: 1;
        }

        .patient-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .patient-id {
            font-size: 14px;
            color: #8E8E93;
        }

        /* ========== PANTALLA DE BIENVENIDA ========== */
        .welcome-screen {
            display: flex;
            flex-direction: column;
        }

        .instructions-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .instructions-card h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions-card h2::before {
            content: "üéß";
        }

        .instruction-list {
            list-style: none;
        }

        .instruction-list li {
            padding: 12px 0;
            border-bottom: 0.5px solid #E5E5EA;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 15px;
            line-height: 1.4;
        }

        .instruction-list li:last-child {
            border-bottom: none;
        }

        .instruction-number {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: #007AFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.15s ease;
            margin-top: auto;
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: #0056b3;
        }

        .btn-primary:disabled {
            background: #C7C7CC;
            cursor: not-allowed;
        }

        /* ========== PANTALLA DE PRUEBA ========== */
        .test-screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .progress-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 15px;
            font-weight: 500;
            color: #8E8E93;
        }

        .progress-counter {
            font-size: 17px;
            font-weight: 600;
            color: #007AFF;
        }

        .progress-bar-container {
            height: 8px;
            background: #E5E5EA;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #5AC8FA);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Reproductor de audio */
        .audio-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            text-align: center;
        }

        .audio-status {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 16px;
            min-height: 24px;
        }

        .audio-status.playing {
            color: #34C759;
        }

        .audio-status.waiting {
            color: #FF9500;
        }

        .audio-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            height: 60px;
            margin-bottom: 16px;
        }

        .audio-bar {
            width: 6px;
            height: 20px;
            background: #007AFF;
            border-radius: 3px;
            animation: audioWave 0.5s ease-in-out infinite;
        }

        .audio-bar:nth-child(1) { animation-delay: 0s; }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes audioWave {
            0%, 100% { height: 20px; }
            50% { height: 50px; }
        }

        .audio-animation.paused .audio-bar {
            animation: none;
            height: 20px;
            background: #C7C7CC;
        }

        /* Teclado num√©rico */
        .keypad-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .keypad-title {
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .keypad-subtitle {
            text-align: center;
            font-size: 14px;
            color: #8E8E93;
            margin-bottom: 20px;
        }

        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 300px;
            margin: 0 auto;
        }

        .keypad-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 16px;
            background: #F2F2F7;
            font-size: 28px;
            font-weight: 600;
            color: #1C1C1E;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .keypad-btn:active {
            background: #007AFF;
            color: white;
            transform: scale(0.95);
        }

        .keypad-btn:disabled {
            background: #E5E5EA;
            color: #C7C7CC;
            cursor: not-allowed;
        }

        .keypad-btn.zero {
            grid-column: 2;
        }

        /* ========== PANTALLA DE RESULTADOS ========== */
        .results-screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .results-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .results-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .results-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .results-subtitle {
            font-size: 15px;
            color: #8E8E93;
            margin-bottom: 24px;
        }

        .results-summary {
            background: #F2F2F7;
            border-radius: 12px;
            padding: 16px;
            text-align: left;
        }

        .results-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 0.5px solid #E5E5EA;
        }

        .results-row:last-child {
            border-bottom: none;
        }

        .results-label {
            color: #8E8E93;
            font-size: 15px;
        }

        .results-value {
            font-weight: 600;
            font-size: 15px;
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            background: white;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E5E5EA;
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error state */
        .error-card {
            background: #FFF5F5;
            border: 1px solid #FF3B30;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .error-card p {
            color: #FF3B30;
            font-size: 15px;
        }

        /* WhatsApp button */
        .whatsapp-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: #25D366;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
            z-index: 100;
        }

        /* ========== MODAL DE VIDEO INTRODUCTORIO ========== */
        .video-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2147483647;
            opacity: 1;
            transition: opacity 0.5s ease;
            isolation: isolate;
        }

        .video-modal.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }

        .video-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2147483647;
        }

        .video-modal-content video {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .play-video-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(0, 153, 178, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .play-video-btn svg {
            width: 40px;
            height: 40px;
            color: white;
            margin-left: 5px;
        }

        .play-video-btn:hover {
            background: rgba(0, 153, 178, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .play-video-btn.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .skip-video-btn {
            margin-top: 20px;
            padding: 12px 32px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skip-video-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 380px) {
            .keypad-btn {
                font-size: 24px;
            }

            .play-video-btn {
                width: 60px;
                height: 60px;
            }

            .play-video-btn svg {
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Video Introductorio -->
    <div id="videoModal" class="video-modal">
        <div class="video-modal-content">
            <video id="modalVideo" playsinline>
                <source src="audiometriaVirtual.mp4" type="video/mp4">
                Tu navegador no soporta el video.
            </video>
            <button id="playVideoBtn" class="play-video-btn">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </button>
            <button id="skipVideoBtn" class="skip-video-btn">Omitir video</button>
        </div>
    </div>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="bsl-logo.png" alt="BSL" class="header-logo">
            <span class="header-title">AUDIOMETR√çA VIRTUAL</span>
        </div>

        <!-- Tarjeta de paciente -->
        <div class="patient-card" id="patientCard">
            <div class="patient-avatar" id="patientAvatar">--</div>
            <div class="patient-info">
                <div class="patient-name" id="patientName">Cargando...</div>
                <div class="patient-id" id="patientId">---</div>
            </div>
        </div>

        <!-- Error card -->
        <div class="error-card" id="errorCard">
            <p id="errorMessage"></p>
        </div>

        <!-- ========== PANTALLA DE BIENVENIDA ========== -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="instructions-card">
                <h2>Instrucciones</h2>
                <ul class="instruction-list">
                    <li>
                        <span class="instruction-number">1</span>
                        <span>Use aud√≠fonos en un lugar silencioso</span>
                    </li>
                    <li>
                        <span class="instruction-number">2</span>
                        <span>Escuchar√° tonos de diferentes frecuencias</span>
                    </li>
                    <li>
                        <span class="instruction-number">3</span>
                        <span>Indique cu√°ntos beeps escuch√≥ (1-7) o 0 si no escuch√≥ ninguno</span>
                    </li>
                </ul>
            </div>

            <button class="btn-primary" id="startBtn">
                Comenzar Prueba
            </button>
        </div>

        <!-- ========== PANTALLA DE PRUEBA ========== -->
        <div class="test-screen" id="testScreen">
            <!-- Progreso -->
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Progreso</span>
                    <span class="progress-counter" id="progressCounter">1 de 16</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>

            <!-- Estado del audio -->
            <div class="audio-section">
                <div class="audio-status" id="audioStatus">Preparando audio...</div>
                <div class="audio-animation" id="audioAnimation">
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                </div>
            </div>

            <!-- Teclado num√©rico -->
            <div class="keypad-section" id="keypadSection">
                <div class="keypad-title">¬øCu√°ntos beeps escuch√≥?</div>
                <div class="keypad-subtitle">Presione el n√∫mero correspondiente</div>
                <div class="keypad-grid">
                    <button class="keypad-btn" data-value="1">1</button>
                    <button class="keypad-btn" data-value="2">2</button>
                    <button class="keypad-btn" data-value="3">3</button>
                    <button class="keypad-btn" data-value="4">4</button>
                    <button class="keypad-btn" data-value="5">5</button>
                    <button class="keypad-btn" data-value="6">6</button>
                    <button class="keypad-btn" data-value="7">7</button>
                    <button class="keypad-btn" data-value="8">8</button>
                    <button class="keypad-btn" data-value="9">9</button>
                    <button class="keypad-btn zero" data-value="0">0</button>
                </div>
            </div>
        </div>

        <!-- ========== PANTALLA DE RESULTADOS ========== -->
        <div class="results-screen" id="resultsScreen">
            <div class="results-card">
                <div class="results-icon">‚úÖ</div>
                <div class="results-title">¬°Prueba Completada!</div>
                <div class="results-subtitle">Sus resultados han sido guardados correctamente</div>

                <div class="results-summary">
                    <div class="results-row">
                        <span class="results-label">Paciente</span>
                        <span class="results-value" id="resultPatient">---</span>
                    </div>
                    <div class="results-row">
                        <span class="results-label">Documento</span>
                        <span class="results-value" id="resultDoc">---</span>
                    </div>
                    <div class="results-row">
                        <span class="results-label">Pruebas realizadas</span>
                        <span class="results-value">16 de 16</span>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="continueBtn">
                Continuar
            </button>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Guardando resultados...</p>
        </div>
    </div>

    <!-- WhatsApp button -->
    <a href="https://api.whatsapp.com/send?phone=573008021701&text=Hola.%20Requiero%20soporte%20con%20la%20audiometr%C3%ADa%20virtual"
       target="_blank"
       class="whatsapp-btn">
        üí¨
    </a>

    <!-- Audio player (hidden) -->
    <audio id="audioPlayer" preload="auto"></audio>

    <script>
        // ==========================================
        // CONFIGURACI√ìN DE AUDIOS
        // ==========================================
        const audios = [
            // O√≠do Derecho (R = Right)
            { name: "8000R", url: "https://static.wixstatic.com/mp3/cb6469_d06b935537374e2a968dca8bcfaba73d.mp3", beeps: 7, fieldName: "aereo_od_8000", ear: "right", frequency: 8000 },
            { name: "6000R", url: "https://static.wixstatic.com/mp3/cb6469_059698e3043545dfbd85c444308b30c0.mp3", beeps: 7, fieldName: "aereo_od_6000", ear: "right", frequency: 6000 },
            { name: "4000R", url: "https://static.wixstatic.com/mp3/cb6469_02c9df26d50f4cad911940300bc1cff3.mp3", beeps: 7, fieldName: "aereo_od_4000", ear: "right", frequency: 4000 },
            { name: "3000R", url: "https://static.wixstatic.com/mp3/cb6469_7e193babac6d4c7cafdb251876cd3332.mp3", beeps: 7, fieldName: "aereo_od_3000", ear: "right", frequency: 3000 },
            { name: "2000R", url: "https://static.wixstatic.com/mp3/cb6469_00feac9a7fa3460e94d3aa410029608c.mp3", beeps: 7, fieldName: "aereo_od_2000", ear: "right", frequency: 2000 },
            { name: "1000R", url: "https://static.wixstatic.com/mp3/cb6469_99d679820a0048a5bb93ca99a1b28789.mp3", beeps: 7, fieldName: "aereo_od_1000", ear: "right", frequency: 1000 },
            { name: "500R", url: "https://static.wixstatic.com/mp3/cb6469_85251dd58337478d8ceb1d49b982960a.mp3", beeps: 7, fieldName: "aereo_od_500", ear: "right", frequency: 500 },
            { name: "250R", url: "https://static.wixstatic.com/mp3/cb6469_86f4976f68e44e44a51d872a3e113684.mp3", beeps: 7, fieldName: "aereo_od_250", ear: "right", frequency: 250 },
            // O√≠do Izquierdo (L = Left)
            { name: "8000L", url: "https://static.wixstatic.com/mp3/cb6469_40afdcc551664aa4bce9424dbd305368.mp3", beeps: 7, fieldName: "aereo_oi_8000", ear: "left", frequency: 8000 },
            { name: "6000L", url: "https://static.wixstatic.com/mp3/cb6469_e78c9a40b2d242718b5488e69a651ffd.mp3", beeps: 7, fieldName: "aereo_oi_6000", ear: "left", frequency: 6000 },
            { name: "4000L", url: "https://static.wixstatic.com/mp3/cb6469_fa12ef69d86c45b894e9afce6e310a71.mp3", beeps: 7, fieldName: "aereo_oi_4000", ear: "left", frequency: 4000 },
            { name: "3000L", url: "https://static.wixstatic.com/mp3/cb6469_13b2589524aa40f89986e9bcb25386e3.mp3", beeps: 7, fieldName: "aereo_oi_3000", ear: "left", frequency: 3000 },
            { name: "2000L", url: "https://static.wixstatic.com/mp3/cb6469_9993dcccb17b47279bf91d9c5fa07b7d.mp3", beeps: 7, fieldName: "aereo_oi_2000", ear: "left", frequency: 2000 },
            { name: "1000L", url: "https://static.wixstatic.com/mp3/cb6469_00326d7a14d04ebca8a6b03724d78452.mp3", beeps: 7, fieldName: "aereo_oi_1000", ear: "left", frequency: 1000 },
            { name: "500L", url: "https://static.wixstatic.com/mp3/cb6469_819e9b89b25d42fbb6b60f0133753adf.mp3", beeps: 7, fieldName: "aereo_oi_500", ear: "left", frequency: 500 },
            { name: "250L", url: "https://static.wixstatic.com/mp3/cb6469_c3469e08edea44ffa2b345a9cb60ac81.mp3", beeps: 7, fieldName: "aereo_oi_250", ear: "left", frequency: 250 },
        ];

        // ==========================================
        // ESTADO DE LA APLICACI√ìN
        // ==========================================
        let currentIndex = 0;
        let shuffledAudios = [];
        let userResponses = {};
        let patientData = null;
        let ordenId = null;

        // Elementos del DOM
        const welcomeScreen = document.getElementById('welcomeScreen');
        const testScreen = document.getElementById('testScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorCard = document.getElementById('errorCard');
        const audioPlayer = document.getElementById('audioPlayer');

        // Elementos del modal de video
        const videoModal = document.getElementById('videoModal');
        const modalVideo = document.getElementById('modalVideo');
        const playVideoBtn = document.getElementById('playVideoBtn');
        const skipVideoBtn = document.getElementById('skipVideoBtn');

        // ==========================================
        // MODAL DE VIDEO INTRODUCTORIO
        // ==========================================
        function closeVideoModal() {
            videoModal.classList.add('hidden');
            modalVideo.pause();
            document.body.style.overflow = '';
            setTimeout(() => {
                videoModal.style.display = 'none';
            }, 500);
        }

        // Configurar eventos del video modal
        if (playVideoBtn && modalVideo) {
            playVideoBtn.addEventListener('click', function() {
                modalVideo.play();
                playVideoBtn.classList.add('hidden');
            });

            modalVideo.addEventListener('pause', function() {
                if (!videoModal.classList.contains('hidden')) {
                    playVideoBtn.classList.remove('hidden');
                }
            });

            modalVideo.addEventListener('play', function() {
                playVideoBtn.classList.add('hidden');
            });

            modalVideo.addEventListener('ended', closeVideoModal);
        }

        if (skipVideoBtn) {
            skipVideoBtn.addEventListener('click', closeVideoModal);
        }

        // Prevenir scroll mientras el modal est√° visible
        if (videoModal && !videoModal.classList.contains('hidden')) {
            document.activeElement?.blur();
            document.body.style.overflow = 'hidden';
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Obtener ordenId de la URL
            const urlParams = new URLSearchParams(window.location.search);
            ordenId = urlParams.get('ordenId');

            if (!ordenId) {
                showError('No se proporcion√≥ un ID de orden v√°lido.');
                return;
            }

            // Cargar datos del paciente
            await loadPatientData();

            // Configurar eventos
            setupEventListeners();
        });

        async function loadPatientData() {
            try {
                const response = await fetch(`/api/historia-clinica/${ordenId}`);
                if (!response.ok) throw new Error('No se encontr√≥ la orden');

                const result = await response.json();

                if (!result.success || !result.data) {
                    throw new Error('Datos del paciente no disponibles');
                }

                patientData = result.data;

                // Actualizar UI
                const initials = ((patientData.primerNombre || '')[0] || '') + ((patientData.primerApellido || '')[0] || '');
                document.getElementById('patientAvatar').textContent = initials.toUpperCase();
                document.getElementById('patientName').textContent = `${patientData.primerNombre || ''} ${patientData.primerApellido || ''}`.trim() || 'Paciente';
                document.getElementById('patientId').textContent = `CC ${patientData.numeroId || '---'}`;

            } catch (error) {
                console.error('Error cargando paciente:', error);
                showError('No se pudo cargar la informaci√≥n del paciente. Verifique el enlace.');
            }
        }

        function setupEventListeners() {
            // Bot√≥n de inicio
            document.getElementById('startBtn').addEventListener('click', startTest);

            // Botones del teclado
            document.querySelectorAll('.keypad-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = parseInt(btn.dataset.value);
                    registerAnswer(value);
                });
            });

            // Eventos del reproductor de audio
            audioPlayer.addEventListener('play', () => {
                document.getElementById('audioStatus').textContent = 'Reproduciendo...';
                document.getElementById('audioStatus').className = 'audio-status playing';
                document.getElementById('audioAnimation').classList.remove('paused');
                disableKeypad(true);
            });

            audioPlayer.addEventListener('ended', () => {
                document.getElementById('audioStatus').textContent = '¬øCu√°ntos beeps escuch√≥?';
                document.getElementById('audioStatus').className = 'audio-status waiting';
                document.getElementById('audioAnimation').classList.add('paused');
                disableKeypad(false);
            });

            // Bot√≥n continuar
            document.getElementById('continueBtn').addEventListener('click', () => {
                // Redirigir a la siguiente prueba (visiometr√≠a virtual)
                if (ordenId) {
                    window.location.href = `/visiometria-virtual.html?ordenId=${ordenId}`;
                } else {
                    window.location.href = '/';
                }
            });
        }

        // ==========================================
        // L√ìGICA DE LA PRUEBA
        // ==========================================
        function startTest() {
            // Mezclar audios
            shuffledAudios = shuffleArray([...audios]);
            currentIndex = 0;
            userResponses = {};

            // Cambiar pantalla
            welcomeScreen.style.display = 'none';
            testScreen.style.display = 'flex';

            // Iniciar primer audio
            playNextAudio();
        }

        function playNextAudio() {
            if (currentIndex < shuffledAudios.length) {
                const audio = shuffledAudios[currentIndex];

                // Actualizar UI
                updateProgressBar();

                // Configurar y reproducir audio
                audioPlayer.src = audio.url;
                audioPlayer.volume = 1.0;

                // Peque√±a pausa antes de reproducir
                setTimeout(() => {
                    audioPlayer.play().catch(err => {
                        console.error('Error reproduciendo audio:', err);
                        document.getElementById('audioStatus').textContent = 'Toque para reproducir';
                        // Permitir reproducci√≥n manual
                        audioPlayer.addEventListener('click', () => audioPlayer.play(), { once: true });
                    });
                }, 500);
            } else {
                // Prueba completada
                saveAllResponses();
            }
        }

        function registerAnswer(beepsHeard) {
            const currentAudio = shuffledAudios[currentIndex];
            const decibels = mapAnswerToDecibels(beepsHeard);

            // Guardar respuesta
            userResponses[currentAudio.fieldName] = decibels;

            console.log(`${currentAudio.name}: ${beepsHeard} beeps = ${decibels} dB`);

            // Avanzar al siguiente
            currentIndex++;
            playNextAudio();
        }

        function mapAnswerToDecibels(beepsHeard) {
            switch (beepsHeard) {
                case 7: return 0;
                case 6: return 10;
                case 5: return 20;
                case 4: return 30;
                case 3: return 40;
                case 2: return 50;
                case 1: return 60;
                default: return 70; // 0 o m√°s de 7
            }
        }

        // ==========================================
        // GUARDAR RESULTADOS
        // ==========================================
        async function saveAllResponses() {
            loadingOverlay.style.display = 'flex';

            const dataToSave = {
                orden_id: ordenId,
                numero_id: patientData?.numeroId || '',
                primer_nombre: patientData?.primerNombre || '',
                primer_apellido: patientData?.primerApellido || '',
                empresa: patientData?.empresa || '',
                cod_empresa: patientData?.codEmpresa || '',
                // Datos de la audiometr√≠a virtual
                ...userResponses,
                // Marcar como audiometr√≠a virtual
                observaciones_audiometria: 'Audiometr√≠a virtual realizada por el paciente'
            };

            try {
                const response = await fetch('/api/audiometrias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSave)
                });

                if (!response.ok) throw new Error('Error guardando resultados');

                const result = await response.json();
                console.log('Resultados guardados:', result);

                // Mostrar pantalla de resultados
                showResults();

            } catch (error) {
                console.error('Error guardando:', error);
                showError('Error guardando los resultados. Por favor contacte soporte.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function showResults() {
            testScreen.style.display = 'none';
            resultsScreen.style.display = 'flex';

            document.getElementById('resultPatient').textContent =
                `${patientData?.primerNombre || ''} ${patientData?.primerApellido || ''}`.trim() || '---';
            document.getElementById('resultDoc').textContent = patientData?.numeroId || '---';
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function updateProgressBar() {
            const progress = ((currentIndex + 1) / shuffledAudios.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressCounter').textContent = `${currentIndex + 1} de ${shuffledAudios.length}`;
        }

        function disableKeypad(disabled) {
            document.querySelectorAll('.keypad-btn').forEach(btn => {
                btn.disabled = disabled;
            });
        }

        function showError(message) {
            errorCard.style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('startBtn').disabled = true;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
